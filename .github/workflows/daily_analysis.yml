name: Daily Limit-Up Stock Analysis

# æ¯æ—¥è‡ªåŠ¨è¿è¡Œæ¶¨åœè‚¡ç¥¨åˆ†æ
on:
  schedule:
    # æ¯ä¸ªäº¤æ˜“æ—¥ä¸‹åˆ 16:00 (UTC+8 = UTC+8:00, æ‰€ä»¥ UTC æ—¶é—´ä¸º 8:00)
    - cron: '0 8 * * 1-5'  # å‘¨ä¸€åˆ°å‘¨äº” UTC 8:00
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      analysis_date:
        description: 'åˆ†ææ—¥æœŸ (YYYYMMDDæ ¼å¼ï¼Œç•™ç©ºåˆ™åˆ†ææœ€è¿‘5å¤©)'
        required: false
        default: ''
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°å·²å­˜åœ¨çš„æ•°æ®'
        type: boolean
        default: false

# ç¯å¢ƒå˜é‡
env:
  PYTHON_VERSION: '3.9'
  TZ: 'Asia/Shanghai'

jobs:
  analyze-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Cache Python Dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install tushare pandas numpy supabase python-dotenv requests
        pip install -r requirements.txt || echo "No requirements.txt found, using inline dependencies"
        
    - name: Set up Environment Variables
      run: |
        echo "TUSHARE_TOKEN=${{ secrets.TUSHARE_TOKEN }}" >> $GITHUB_ENV
        echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> $GITHUB_ENV
        echo "SUPABASE_KEY=${{ secrets.SUPABASE_KEY }}" >> $GITHUB_ENV
        
    - name: Create Log Directory
      run: |
        mkdir -p log
        
    - name: Check Trading Day
      id: check_trading_day
      run: |
        python -c "
        from datetime import datetime, timedelta
        import requests
        
        # æ£€æŸ¥ä»Šå¤©æ˜¯å¦ä¸ºäº¤æ˜“æ—¥ï¼ˆç®€å•æ£€æŸ¥ï¼šæ’é™¤å‘¨æœ«ï¼‰
        today = datetime.now()
        weekday = today.weekday()  # 0=Monday, 6=Sunday
        
        if weekday >= 5:  # Saturday or Sunday
            print(f'::set-output name=is_trading_day::false')
            print('Weekend detected, skipping analysis')
        else:
            print(f'::set-output name=is_trading_day::true') 
            print('Weekday detected, proceeding with analysis')
        "
        
    - name: Run Stock Analysis
      if: steps.check_trading_day.outputs.is_trading_day == 'true' || github.event_name == 'workflow_dispatch'
      run: |
        echo "ğŸš€ å¼€å§‹è¿è¡Œæ¶¨åœè‚¡ç¥¨åˆ†æ..."
        echo "åˆ†ææ—¶é—´: $(date)"
        echo "æ—¶åŒº: $TZ"
        
        # è®¾ç½®åˆ†æå‚æ•°
        ANALYSIS_DATE="${{ github.event.inputs.analysis_date }}"
        FORCE_UPDATE="${{ github.event.inputs.force_update }}"
        
        if [ -z "$ANALYSIS_DATE" ]; then
            echo "ä½¿ç”¨æ‰¹é‡åˆ†ææ¨¡å¼ï¼ˆæœ€è¿‘5å¤©ï¼‰"
            python æ¶¨åœæ¿å—åˆ†æ_supabaseç‰ˆ.py
        else
            echo "ä½¿ç”¨æŒ‡å®šæ—¥æœŸåˆ†ææ¨¡å¼: $ANALYSIS_DATE"
            python -c "
        from æ¶¨åœæ¿å—åˆ†æ_supabaseç‰ˆ import SupabaseLimitUpAnalyzer
        import os
        
        analyzer = SupabaseLimitUpAnalyzer(
            os.getenv('TUSHARE_TOKEN'),
            os.getenv('SUPABASE_URL'), 
            os.getenv('SUPABASE_KEY')
        )
        
        success = analyzer.analyze_and_save('$ANALYSIS_DATE')
        print(f'âœ… åˆ†æå®Œæˆ: $ANALYSIS_DATE') if success else print(f'âŒ åˆ†æå¤±è´¥: $ANALYSIS_DATE')
        "
        fi
        
    - name: Verify Data Upload
      if: steps.check_trading_day.outputs.is_trading_day == 'true' || github.event_name == 'workflow_dispatch'
      run: |
        echo "ğŸ” éªŒè¯æ•°æ®ä¸Šä¼ æƒ…å†µ..."
        python -c "
        from æ¶¨åœæ¿å—åˆ†æ_supabaseç‰ˆ import SupabaseLimitUpAnalyzer
        import os
        from datetime import datetime
        
        try:
            analyzer = SupabaseLimitUpAnalyzer(
                os.getenv('TUSHARE_TOKEN'),
                os.getenv('SUPABASE_URL'), 
                os.getenv('SUPABASE_KEY')
            )
            
            # è·å–æœ€è¿‘çš„æ•°æ®
            recent_dates = analyzer.get_available_dates(5)
            print(f'ğŸ“Š æ•°æ®åº“ä¸­æœ€è¿‘çš„æ—¥æœŸ: {recent_dates}')
            
            if recent_dates:
                latest_date = recent_dates[0]
                data = analyzer.get_from_supabase(latest_date)
                if data:
                    print(f'âœ… æœ€æ–°æ•°æ®éªŒè¯æˆåŠŸ: {latest_date}, æ¶¨åœæ•°: {data.get(\"total_count\", 0)}')
                else:
                    print(f'âš ï¸ æœ€æ–°æ•°æ®è¯»å–å¤±è´¥: {latest_date}')
            else:
                print('âš ï¸ æ•°æ®åº“ä¸­æ— æ•°æ®')
                
        except Exception as e:
            print(f'âŒ éªŒè¯è¿‡ç¨‹å‡ºé”™: {e}')
        "
        
    - name: Upload Log Files
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: analysis-logs-${{ github.run_number }}
        path: log/
        retention-days: 30
        
    - name: Update Web Data (è§¦å‘Netlifyé‡æ–°éƒ¨ç½²)
      if: steps.check_trading_day.outputs.is_trading_day == 'true' || github.event_name == 'workflow_dispatch'
      run: |
        echo "ğŸŒ è§¦å‘ç½‘ç«™æ•°æ®æ›´æ–°..."
        
        # æ›´æ–° web ç›®å½•ä¸­çš„é…ç½®æ–‡ä»¶ä»¥è§¦å‘ Netlify é‡æ–°éƒ¨ç½²
        echo "/* æ•°æ®æ›´æ–°æ—¶é—´: $(date) */" > web/last_update.txt
        
        # å¦‚æœè®¾ç½®äº† Netlify æ„å»ºé’©å­ï¼Œå¯ä»¥è§¦å‘é‡æ–°éƒ¨ç½²
        if [ -n "${{ secrets.NETLIFY_BUILD_HOOK }}" ]; then
          curl -X POST -d {} "${{ secrets.NETLIFY_BUILD_HOOK }}"
          echo "âœ… Netlify é‡æ–°éƒ¨ç½²å·²è§¦å‘"
        fi
        
    - name: Commit and Push Updates
      if: steps.check_trading_day.outputs.is_trading_day == 'true' || github.event_name == 'workflow_dispatch'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if git diff --quiet && git diff --staged --quiet; then
          echo "ğŸ“ æ— æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
        else
          git add web/last_update.txt || echo "No update file to add"
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°æ•°æ® - $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          git push origin main || echo "Nothing to push"
          echo "âœ… å˜æ›´å·²æäº¤å¹¶æ¨é€"
        fi
        
    - name: Send Notification (å¯é€‰)
      if: always()
      run: |
        echo "ğŸ“¬ åˆ†æä»»åŠ¡å®Œæˆé€šçŸ¥"
        echo "çŠ¶æ€: ${{ job.status }}"
        echo "æ—¶é—´: $(date)"
        
        # è¿™é‡Œå¯ä»¥æ·»åŠ å‘é€é‚®ä»¶ã€å¾®ä¿¡æˆ–å…¶ä»–é€šçŸ¥çš„ä»£ç 
        # ä¾‹å¦‚ä½¿ç”¨ curl å‘é€åˆ° webhook
        
    - name: Cleanup
      if: always()
      run: |
        echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        # æ¸…ç†æ•æ„Ÿä¿¡æ¯
        unset TUSHARE_TOKEN
        unset SUPABASE_KEY
        
        # æ˜¾ç¤ºç£ç›˜ä½¿ç”¨æƒ…å†µ
        df -h
        
        echo "âœ… æ¶¨åœè‚¡ç¥¨åˆ†æä»»åŠ¡å®Œæˆ"