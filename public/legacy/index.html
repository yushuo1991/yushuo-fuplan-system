<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com https://wuqq-obsidian.oss-cn-shanghai.aliyuncs.com; img-src 'self' https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com https://wuqq-obsidian.oss-cn-shanghai.aliyuncs.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>宇硕复盘系统 | Yushuo Review System</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* 全局样式 */
        :root {
            --color-primary: #5046e4;
            --color-primary-hover: #4039ca;
            --color-primary-rgb: 80, 70, 228;
            --color-secondary: #f97316;
            --color-secondary-soft: rgba(249, 115, 22, 0.1);
            --color-gray-50: #f9fafb;
            --color-gray-100: #f3f4f6;
            --color-gray-200: #e5e7eb;
            --color-gray-300: #d1d5db;
            --color-gray-400: #9ca3af;
            --color-gray-500: #6b7280;
            --color-gray-600: #4b5563;
            --color-gray-700: #374151;
            --color-gray-800: #1f2937;
            --color-gray-900: #111827;
            --color-danger: #ef4444;
            --color-danger-soft: rgba(239, 68, 68, 0.1);
            --color-success: #10b981;
            --color-success-soft: rgba(16, 185, 129, 0.1);
            --color-warning: #f59e0b;
            --color-warning-soft: rgba(245, 158, 11, 0.1);
            --color-info: #3b82f6;
            --color-info-soft: rgba(59, 130, 246, 0.1);
            --color-background: #ffffff;
            --color-surface: #ffffff;
            --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            --card-border: 1px solid var(--color-gray-200);
            --sidebar-width: 270px;
            --header-height: 64px;
            --transition-default: all 0.3s ease;
            --font-family: 'Inter', 'Noto Sans SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --font-family-mono: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            
            /* 季节主题色定义 */
            --spring-primary: #f97316; /* 混沌期 - 橙色 */
            --spring-secondary: #f59e0b;
            --spring-bg: #fffbf7;
            --spring-card-bg: #fefaf6;
            
            --summer-primary: #ef4444; /* 主升期 - 红色 */
            --summer-secondary: #f43f5e;
            --summer-bg: #fff9f9;
            --summer-card-bg: #fff5f5;
            
            --autumn-primary: #3b82f6; /* 盘顶期 - 蓝色 */
            --autumn-secondary: #6366f1;
            --autumn-bg: #f5f8ff;
            --autumn-card-bg: #f0f5ff;
            
            --winter-primary: #10b981; /* 退潮期 - 绿色 */
            --winter-secondary: #14b8a6;
            --winter-bg: #f0fbf8;
            --winter-card-bg: #edfcf7;
        }

        /* 已删除深色模式变量 */

        /* 基础样式 */
        body {
            font-family: var(--font-family);
            background-color: var(--color-background);
            color: var(--color-gray-900);
            transition: var(--transition-default);
            overflow-x: hidden;
            position: relative;
        }
        
        /* 已删除深色模式body样式 */

        /* 侧边栏布局 */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            background-color: var(--color-surface);
            border-right: var(--card-border);
            position: fixed;
            height: 100vh;
            width: var(--sidebar-width);
            overflow-y: auto;
            transition: var(--transition-default);
            z-index: 30;
            flex-shrink: 0;
            padding: 0;
            box-shadow: 1px 0 5px rgba(0, 0, 0, 0.05);
        }

        /* 整体布局优化 */
        .main-content {
            margin-left: var(--sidebar-width);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: calc(100% - var(--sidebar-width));
            flex-grow: 1;
            min-height: 100vh;
        }

        #reviewForm {
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
        }

        .main-content > * {
            width: 100%;
            max-width: 1000px;
        }

        /* Logo和导航栏样式 */
        .app-logo {
            display: flex;
            align-items: center;
            padding: 1.25rem 0.75rem;
            margin-bottom: 0.75rem;
            border-bottom: var(--card-border);
        }

        .logo-icon {
            margin-right: 0.5rem;
            font-size: 1.25rem;
            color: var(--color-primary);
        }

        .logo-text {
            font-size: 1.15rem;
            font-weight: 600;
            color: var(--color-gray-900);
            white-space: nowrap;
        }

        .dark .logo-text {
            color: var(--color-gray-100);
        }

        /* 侧边栏内部元素优化 */
        .sidebar-nav {
            padding: 0.75rem;
        }

        .sidebar-item {
            padding: 0.8rem 1rem;
            margin: 0.3rem 0.6rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: var(--transition-default);
            display: flex;
            align-items: center;
            color: var(--color-gray-700);
            font-size: 1rem;
            font-weight: 500;
        }

        /* 泳道图行背景颜色定义 */
        :root {
            /* 泳道行背景颜色，淡雅协调 */
            --lane-bg-color-1: rgba(254, 241, 245, 0.8); /* 极淡粉红 */
            --lane-bg-color-2: rgba(239, 248, 255, 0.8); /* 极淡蓝 */
            --lane-bg-color-3: rgba(240, 253, 244, 0.8); /* 极淡绿 */
            --lane-bg-color-4: rgba(255, 251, 235, 0.8); /* 极淡橙 */
            --lane-bg-color-5: rgba(253, 244, 255, 0.8); /* 极淡紫 */
            --lane-bg-default: rgba(248, 250, 252, 0.5);  /* 默认背景 */
        }

        /* 泳道行样式 */
        .swim-lane {
            position: relative;
            transition: all 0.3s ease;
            border-radius: 8px;
            margin-bottom: 8px;
            padding: 0px 0;
            background-color: var(--lane-bg-default);
            border-left: 3px solid transparent;
        }

        .swim-lane.drag-over {
            border: 2px dashed var(--color-primary);
            background-color: rgba(59, 130, 246, 0.1);
        }

        /* 当有状态被选中时显示对应颜色 */
        .swim-lane.lane-bg-1.has-selected-state {
            background-color: var(--lane-bg-color-1);
            border-left: 3px solid rgba(255, 182, 193, 0.4);
        }

        .swim-lane.lane-bg-2.has-selected-state {
            background-color: var(--lane-bg-color-2);
            border-left: 3px solid rgba(173, 216, 230, 0.4);
        }

        .swim-lane.lane-bg-3.has-selected-state {
            background-color: var(--lane-bg-color-3);
            border-left: 3px solid rgba(144, 238, 144, 0.4);
        }

        .swim-lane.lane-bg-4.has-selected-state {
            background-color: var(--lane-bg-color-4);
            border-left: 3px solid rgba(255, 218, 185, 0.4);
        }

        .swim-lane.lane-bg-5.has-selected-state {
            background-color: var(--lane-bg-color-5);
            border-left: 3px solid rgba(221, 160, 221, 0.4);
        }

        /* 默认状态下的样式 - 优先级更高 */
        .swim-lane:not(.has-selected-state),
        .swim-lane.lane-bg-1:not(.has-selected-state),
        .swim-lane.lane-bg-2:not(.has-selected-state),
        .swim-lane.lane-bg-3:not(.has-selected-state),
        .swim-lane.lane-bg-4:not(.has-selected-state),
        .swim-lane.lane-bg-5:not(.has-selected-state) {
            background-color: var(--lane-bg-default) !important;
            border-left: 3px solid transparent !important;
        }

        /* 泳道悬停效果 */
        .swim-lane:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .sidebar-item:hover {
            background-color: var(--color-gray-100);
            color: var(--color-gray-900);
            transform: translateX(2px);
        }

        .sidebar-item.active {
            background-color: var(--color-primary);
            color: white;
            transform: translateX(0);
        }

        .sidebar-item i {
            margin-right: 0.5rem;
            width: 1.25rem;
            text-align: center;
        }

        .sidebar-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .sidebar-item.disabled:hover {
            background-color: transparent;
            transform: none;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .app-container {
                display: block;
            }

            .sidebar {
                transform: translateX(-100%);
                z-index: 50;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
                box-shadow: 3px 0 15px rgba(0, 0, 0, 0.2);
            }

            .main-content {
                padding: 1.25rem 1rem;
                margin-left: 0;
                width: 100%;
            }

            .mobile-menu-toggle {
                display: flex !important;
            }
        }

        .mobile-menu-toggle {
            display: none;
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            background-color: var(--color-primary);
            color: white;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 40;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: var(--transition-default);
        }

        .mobile-menu-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }

        /* 卡片样式 */
        .card {
            background-color: var(--color-surface);
            border-radius: 0.75rem;
            box-shadow: var(--card-shadow);
            border: var(--card-border);
            transition: var(--transition-default);
            margin-bottom: 2rem;
            padding: 2rem;
            width: 100%;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        .card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transform: translateY(-2px);
        }

        /* 黑暗模式开关 */
        .dark-mode-toggle {
            display: flex;
            align-items: center;
            padding: 0 1rem;
            margin-bottom: 0.75rem;
        }

        .dark-mode-label {
            margin-right: 0.5rem;
            font-size: 0.875rem;
            color: var(--color-gray-600);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--color-gray-300);
            transition: var(--transition-default);
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: var(--transition-default);
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--color-primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* 动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        /* 内容区域样式调整 */
        .content-section {
            display: none;
            flex-direction: column;
            align-items: center;
            animation: fadeIn 0.3s ease-out;
            width: 100%;
        }

        .content-section.active {
            display: flex;
        }

        .content-section > * {
            width: 100%;
        }

        .section-title {
            width: 100%;
            max-width: 900px;
            text-align: center;
            margin-bottom: 2rem;
            margin-left: auto;
            margin-right: auto;
        }

        /* 现代滚动条 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--color-gray-100);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--color-gray-400);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-gray-500);
        }

        .dark ::-webkit-scrollbar-track {
            background: var(--color-gray-300);
        }

        .dark ::-webkit-scrollbar-thumb {
            background: var(--color-gray-600);
        }

        .dark ::-webkit-scrollbar-thumb:hover {
            background: var(--color-gray-700);
        }

        /* 季节主题的背景效果 */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            opacity: 0.15;
            transition: all 0.8s ease-in-out;
            background-image: none;
            background-size: cover;
        }
        
        /* 混沌期 - 春季主题 */
        body.mood-theme-chaos {
            --color-primary: var(--spring-primary);
            --color-primary-hover: #ea580c;
            --color-primary-rgb: 249, 115, 22;
            --card-shadow: 0 4px 15px rgba(249, 115, 22, 0.2);
            --color-secondary: var(--spring-secondary);
            --color-gray-700: #853a03;
            --color-gray-800: #723102;
            --color-gray-900: #5c2700;
            background-color: var(--spring-bg);
            transition: all 0.8s ease;
        }
        
        body.mood-theme-chaos::before {
            opacity: 0.3;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1000 1000' opacity='0.2'%3E%3Cpath d='M935.7,500c0,15.9-12.9,28.9-28.9,28.9H666.5l-133.9,74.5c-4.9,2.7-10.4,4.1-15.9,4.1c-6.1,0-12.3-1.7-17.7-5.1c-10.4-6.6-16.8-18.1-16.8-30.6V500h-55.9l-133.9,74.5c-4.9,2.7-10.4,4.1-15.9,4.1c-6.1,0-12.3-1.7-17.7-5.1c-10.4-6.6-16.8-18.1-16.8-30.6V500H94.2c-15.9,0-28.9-12.9-28.9-28.9s12.9-28.9,28.9-28.9h147.9v-42.9c0-12.4,6.4-24,16.8-30.6c10.4-6.6,23.6-7.5,34.8-2.3l133.9,74.5h55.9v-42.9c0-12.4,6.4-24,16.8-30.6c10.4-6.6,23.6-7.5,34.8-2.3l133.9,74.5h240.3C922.8,471.1,935.7,484.1,935.7,500z' fill='%23f97316'/%3E%3C/svg%3E");
            animation: wind-animation 12s infinite linear;
            background-size: 200% 200%;
        }
        
        /* 主升期 - 夏季主题 */
        body.mood-theme-rising {
            --color-primary: var(--summer-primary);
            --color-primary-hover: #dc2626;
            --color-primary-rgb: 239, 68, 68;
            --card-shadow: 0 4px 15px rgba(239, 68, 68, 0.2);
            --color-secondary: var(--summer-secondary);
            --color-gray-700: #991b1b;
            --color-gray-800: #7f1d1d;
            --color-gray-900: #640d0d;
            background-color: var(--summer-bg);
            transition: all 0.8s ease;
        }
        
        body.mood-theme-rising::before {
            opacity: 0.25;
            background: radial-gradient(circle at 50% 50%, rgba(239, 68, 68, 0.15) 10%, transparent 60%), 
                       url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1000 1000' opacity='0.2'%3E%3Ccircle cx='500' cy='500' r='250' fill='%23ef4444'/%3E%3Cpath d='M500,120L500,50M500,950L500,880M120,500L50,500M950,500L880,500M210,210L160,160M790,790L840,840M210,790L160,840M790,210L840,160' stroke='%23ef4444' stroke-width='40' stroke-linecap='round'/%3E%3C/svg%3E");
            background-size: 100% 100%, 300px 300px;
            background-repeat: no-repeat, repeat;
            animation: sunny-animation 30s infinite linear;
        }
        
        /* 盘顶期 - 秋季主题 */
        body.mood-theme-top {
            --color-primary: var(--autumn-primary);
            --color-primary-hover: #2563eb;
            --color-primary-rgb: 59, 130, 246;
            --card-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
            --color-secondary: var(--autumn-secondary);
            --color-gray-700: #1e40af;
            --color-gray-800: #1e3a8a;
            --color-gray-900: #172554;
            background-color: var(--autumn-bg);
            transition: all 0.8s ease;
        }
        
        body.mood-theme-top::before {
            opacity: 0.3;
            background: radial-gradient(circle at 50% 50%, rgba(59, 130, 246, 0.08) 0%, transparent 70%), 
                       url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1000 1000' opacity='0.15'%3E%3Cpath d='M601.33,376.92H507.55L599.95,130.89c3.43-9.16-3.5-18.89-13.28-18.89H364.26c-6.4,0-12.07,4.25-13.96,10.47L234.19,623.74c-2.59,8.52,3.92,17.15,12.77,17.15h99.14l-78.22,228.99c-3.11,9.1,7.63,16.97,15.61,11.36l431.18-303.45c7.89-5.55,3.9-17.88-5.92-17.88H601.33z' fill='%233b82f6'/%3E%3C/svg%3E");
            background-size: 100% 100%, 200px 200px;
            background-repeat: no-repeat, repeat;
            animation: lightning-animation 8s infinite;
        }
        
        /* 退潮期 - 冬季主题 */
        body.mood-theme-ebb {
            --color-primary: var(--winter-primary);
            --color-primary-hover: #059669;
            --color-primary-rgb: 16, 185, 129;
            --card-shadow: 0 4px 15px rgba(16, 185, 129, 0.2);
            --color-secondary: var(--winter-secondary);
            --color-gray-700: #047857;
            --color-gray-800: #065f46;
            --color-gray-900: #064e3b;
            background-color: var(--winter-bg);
            transition: all 0.8s ease;
        }
        
        body.mood-theme-ebb::before {
            opacity: 0.35;
            background: linear-gradient(180deg, rgba(16, 185, 129, 0.05) 0%, transparent 100%), 
                       url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1000 1000' opacity='0.15'%3E%3Cpath d='M500,0v100M400,50v100M300,0v100M600,50v100M700,0v100M200,50v100M800,50v100M500,200v100M400,250v100M300,200v100M600,250v100M700,200v100M200,250v100M800,250v100M500,400v100M400,450v100M300,400v100M600,450v100M700,400v100M200,450v100M800,450v100M500,600v100M400,650v100M300,600v100M600,650v100M700,600v100M200,650v100M800,650v100M500,800v100M400,850v100M300,800v100M600,850v100M700,800v100M200,850v100M800,850v100' stroke='%2310b981' stroke-width='8' stroke-linecap='round'/%3E%3C/svg%3E");
            animation: rain-animation 10s infinite linear;
            background-size: 100% 100%, 400px 400px;
        }
        
        /* 背景动画 */
        @keyframes wind-animation {
            0% { background-position: 0 0; }
            50% { background-position: 500px -20px; }
            100% { background-position: 1000px 0; }
        }
        
        @keyframes sunny-animation {
            0% { background-position: center center, 0 0; }
            50% { background-position: center center, 150px 150px; }
            100% { background-position: center center, 300px 300px; }
        }
        
        @keyframes lightning-animation {
            0%, 20%, 80%, 100% { opacity: 0.1; }
            21%, 22% { opacity: 0.5; }
            50%, 52% { opacity: 0.4; }
            53%, 70% { opacity: 0.1; }
        }
        
        @keyframes rain-animation {
            0% { background-position: center top, 0 0; }
            100% { background-position: center top, 0 400px; }
        }

        /* 表单元素样式 */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .question-title {
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--color-gray-800);
            font-size: 1.05rem;
        }

        .dark .question-title {
            color: var(--color-gray-300);
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--color-gray-700);
        }

        .dark .form-label {
            color: var(--color-gray-400);
        }

        .form-control {
            display: block;
            width: 100%;
            padding: 0.625rem 0.75rem;
            font-size: 0.875rem;
            line-height: 1.5;
            color: var(--color-gray-900);
            background-color: var(--color-surface);
            background-clip: padding-box;
            border: 1px solid var(--color-gray-300);
            border-radius: 0.375rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .dark .form-control {
            color: var(--color-gray-100);
            background-color: var(--color-gray-200);
            border-color: var(--color-gray-400);
        }

        .form-control:focus {
            border-color: var(--color-primary);
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(var(--color-primary-rgb), 0.25);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* 按钮样式 */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            line-height: 1.5;
            text-align: center;
            white-space: nowrap;
            vertical-align: middle;
            cursor: pointer;
            user-select: none;
            border: 1px solid transparent;
            border-radius: 0.375rem;
            transition: var(--transition-default);
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--color-primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(var(--color-primary-rgb), 0.3);
        }

        .btn-outline {
            background-color: transparent;
            border-color: var(--color-gray-300);
            color: var(--color-gray-700);
        }

        .btn-outline:hover {
            background-color: var(--color-gray-100);
            transform: translateY(-2px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .dark .btn-outline {
            border-color: var(--color-gray-600);
            color: var(--color-gray-400);
        }

        .dark .btn-outline:hover {
            background-color: var(--color-gray-300);
            color: var(--color-gray-900);
        }

        /* 标题样式 */
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--color-gray-900);
            position: relative;
            padding-bottom: 0.5rem;
            padding-left: 0.25rem;
        }

        .dark .section-title {
            color: var(--color-gray-100);
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 3rem;
            height: 0.25rem;
            background-color: var(--color-primary);
            border-radius: 0.125rem;
            transition: background-color 0.3s ease;
        }

        /* 日期选择器 */
        .date-picker {
            padding: 0.625rem 0.75rem;
            border: 1px solid var(--color-gray-300);
            border-radius: 0.375rem;
            background-color: var(--color-surface);
            color: var(--color-gray-900);
            transition: var(--transition-default);
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .dark .date-picker {
            background-color: var(--color-gray-200);
            border-color: var(--color-gray-400);
            color: var(--color-gray-100);
        }

        .date-picker:focus {
            border-color: var(--color-primary);
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(var(--color-primary-rgb), 0.25);
        }

        /* 头部和工具栏 */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            width: 100%;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        .toolbar-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* 进度条 */
        .progress-container {
            width: 100%;
            height: 6px;
            background-color: var(--color-gray-200);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 2rem;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--color-primary);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* 导航按钮容器调整 */
        .navigation-buttons {
            display: flex;
            justify-content: flex-end;
            margin-top: 1.5rem;
            gap: 0.75rem;
            width: 100%;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        /* 复选框样式 */
        .checkboxes {
            margin-top: 0.5rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            cursor: pointer;
            user-select: none;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 0.5rem;
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid var(--color-gray-400);
            border-radius: 0.25rem;
            background-color: var(--color-surface);
            cursor: pointer;
            position: relative;
            vertical-align: middle;
            transition: var(--transition-default);
        }

        .checkbox-item input[type="checkbox"]:checked {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
        }

        .checkbox-item input[type="checkbox"]:checked::after {
            content: '';
            position: absolute;
            left: 6px;
            top: 2px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .checkbox-item span {
            font-size: 0.9rem;
        }

        .checkbox-tip {
            font-size: 0.8rem;
            color: var(--color-gray-600);
            margin-top: 0.5rem;
            font-style: italic;
        }

        .dark .checkbox-tip {
            color: var(--color-gray-400);
        }

        /* 市场指标和风格样式 */
        .market-indicators,
        .market-styles {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
        }

        .indicator-group,
        .style-group {
            flex: 1;
            min-width: 200px;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--color-gray-200);
            transition: var(--transition-default);
        }

        .indicator-group:hover,
        .style-group:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .indicator-header,
        .style-header {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
            color: white;
            padding: 0.75rem 1rem;
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
        }

        .indicator-header i,
        .style-header i {
            margin-right: 0.5rem;
        }

        .indicator-options,
        .style-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.75rem;
            background-color: var(--color-surface);
        }

        .option-item,
        .style-item {
            flex: 1;
            min-width: 60px;
            border: 1px solid var(--color-gray-200);
            border-radius: 0.5rem;
            padding: 0.5rem;
            cursor: pointer;
            transition: var(--transition-default);
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: var(--color-gray-50);
        }

        .option-item:hover,
        .style-item:hover {
            background-color: var(--color-gray-100);
            transform: translateY(-2px);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.08);
        }

        .option-item.selected,
        .style-item.selected {
            background-color: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
            box-shadow: 0 3px 8px rgba(var(--color-primary-rgb), 0.25);
        }

        .option-icon,
        .style-icon {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            height: 2rem;
            width: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: rgba(var(--color-primary-rgb), 0.1);
            color: var(--color-primary);
            transition: var(--transition-default);
        }

        .option-item.selected .option-icon,
        .style-item.selected .style-icon {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .option-text,
        .style-text {
            font-weight: 500;
            font-size: 0.85rem;
        }

        /* 情绪阶段选择样式 */
        .mood-selection {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1.5rem;
            margin: 1.5rem 0;
            width: 100%;
        }

        .mood-item {
            height: 120px;
            display: flex;
            align-items: center;
            border-radius: 0.75rem;
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid transparent;
            background-color: var(--color-gray-50);
        }

        .mood-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        .mood-icon {
            font-size: 2rem;
            margin-right: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mood-info {
            flex: 1;
        }

        .mood-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .mood-desc {
            font-size: 0.85rem;
            color: var(--color-gray-600);
        }

        /* 情绪阶段主题颜色 */
        .mood-chaos {
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.08) 0%, rgba(249, 115, 22, 0.16) 100%);
            border-color: rgba(249, 115, 22, 0.3);
        }

        .mood-chaos .mood-name {
            color: var(--spring-primary);
        }

        .mood-rising {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.08) 0%, rgba(239, 68, 68, 0.16) 100%);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .mood-rising .mood-name {
            color: var(--summer-primary);
        }

        .mood-top {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(59, 130, 246, 0.16) 100%);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .mood-top .mood-name {
            color: var(--autumn-primary);
        }

        .mood-ebb {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.08) 0%, rgba(16, 185, 129, 0.16) 100%);
            border-color: rgba(16, 185, 129, 0.3);
        }

        .mood-ebb .mood-name {
            color: var(--winter-primary);
        }

        /* 选中情绪阶段样式 */
        .mood-chaos.selected {
            background: linear-gradient(135deg, var(--spring-primary) 0%, var(--spring-secondary) 100%);
            box-shadow: 0 6px 15px rgba(249, 115, 22, 0.3);
        }

        .mood-rising.selected {
            background: linear-gradient(135deg, var(--summer-primary) 0%, var(--summer-secondary) 100%);
            box-shadow: 0 6px 15px rgba(239, 68, 68, 0.3);
        }

        .mood-top.selected {
            background: linear-gradient(135deg, var(--autumn-primary) 0%, var(--autumn-secondary) 100%);
            box-shadow: 0 6px 15px rgba(59, 130, 246, 0.3);
        }

        .mood-ebb.selected {
            background: linear-gradient(135deg, var(--winter-primary) 0%, var(--winter-secondary) 100%);
            box-shadow: 0 6px 15px rgba(16, 185, 129, 0.3);
        }

        .mood-item.selected .mood-name,
        .mood-item.selected .mood-desc {
            color: white;
        }

        /* 情绪阶段详情卡片 */
        .mood-details {
            margin-top: 1.5rem;
        }

        .mood-detail-card {
            display: none;
            padding: 1.25rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            animation: fadeIn 0.4s ease;
        }

        .mood-detail-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .mood-detail-content {
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .mood-detail-section {
            margin-top: 1rem;
        }

        .mood-detail-section h4 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .mood-detail-section ul {
            padding-left: 1.25rem;
        }

        .mood-detail-section li {
            margin-bottom: 0.5rem;
        }

        /* 情绪详情卡片的主题颜色 */
        .mood-chaos-detail {
            background: linear-gradient(to right, rgba(249, 115, 22, 0.05), rgba(249, 115, 22, 0.1));
            border-left: 3px solid var(--spring-primary);
        }

        .mood-rising-detail {
            background: linear-gradient(to right, rgba(239, 68, 68, 0.05), rgba(239, 68, 68, 0.1));
            border-left: 3px solid var(--summer-primary);
        }

        .mood-top-detail {
            background: linear-gradient(to right, rgba(59, 130, 246, 0.05), rgba(59, 130, 246, 0.1));
            border-left: 3px solid var(--autumn-primary);
        }

        .mood-ebb-detail {
            background: linear-gradient(to right, rgba(16, 185, 129, 0.05), rgba(16, 185, 129, 0.1));
            border-left: 3px solid var(--winter-primary);
        }

        /* 仓位显示 */
        .position-display {
            margin-top: 1rem;
            background-color: var(--color-gray-50);
            border-radius: 0.5rem;
            padding: 1rem;
            border: 1px solid var(--color-gray-200);
        }

        .position-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-primary);
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .position-bar {
            height: 0.5rem;
            background-color: var(--color-gray-200);
            border-radius: 0.25rem;
            overflow: hidden;
        }

        .position-fill {
            height: 100%;
            width: 0;
            background-color: var(--color-primary);
            border-radius: 0.25rem;
            transition: width 0.8s cubic-bezier(0.25, 1, 0.5, 1);
        }

        /* 主题 - 混沌期 */
        body.mood-theme-chaos .card {
            border-color: rgba(249, 115, 22, 0.15);
            box-shadow: 0 8px 20px rgba(249, 115, 22, 0.15);
            background-color: var(--spring-card-bg);
        }
        
        body.mood-theme-chaos .sidebar {
            background-color: var(--spring-card-bg);
            border-right-color: rgba(249, 115, 22, 0.2);
        }
        
        body.mood-theme-chaos .sidebar-item:hover:not(.active) {
            background-color: rgba(249, 115, 22, 0.1);
        }
        
        body.mood-theme-chaos .btn-primary {
            background: linear-gradient(135deg, var(--spring-primary), var(--spring-secondary));
            box-shadow: 0 4px 10px rgba(249, 115, 22, 0.3);
        }

        body.mood-theme-chaos .position-fill {
            background: linear-gradient(to right, var(--spring-primary), var(--spring-secondary));
        }

        body.mood-theme-chaos .indicator-header,
        body.mood-theme-chaos .style-header {
            background: linear-gradient(135deg, var(--spring-primary) 0%, var(--spring-secondary) 100%);
        }

        body.mood-theme-chaos .option-item.selected,
        body.mood-theme-chaos .style-item.selected {
            background-color: var(--spring-primary);
            border-color: var(--spring-primary);
        }

        /* 主题 - 主升期 */
        body.mood-theme-rising .card {
            border-color: rgba(239, 68, 68, 0.15);
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.15);
            background-color: var(--summer-card-bg);
        }
        
        body.mood-theme-rising .sidebar {
            background-color: var(--summer-card-bg);
            border-right-color: rgba(239, 68, 68, 0.2);
        }
        
        body.mood-theme-rising .sidebar-item:hover:not(.active) {
            background-color: rgba(239, 68, 68, 0.1);
        }
        
        body.mood-theme-rising .btn-primary {
            background: linear-gradient(135deg, var(--summer-primary), var(--summer-secondary));
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
        }

        body.mood-theme-rising .position-fill {
            background: linear-gradient(to right, var(--summer-primary), var(--summer-secondary));
        }

        body.mood-theme-rising .indicator-header,
        body.mood-theme-rising .style-header {
            background: linear-gradient(135deg, var(--summer-primary) 0%, var(--summer-secondary) 100%);
        }

        body.mood-theme-rising .option-item.selected,
        body.mood-theme-rising .style-item.selected {
            background-color: var(--summer-primary);
            border-color: var(--summer-primary);
        }

        /* 主题 - 盘顶期 */
        body.mood-theme-top .card {
            border-color: rgba(59, 130, 246, 0.15);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.15);
            background-color: var(--autumn-card-bg);
        }
        
        body.mood-theme-top .sidebar {
            background-color: var(--autumn-card-bg);
            border-right-color: rgba(59, 130, 246, 0.2);
        }
        
        body.mood-theme-top .sidebar-item:hover:not(.active) {
            background-color: rgba(59, 130, 246, 0.1);
        }
        
        body.mood-theme-top .btn-primary {
            background: linear-gradient(135deg, var(--autumn-primary), var(--autumn-secondary));
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
        }

        body.mood-theme-top .position-fill {
            background: linear-gradient(to right, var(--autumn-primary), var(--autumn-secondary));
        }

        body.mood-theme-top .indicator-header,
        body.mood-theme-top .style-header {
            background: linear-gradient(135deg, var(--autumn-primary) 0%, var(--autumn-secondary) 100%);
        }

        body.mood-theme-top .option-item.selected,
        body.mood-theme-top .style-item.selected {
            background-color: var(--autumn-primary);
            border-color: var(--autumn-primary);
        }

        /* 主题 - 退潮期 */
        body.mood-theme-ebb .card {
            border-color: rgba(16, 185, 129, 0.15);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.15);
            background-color: var(--winter-card-bg);
        }
        
        body.mood-theme-ebb .sidebar {
            background-color: var(--winter-card-bg);
            border-right-color: rgba(16, 185, 129, 0.2);
        }
        
        body.mood-theme-ebb .sidebar-item:hover:not(.active) {
            background-color: rgba(16, 185, 129, 0.1);
        }
        
        body.mood-theme-ebb .btn-primary {
            background: linear-gradient(135deg, var(--winter-primary), var(--winter-secondary));
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
        }

        body.mood-theme-ebb .position-fill {
            background: linear-gradient(to right, var(--winter-primary), var(--winter-secondary));
        }

        body.mood-theme-ebb .indicator-header,
        body.mood-theme-ebb .style-header {
            background: linear-gradient(135deg, var(--winter-primary) 0%, var(--winter-secondary) 100%);
        }

        body.mood-theme-ebb .option-item.selected,
        body.mood-theme-ebb .style-item.selected {
            background-color: var(--winter-primary);
            border-color: var(--winter-primary);
        }

        /* 响应式适配 */
        @media (max-width: 768px) {
            .mood-selection {
                grid-template-columns: 1fr;
            }
            
            .navigation-buttons {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .navigation-buttons .btn {
                width: 100%;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .toolbar-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .indicator-group,
            .style-group {
                min-width: 100%;
            }
        }
        
        /* 动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        /* 风险检查卡片样式 */
        .risk-check-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
            width: 100%;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        .risk-check-card {
            background-color: var(--color-surface);
            border-radius: 1rem;
            box-shadow: var(--card-shadow);
            border: var(--card-border);
            padding: 1.5rem;
            display: flex;
            align-items: flex-start;
            transition: all 0.3s ease;
        }

        .risk-check-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .risk-check-icon {
            background-color: rgba(var(--color-primary-rgb), 0.1);
            border-radius: 50%;
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .risk-check-icon i {
            font-size: 1.5rem;
            color: var(--color-primary);
        }

        .risk-check-content {
            flex: 1;
        }

        .risk-check-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: var(--color-gray-900);
        }

        .risk-check-desc {
            color: var(--color-gray-600);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .risk-check-action {
            margin-top: 0.5rem;
        }

        .risk-check-note {
            text-align: center;
            color: var(--color-gray-600);
            font-style: italic;
            margin: 1.5rem auto 2rem;
            max-width: 900px;
            width: 100%;
        }

        /* 调整情绪阶段卡片布局 */
        .mood-selection {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1.5rem;
            margin: 2rem auto;
            width: 100%;
            max-width: 900px;
        }

        /* 问题标题居中 */
        .question-title {
            text-align: center;
            font-size: 1.25rem;
            margin-bottom: 2rem;
            width: 100%;
        }

        .mood-item {
            height: 120px;
            display: flex;
            align-items: center;
            border-radius: 0.75rem;
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid transparent;
            background-color: var(--color-gray-50);
        }

        .mood-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        .mood-icon {
            font-size: 2rem;
            margin-right: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 主题适配 */
        body.mood-theme-chaos .risk-check-icon {
            background-color: rgba(249, 115, 22, 0.1);
        }

        body.mood-theme-chaos .risk-check-icon i {
            color: var(--spring-primary);
        }

        body.mood-theme-rising .risk-check-icon {
            background-color: rgba(239, 68, 68, 0.1);
        }

        body.mood-theme-rising .risk-check-icon i {
            color: var(--summer-primary);
        }

        body.mood-theme-top .risk-check-icon {
            background-color: rgba(59, 130, 246, 0.1);
        }

        body.mood-theme-top .risk-check-icon i {
            color: var(--autumn-primary);
        }

        body.mood-theme-ebb .risk-check-icon {
            background-color: rgba(16, 185, 129, 0.1);
        }

        body.mood-theme-ebb .risk-check-icon i {
            color: var(--winter-primary);
        }

        /* 板块节奏样式 */
        .sector-rotation-chart {
            margin-top: 1rem;
            border-radius: 0.5rem;
            overflow: hidden;
            background-color: var(--color-gray-50);
            border: 1px solid var(--color-gray-200);
        }

        /* 策略方法样式 */
        .strategy-content {
            margin-top: 1rem;
        }

        .strategy-phase-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .strategy-phase-content.active {
            display: block;
        }

        .strategy-category {
            margin-bottom: 1.5rem;
        }

        .strategy-category h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--color-primary);
            display: flex;
            align-items: center;
        }

        .strategy-category h3 i {
            margin-right: 0.5rem;
        }

        .strategy-category ul {
            padding-left: 1.5rem;
            margin-bottom: 0;
        }

        .strategy-category li {
            margin-bottom: 0.5rem;
            position: relative;
        }

        .strategy-category li:before {
            content: "";
            position: absolute;
            left: -1rem;
            top: 0.5rem;
            width: 0.4rem;
            height: 0.4rem;
            background-color: var(--color-primary);
            border-radius: 50%;
        }

        /* 核心梳理样式 */
        .core-item-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .core-item {
            background-color: var(--color-gray-50);
            border-radius: 0.75rem;
            border: 1px solid var(--color-gray-200);
            overflow: hidden;
            transition: var(--transition-default);
        }

        .core-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .core-item-header {
            padding: 0.75rem 1rem;
            background-color: var(--color-primary);
            color: white;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .core-item-header i {
            margin-right: 0.5rem;
        }

        .core-item .form-textarea {
            border-top-left-radius: 0;
            border-top-right-radius: 0;
            border: none;
            min-height: 120px;
        }

        /* 明日计划样式 */
        .plan-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .plan-item {
            background-color: var(--color-gray-50);
            border-radius: 0.75rem;
            border: 1px solid var(--color-gray-200);
            overflow: hidden;
            transition: var(--transition-default);
        }

        .plan-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .plan-item-header {
            padding: 0.75rem 1rem;
            background-color: var(--color-primary);
            color: white;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .plan-item-header i {
            margin-right: 0.5rem;
        }

        .plan-item .form-textarea {
            border-top-left-radius: 0;
            border-top-right-radius: 0;
            border: none;
            min-height: 120px;
        }

        /* 交易总结样式 */
        .trading-record-container {
            margin-top: 1rem;
            border-radius: 0.5rem;
            overflow: hidden;
            background-color: var(--color-gray-50);
            border: 1px solid var(--color-gray-200);
        }

        .trading-record-header {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr 1fr 0.5fr;
            background-color: var(--color-gray-200);
            padding: 0.5rem;
            font-weight: 600;
        }

        .trading-record-row {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr 1fr 0.5fr;
            padding: 0.5rem;
            border-bottom: 1px solid var(--color-gray-200);
        }

        .trading-record-row:last-child {
            border-bottom: none;
        }

        .record-col {
            padding: 0.25rem;
        }

        .record-col .form-control {
            height: 2.25rem;
            font-size: 0.875rem;
        }

        .remove-record {
            width: 2.25rem;
            height: 2.25rem;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-record-btn {
            margin-top: 1rem;
            width: 100%;
        }

        .emotion-control {
            display: flex;
            align-items: center;
            margin-top: 0.5rem;
        }

        .emotion-slider-container {
            flex: 1;
            display: flex;
            align-items: center;
        }

        .emotion-label {
            font-size: 0.875rem;
            color: var(--color-gray-700);
            margin: 0 0.5rem;
        }

        .emotion-slider {
            flex: 1;
            height: 0.5rem;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(to right, #4ade80, #eab308, #ef4444);
            border-radius: 0.25rem;
            outline: none;
        }

        .emotion-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            background: var(--color-primary);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .emotion-value {
            font-weight: 600;
            margin-left: 1rem;
            width: 2rem;
            text-align: center;
            color: var(--color-primary);
        }

        /* 新增弹出窗口样式 */
        .popup-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .popup-card {
            background-color: var(--color-surface);
            border-radius: 1rem;
            padding: 1.5rem;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            position: relative;
            animation: popup-fade-in 0.3s ease-out;
        }

        @keyframes popup-fade-in {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .popup-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--color-gray-600);
            transition: color 0.2s ease;
        }

        .popup-close:hover {
            color: var(--color-primary);
        }

        .popup-content {
            padding: 0.5rem;
        }

        .popup-content h3 {
            margin-bottom: 1rem;
            color: var(--color-primary);
            font-size: 1.25rem;
            font-weight: 600;
        }

        .popup-content p {
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .popup-content h4 {
            font-weight: 600;
            margin: 1rem 0 0.5rem 0;
        }

        .popup-content ul {
            padding-left: 1.5rem;
        }

        .popup-content li {
            margin-bottom: 0.5rem;
        }

        /* 标题可点击样式 */
        .mood-detail-title-popup {
            cursor: pointer;
            position: relative;
            transition: color 0.2s ease;
        }

        .mood-detail-title-popup:hover {
            color: var(--color-primary);
        }

        .mood-detail-title-popup::after {
            content: "🔍";
            margin-left: 0.5rem;
            font-size: 0.9rem;
            opacity: 0.7;
        }

        /* 板块卡片样式 */
        .sector-card {
            background-color: var(--color-gray-50);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid var(--color-gray-200);
        }

        .sector-card-title {
            font-weight: 600;
            color: var(--color-gray-800);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sector-card-content {
            font-size: 0.9rem;
        }

        .sector-info-row {
            display: flex;
            margin-bottom: 0.25rem;
        }

        .sector-info-label {
            width: 40%;
            color: var(--color-gray-600);
        }

        .sector-info-value {
            width: 60%;
            font-weight: 500;
        }

        .sector-stocks {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px dashed var(--color-gray-300);
        }

        /* 音效支持 */
        .audio-container {
            position: absolute;
            visibility: hidden;
            width: 0;
            height: 0;
        }
        
        /* 自定义模态框样式 */
        .custom-modal {
            display: none;
            position: fixed;
            z-index: 1200;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }
        
        .custom-modal-content {
            background-color: var(--color-surface);
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 450px;
            animation: modal-fade-in 0.3s ease-out;
            overflow: hidden;
            border: 1px solid var(--color-gray-200);
        }
        
        @keyframes modal-fade-in {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .custom-modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--color-gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--color-primary);
            color: white;
        }
        
        .custom-modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .custom-modal-close {
            font-size: 1.5rem;
            line-height: 1;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .custom-modal-close:hover {
            opacity: 0.8;
        }
        
        .custom-modal-body {
            padding: 1.5rem;
            font-size: 1rem;
            line-height: 1.5;
        }
        
        .custom-modal-footer {
            padding: 1rem 1.5rem;
            text-align: right;
            border-top: 1px solid var(--color-gray-200);
        }

        /* 板块节奏页面样式增强 */
        .sector-input-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .sector-input-item {
            margin-bottom: 0.5rem;
        }

        .sector-input-label {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
            color: var(--color-gray-700);
        }

        .sector-status-chart {
            width: 100%;
            height: 300px;
            margin-top: 1rem;
            background-color: var(--color-gray-50);
            border-radius: 0.5rem;
            border: 1px solid var(--color-gray-200);
            padding: 1rem;
        }

        /* 增加季节主题切换的过渡动画 */
        body {
            transition: background-color 0.8s ease, color 0.8s ease;
        }

        .sidebar, .card, .form-control, .btn {
            transition: background-color 0.8s ease, border-color 0.8s ease, box-shadow 0.8s ease;
        }

        /* 添加策略卡片样式 */
        .strategy-card {
            background-color: var(--color-gray-50);
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--color-gray-200);
            transition: var(--transition-default);
        }
        
        .strategy-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
        }
        
        .strategy-card-title {
            font-size: 1.15rem;
            font-weight: 600;
            color: var(--color-primary);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--color-gray-200);
        }
        
        .strategy-card-content {
            font-size: 0.95rem;
        }
        
        .strategy-section {
            margin-bottom: 1.25rem;
        }
        
        .strategy-section h4 {
            font-weight: 600;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
        }
        
        .strategy-section h4 i {
            margin-right: 0.5rem;
            color: var(--color-primary);
        }
        
        .strategy-section ul, .strategy-section ol {
            padding-left: 1.5rem;
            margin-bottom: 0;
        }
        
        .strategy-section li {
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }
        
        body.mood-theme-chaos .strategy-card-title {
            color: var(--spring-primary);
        }
        
        body.mood-theme-chaos .strategy-section h4 i {
            color: var(--spring-primary);
        }
        
        body.mood-theme-rising .strategy-card-title {
            color: var(--summer-primary);
        }
        
        body.mood-theme-rising .strategy-section h4 i {
            color: var(--summer-primary);
        }
        
        body.mood-theme-top .strategy-card-title {
            color: var(--autumn-primary);
        }
        
        body.mood-theme-top .strategy-section h4 i {
            color: var(--autumn-primary);
        }
        
        body.mood-theme-ebb .strategy-card-title {
            color: var(--winter-primary);
        }
        
        body.mood-theme-ebb .strategy-section h4 i {
            color: var(--winter-primary);
        }

        /* 修复内容区域卡片展示 */
        .card {
            max-width: 900px;
            margin: 0 auto 1.5rem;
        }

        /* 为情绪页面和市场多空页面添加特殊样式 */
        #section1 .card, #section2 .card {
            max-width: 900px;
            margin: 0 auto 1.5rem;
            padding: 2rem;
            background-color: #f8fafc;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        #section1 .card {
            background: linear-gradient(to bottom, #f8fafc, #f1f5f9);
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.02);
        }

        #section1 .checkbox-card {
            background-color: white;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        #section1 .checkbox-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }

        #section1 .checkbox-card input[type="checkbox"] {
            border-color: #94a3b8;
        }

        #section1 .checkbox-card input[type="checkbox"]:checked {
            background-color: #64748b;
            border-color: #64748b;
        }

        #section1 .checkbox-tip {
            color: #94a3b8;
            font-style: italic;
        }

        .mood-arrow {
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 隐藏箭头图标，只显示圆形背景 */
        .mood-arrow i {
            display: none;
        }

        .mood-arrow:hover {
            transform: scale(1.2) !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        }

        .strategy-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .strategy-popup-content {
            background-color: var(--color-surface);
            border-radius: 1rem;
            padding: 1.5rem;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            position: relative;
            animation: popup-fade-in 0.3s ease-out;
        }
        
        .strategy-popup-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--color-gray-600);
            transition: color 0.2s ease;
        }
        
        .strategy-popup-close:hover {
            color: var(--color-primary);
        }
        
        .popup-content-markdown h5 {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
        }
        
        .popup-content-markdown p {
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        
        .popup-content-markdown ol,
        .popup-content-markdown ul {
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .popup-content-markdown li {
            margin-bottom: 0.5rem;
        }
        
        .popup-trigger {
            cursor: pointer;
        }

        /* 策略卡片折叠功能相关样式 */
        .collapse-btn {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: var(--color-gray-100);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            color: var(--color-gray-600);
            cursor: pointer;
            z-index: 5;
            transition: all 0.2s ease;
        }

        .collapse-btn:hover {
            background-color: var(--color-gray-200);
        }

        .collapse-btn i {
            transition: transform 0.3s ease;
        }

        .collapse-btn.collapsed i {
            transform: rotate(180deg);
        }
        
        /* 已填写内容的按钮样式 */
        .collapse-btn.has-content {
            background-color: var(--color-primary);
            color: white;
        }

        /* 策略卡片内容区域美化 */
        .strategy-detail-content {
            text-align: left;
            margin-top: 15px;
            padding: 10px 0;
            border-radius: 0;
            background: transparent;
            box-shadow: none;
        }
        
        /* 表单项标签优化 */
        .strategy-detail-content p {
            margin-bottom: 16px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .strategy-detail-content p strong {
            font-weight: 600;
            color: var(--color-gray-700);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
        }
        
        .strategy-detail-content p strong i {
            color: var(--color-primary);
            font-size: 14px;
            width: 20px;
            text-align: center;
        }
        
        /* 问题步骤改为卡片式布局 */
        .question-step {
            background-color: #ffffff;
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            border: 1px solid rgba(0,0,0,0.03);
            transition: all 0.25s ease;
        }
        
        .question-step:hover {
            box-shadow: 0 3px 8px rgba(0,0,0,0.06);
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        /* 输入框样式优化 */
        .form-control.question-input {
            border: 1px solid var(--color-gray-200);
            border-radius: 8px;
            padding: 8px 12px;
            transition: all 0.2s ease;
            width: 100%;
            background-color: #ffffff;
        }
        
        .form-control.question-input:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(var(--color-primary-rgb), 0.15);
            outline: none;
        }
        
        /* 操作按钮样式优化 */
        .btn {
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        /* 完成状态样式优化 */
        .question-step:last-child {
            background-color: rgba(16, 185, 129, 0.05);
            border: 1px solid rgba(16, 185, 129, 0.1);
        }

        /* 完成状态与放弃状态样式优化 */
        .strategy-complete {
            margin-top: 15px; 
            background-color: rgba(16, 185, 129, 0.08); 
            padding: 15px; 
            border-radius: 10px; 
            text-align: center; 
            animation: fadeIn 0.5s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .strategy-complete i {
            color: #10b981; 
            font-size: 24px; 
            margin-bottom: 10px;
        }
        
        .strategy-complete p {
            color: #10b981 !important; 
            font-weight: 600 !important; 
            margin: 0 !important; 
            font-size: 15px !important;
        }
        
        .strategy-abandon {
            margin-top: 15px; 
            background-color: rgba(239, 68, 68, 0.08); 
            padding: 15px; 
            border-radius: 10px; 
            text-align: center; 
            animation: fadeIn 0.5s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .strategy-abandon i {
            color: #ef4444; 
            font-size: 24px; 
            margin-bottom: 10px;
        }
        
        .strategy-abandon p {
            color: #ef4444 !important; 
            font-weight: 600 !important; 
            margin: 0 !important; 
            font-size: 15px !important;
        }

        /* 市场实时数据展开内容样式 */
        .market-live-content {
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 8px;
        }

        .market-live-content::-webkit-scrollbar {
            width: 6px;
        }

        .market-live-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .market-live-content::-webkit-scrollbar-thumb {
            background: #5da39d;
            border-radius: 3px;
        }

        .market-live-content::-webkit-scrollbar-thumb:hover {
            background: #4a8a84;
        }

        .market-item {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
        }

        .market-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .market-item:nth-child(even) {
            background-color: #f8fafc !important;
        }

        .market-live-loading {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        #expandMarketBtn {
            transition: all 0.3s ease;
            min-width: 80px;
            font-weight: 500;
        }

        #expandMarketBtn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        /* 改进股票卡片样式 */
        .stock-item {
            transition: all 0.2s ease;
            cursor: default;
        }

        .stock-item:hover {
            background-color: #f0f9ff !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        /* 情绪阶段背景动效容器 */
        .mood-bg-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
            opacity: 0;
            transition: opacity 0.8s ease;
        }

        .mood-bg-effect.active {
            opacity: 1;
        }

        /* 混沌期 - 飘动粒子效果 */
        .chaos-particles {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .chaos-particle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: radial-gradient(circle, rgba(249, 115, 22, 0.7), rgba(245, 158, 11, 0.3));
            border-radius: 50%;
            animation: chaosFloat 5s infinite ease-in-out;
            box-shadow: 0 0 8px rgba(249, 115, 22, 0.4);
        }

        @keyframes chaosFloat {
            0%, 100% {
                transform: translate(0, 0) scale(1);
                opacity: 0.5;
            }
            25% {
                transform: translate(40px, -30px) scale(1.1);
                opacity: 0.7;
            }
            50% {
                transform: translate(-20px, 30px) scale(0.9);
                opacity: 0.4;
            }
            75% {
                transform: translate(-40px, -20px) scale(1.05);
                opacity: 0.6;
            }
        }

        /* 主升期 - 上升光芒效果 */
        .rising-rays {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .rising-ray {
            position: absolute;
            bottom: -100%;
            width: 3px;
            height: 200px;
            background: linear-gradient(to top, transparent, rgba(239, 68, 68, 0.6), transparent);
            animation: risingUp 3s infinite ease-out;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.8);
        }

        @keyframes risingUp {
            0% {
                bottom: -100%;
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% {
                bottom: 120%;
                opacity: 0;
            }
        }

        /* 盘顶期 - 简洁闪电效果 */
        .top-ripples {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        /* 闪电主干 */
        .lightning-bolt {
            position: absolute;
            width: 4px;
            height: 60%;
            top: 0;
            background: linear-gradient(to bottom,
                rgba(255, 255, 255, 0.9) 0%,
                rgba(147, 197, 253, 0.8) 30%,
                rgba(59, 130, 246, 0.6) 60%,
                transparent 100%
            );
            opacity: 0;
            animation: lightningFlash 4s infinite;
            box-shadow: 0 0 15px rgba(147, 197, 253, 0.8),
                        0 0 30px rgba(59, 130, 246, 0.5);
        }

        /* 闪电分支 */
        .lightning-branch {
            position: absolute;
            width: 3px;
            height: 30%;
            background: linear-gradient(135deg,
                rgba(147, 197, 253, 0.8) 0%,
                rgba(59, 130, 246, 0.5) 50%,
                transparent 100%
            );
            opacity: 0;
            animation: lightningFlash 4s infinite;
            box-shadow: 0 0 10px rgba(147, 197, 253, 0.6);
            transform-origin: top left;
        }

        /* 闪电闪烁动画 */
        @keyframes lightningFlash {
            0%, 100% {
                opacity: 0;
            }
            9.5% {
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            10.3% {
                opacity: 0;
            }
            14.8% {
                opacity: 0;
            }
            15% {
                opacity: 0.8;
            }
            15.4% {
                opacity: 0;
            }
            16.8% {
                opacity: 0;
            }
            17% {
                opacity: 0.6;
            }
            17.5% {
                opacity: 0;
            }
        }

        /* 闪电时的背景闪光 */
        .top-ripples::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at 50% 20%, rgba(255, 255, 255, 0.3) 0%, transparent 50%);
            opacity: 0;
            animation: backgroundFlash 4s infinite;
        }

        @keyframes backgroundFlash {
            0%, 100% {
                opacity: 0;
            }
            10%, 15%, 17% {
                opacity: 0.5;
            }
            10.3%, 15.4%, 17.5% {
                opacity: 0;
            }
        }

        /* 退潮期 - 下落雨滴效果 */
        .ebb-drops {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .ebb-drop {
            position: absolute;
            top: -50px;
            width: 2px;
            height: 50px;
            background: linear-gradient(to bottom, transparent, rgba(16, 185, 129, 0.6));
            animation: dropFall 2s infinite linear;
            box-shadow: 0 0 5px rgba(16, 185, 129, 0.5);
        }

        @keyframes dropFall {
            0% {
                top: -50px;
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            100% {
                top: 100%;
                opacity: 0.5;
            }
        }
    </style>
</head>
<body>
    <!-- 情绪阶段背景动效容器 -->
    <div id="moodBgEffect" class="mood-bg-effect">
        <!-- 混沌期粒子效果 -->
        <div id="chaosEffect" class="chaos-particles" style="display: none;"></div>
        <!-- 主升期光芒效果 -->
        <div id="risingEffect" class="rising-rays" style="display: none;"></div>
        <!-- 盘顶期波纹效果 -->
        <div id="topEffect" class="top-ripples" style="display: none;"></div>
        <!-- 退潮期雨滴效果 -->
        <div id="ebbEffect" class="ebb-drops" style="display: none;"></div>
    </div>

    <!--
    ========================================
    情绪阶段音效系统 - 使用说明
    ========================================

    ⚠️ 重要提示：当前音效文件未配置，动效可以正常显示，但没有声音。

    📥 快速添加音效（3个步骤）：

    步骤1️⃣ - 下载音效文件
    ----------------------------------------
    访问 Pixabay（推荐）: https://pixabay.com/sound-effects/

    搜索并下载以下关键词的音效：
    - 搜索 "wind" 或 "windstorm"    → 下载一个风声（用于混沌期）
    - 搜索 "fire crackling"          → 下载一个火焰声（用于主升期）
    - 搜索 "thunder" 或 "lightning"  → 下载一个雷声（用于盘顶期）
    - 搜索 "rain"                    → 下载一个雨声（用于退潮期）

    💡 推荐时长：3-5秒的短音效（系统会在3秒后自动淡出）

    步骤2️⃣ - 整理文件
    ----------------------------------------
    1. 在项目根目录创建文件夹：sounds
    2. 将下载的音效重命名并放入：

       项目目录/
       ├── sounds/
       │   ├── wind.mp3      ← 混沌期-风声
       │   ├── fire.mp3      ← 主升期-火焰声
       │   ├── thunder.mp3   ← 盘顶期-雷声
       │   └── rain.mp3      ← 退潮期-雨声
       └── index 增加板块星级.html

    步骤3️⃣ - 修改HTML代码
    ----------------------------------------
    在下方4个 <audio> 标签中：

    将：<source src="#" type="audio/mpeg">
    改为：<source src="./sounds/wind.mp3" type="audio/mpeg">

    （对4个音效都进行相应修改，见下方代码）

    🎵 完成后效果：
    - 混沌期 🌬️ → 飘动粒子 + 风声
    - 主升期 ☀️ → 上升光芒 + 火焰声
    - 盘顶期 ⚡ → 闪电效果 + 雷声
    - 退潮期 🌧️ → 下落雨滴 + 雨声

    💡 其他免费音效网站：
    - Mixkit: https://mixkit.co/free-sound-effects/
    - Freesound: https://freesound.org/（需注册）

    ========================================
    -->

    <!-- 情绪阶段音效（真实音频文件） -->

    <!-- 音效提示横幅（首次打开页面时显示） -->
    <div id="audioTip" style="position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 9999; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: none; max-width: 90%; text-align: center; font-size: 14px;">
        <div style="display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 20px;">🔊</span>
            <div style="flex: 1; text-align: left;">
                <div style="font-weight: 600; margin-bottom: 4px;">音效未配置</div>
                <div style="font-size: 12px; opacity: 0.9;">动效正常显示，但需要下载音效文件。<a href="https://pixabay.com/sound-effects/" target="_blank" style="color: #ffd700; text-decoration: underline; margin-left: 8px;">去下载音效 →</a> <span style="margin-left: 8px; opacity: 0.7;">或按F12查看控制台说明</span></div>
            </div>
            <button onclick="document.getElementById('audioTip').style.display='none'; localStorage.setItem('audioTipDismissed', 'true');" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">知道了</button>
        </div>
    </div>

    <!-- 混沌期：风声 -->
    <audio id="chaosSound" preload="auto">
        <!-- 已启用本地音效 - 使用实际文件名 -->
        <source src="./混沌期.mp3" type="audio/mpeg">
    </audio>

    <!-- 主升期：火焰声 -->
    <audio id="risingSound" preload="auto">
        <!-- 已启用本地音效 - 使用实际文件名 -->
        <source src="./主升期.mp3" type="audio/mpeg">
    </audio>

    <!-- 盘顶期：雷声/闪电声 -->
    <audio id="topSound" preload="auto">
        <!-- 已启用本地音效 - 使用实际文件名 -->
        <source src="./盘顶期.mp3" type="audio/mpeg">
    </audio>

    <!-- 退潮期：雨声 -->
    <audio id="ebbSound" preload="auto">
        <!-- 已启用本地音效 - 使用实际文件名 -->
        <source src="./退潮期.mp3" type="audio/mpeg">
    </audio>

    <div class="app-container">
        <!-- 侧边栏 -->
        <aside class="sidebar" id="sidebar">
            <div class="app-logo">
                <i class="fas fa-chart-line logo-icon"></i>
                <span class="logo-text">宇硕复盘系统</span>
            </div>
            
            <!-- 已移除深色模式开关 -->

            <div class="sidebar-nav">
                <div class="sidebar-item active" data-section="section1">
                    <i class="fas fa-chart-bar"></i>
                    <span>市场多空</span>
                </div>
                <div class="sidebar-item" data-section="section2">
                    <i class="fas fa-wind"></i>
                    <span>情绪阶段</span>
                </div>
                <div class="sidebar-item" data-section="section3">
                    <i class="fas fa-layer-group"></i>
                    <span>板块节奏</span>
                </div>
                <div class="sidebar-item" data-section="section4">
                    <i class="fas fa-chess-knight"></i>
                    <span>策略方法</span>
                </div>
                <div class="sidebar-item" data-section="section5">
                    <i class="fas fa-tasks"></i>
                    <span>自问清单</span>
                </div>
                <div class="sidebar-item" data-section="section6">
                    <i class="fas fa-calendar-day"></i>
                    <span>明日计划</span>
                </div>
                <div class="sidebar-item" data-section="section7">
                    <i class="fas fa-clipboard-check"></i>
                    <span>交易总结</span>
                </div>
            </div>
        </aside>

        <!-- 主要内容区 -->
        <main class="main-content">
            <div class="header">
                <div class="date-selection">
                    <input type="date" id="reviewDate" class="date-picker">
                </div>
                <div class="toolbar-actions">
                    <button class="btn btn-outline" id="saveBtn">
                        <i class="fas fa-save mr-2"></i> 保存草稿
                    </button>
                    <button class="btn btn-primary" id="generateReportBtn">
                        <i class="fas fa-file-export mr-2"></i> 生成报告
                    </button>
                </div>
            </div>

            <div class="progress-container">
                <div class="progress-bar" id="progressBar" style="width: 0%;"></div>
            </div>

            <form id="reviewForm">
                <!-- 第一部分：市场多空 -->
                <section class="content-section active" id="section1">
                    <h2 class="section-title">市场多空</h2>
                    
                    <div class="card">
                        <div class="form-group" style="width: 100%; max-width: 900px; margin: 0 auto;">
                            <label class="question-title" style="text-align: center; font-size: 1.25rem; margin-bottom: 2rem; display: block;">宏观大盘无风险</label>
                            <div class="mood-selection" style="margin: 2rem auto; width: 100%; max-width: 900px; display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1.5rem;">
                                <div class="checkbox-card" style="padding: 1.5rem; border: 1px solid var(--color-gray-200); border-radius: 0.5rem; display: flex; align-items: center; background-color: var(--color-surface); cursor: pointer; transition: var(--transition-default);">
                                    <input type="checkbox" name="macroRiskFree" value="true" id="macroRiskFree" style="margin-right: 1rem; width: 1.2rem; height: 1.2rem;">
                                    <label for="macroRiskFree" style="cursor: pointer; font-size: 1.1rem;">宏观确定无风险</label>
                                </div>
                                <div class="checkbox-card" style="padding: 1.5rem; border: 1px solid var(--color-gray-200); border-radius: 0.5rem; display: flex; align-items: center; background-color: var(--color-surface); cursor: pointer; transition: var(--transition-default);">
                                    <input type="checkbox" name="nonBreakingIndex" value="true" id="nonBreakingIndex" style="margin-right: 1rem; width: 1.2rem; height: 1.2rem;">
                                    <label for="nonBreakingIndex" style="cursor: pointer; font-size: 1.1rem;">指数非开始破位下跌</label>
                                </div>
                            </div>
                            <p class="checkbox-tip" style="text-align: center; margin-top: 1.5rem; color: var(--color-gray-600); font-size: 0.9rem;">注意：只有当两项均勾选后，其他导航标签才会解锁</p>
                        </div>
                        
                        <!-- 弹出卡片容器 -->
                        <div id="popupContainer" class="popup-container">
                            <div id="popupCard" class="popup-card">
                                <div class="popup-close">&times;</div>
                                <div id="popupContent" class="popup-content"></div>
                            </div>
                        </div>
                    </div>

                    <div class="navigation-buttons">
                        <button type="button" class="btn btn-primary next-section" data-next="section2" style="margin-left: auto;">
                            下一步 <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </section>

                <!-- 第二部分：情绪阶段 -->
                <section class="content-section" id="section2">
                    <h2 class="section-title">情绪阶段</h2>
                    
                    <div class="card">
                        <div class="form-group" style="width: 100%; max-width: 900px; margin: 0 auto;">
                            <div class="mood-selection" style="margin: 2rem auto; width: 100%; max-width: 900px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; position: relative;">
                                <div class="mood-item mood-chaos" data-mood="混沌期" data-theme="chaos" style="height: 140px; padding: 1.5rem; grid-column: 1; grid-row: 1;">
                                    <div class="mood-icon" style="font-size: 2.5rem; margin-right: 1.5rem;">🌬️</div>
                                    <div class="mood-info">
                                        <div class="mood-name" style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;">混沌期</div>
                                        <div class="mood-desc" style="font-size: 0.95rem;">资金进攻方向不一致</div>
                                    </div>
                                </div>
                                
                                <div class="mood-item mood-ebb" data-mood="退潮期" data-theme="ebb" style="height: 140px; padding: 1.5rem; grid-column: 2; grid-row: 1;">
                                    <div class="mood-icon" style="font-size: 2.5rem; margin-right: 1.5rem;">🌧️</div>
                                    <div class="mood-info">
                                        <div class="mood-name" style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;">退潮期</div>
                                        <div class="mood-desc" style="font-size: 0.95rem;">资金获利出清</div>
                                    </div>
                                </div>
                                
                                <div class="mood-item mood-rising" data-mood="主升期" data-theme="rising" style="height: 140px; padding: 1.5rem; grid-column: 1; grid-row: 2;">
                                    <div class="mood-icon" style="font-size: 2.5rem; margin-right: 1.5rem;">☀️</div>
                                    <div class="mood-info">
                                        <div class="mood-name" style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;">主升期</div>
                                        <div class="mood-desc" style="font-size: 0.95rem;">资金进攻集中</div>
                                    </div>
                                </div>
                                
                                <div class="mood-item mood-top" data-mood="盘顶期" data-theme="top" style="height: 140px; padding: 1.5rem; grid-column: 2; grid-row: 2;">
                                    <div class="mood-icon" style="font-size: 2.5rem; margin-right: 1.5rem;">⚡</div>
                                    <div class="mood-info">
                                        <div class="mood-name" style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;">盘顶期</div>
                                        <div class="mood-desc" style="font-size: 0.95rem;">资金犹豫风险积累</div>
                                    </div>
                                </div>
                                
                                <!-- 连接箭头 -->
                                <div class="mood-arrow chaos-to-rising popup-trigger" data-popup-id="chaos-to-rising-popup" style="position: absolute; left: 42%; top: 50%; transform: translate(-50%, -50%) rotate(90deg); color: var(--color-primary); font-size: 2rem; background-color: rgba(255,255,255,0.7); padding: 8px; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 10; cursor: pointer;">
                                    <i class="fas fa-arrow-down"></i>
                                </div>
                                <div class="mood-arrow rising-to-top popup-trigger" data-popup-id="rising-to-top-popup" style="position: absolute; left: 50%; top: 75%; transform: translateX(-50%); color: var(--color-primary); font-size: 2rem; background-color: rgba(255,255,255,0.7); padding: 8px; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 10; cursor: pointer;">
                                    <i class="fas fa-arrow-right"></i>
                                </div>
                                <div class="mood-arrow top-to-ebb popup-trigger" data-popup-id="top-to-ebb-popup" style="position: absolute; right: 42%; top: 50%; transform: translate(50%, -50%) rotate(-90deg); color: var(--color-primary); font-size: 2rem; background-color: rgba(255,255,255,0.7); padding: 8px; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 10; cursor: pointer;">
                                    <i class="fas fa-arrow-down"></i>
                                </div>
                                <div class="mood-arrow ebb-to-chaos popup-trigger" data-popup-id="ebb-to-chaos-popup" style="position: absolute; left: 50%; top: 25%; transform: translateX(-50%); color: var(--color-primary); font-size: 2rem; background-color: rgba(255,255,255,0.7); padding: 8px; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 10; cursor: pointer;">
                                    <i class="fas fa-arrow-left"></i>
                                </div>
                            </div>
                            
                            <!-- 箭头弹出卡片 -->
                            <div id="chaos-to-rising-popup" class="strategy-popup">
                                <div class="strategy-popup-content">
                                    <div class="strategy-popup-close">&times;</div>
                                    <div class="popup-content-markdown">
                                        <h5><strong><font color="#da4453">确认信号</font></strong></h5>
                                        <p>龙头弱转强，pk掉其他题材，带领板块走强，聚焦市场目光。游资和机构的多方资金共振，体现在连板龙头和中军齐涨，能引领的指数共振走强则最为优质。</p>
                                        <ol>
                                            <li>龙头放量突破市场高度压制</li>
                                            <li>低位个股缩量秒板</li>
                                            <li>同板块资金大票跟随启动</li>
                                            <li>带动板块效应</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="rising-to-top-popup" class="strategy-popup">
                                <div class="strategy-popup-content">
                                    <div class="strategy-popup-close">&times;</div>
                                    <div class="popup-content-markdown">
                                        <h5><strong><font color="#4a89dc">确认信号</font></strong></h5>
                                        <p>龙头高位分时震荡，开始盘顶滞涨</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="top-to-ebb-popup" class="strategy-popup">
                                <div class="strategy-popup-content">
                                    <div class="strategy-popup-close">&times;</div>
                                    <div class="popup-content-markdown">
                                        <h5><strong><font color="#00b050">确认信号</font></strong></h5>
                                        <p>主线龙头跌停或跌破10日线</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="ebb-to-chaos-popup" class="strategy-popup">
                                <div class="strategy-popup-content">
                                    <div class="strategy-popup-close">&times;</div>
                                    <div class="popup-content-markdown">
                                        <h5><strong><font color="#ec7500">确认信号</font></strong></h5>
                                        <ol>
                                            <li>旧核止跌，新核反核</li>
                                            <li>出现反核大长腿且次日不大面</li>
                                            <li>轮动题材无剧烈负反馈</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mood-details" style="display: none;">
                            <!-- 隐藏的详情卡片 -->
                        </div>

                        <!-- 弹出卡片容器 -->
                        <div id="popupContainer" class="popup-container">
                            <div id="popupCard" class="popup-card">
                                <div class="popup-close">&times;</div>
                                <div id="popupContent" class="popup-content"></div>
                            </div>
                        </div>
                        
                        <div class="form-group" id="positionGroup" style="display: none;">
                            <!-- 隐藏的仓位内容 -->
                        </div>
                    </div>

                    <div class="navigation-buttons">
                        <button type="button" class="btn btn-outline prev-section" data-prev="section1">
                            <i class="fas fa-arrow-left mr-2"></i> 上一步
                        </button>
                        <button type="button" class="btn btn-primary next-section" data-next="section3">
                            下一步 <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </section>

                <!-- 第三部分：板块节奏 -->
                <section class="content-section" id="section3">
                    <h2 class="section-title">板块节奏</h2>
                    
                    <div class="card">
                        <!-- 混沌期显示内容 -->
                        <div id="chaosContent" style="display: none;">
                            <div class="form-group">
                                <!-- 新增：量能放大和指数拐点多选框 -->
                                <div class="condition-checkboxes" style="margin-bottom: 2rem; padding: 1.5rem; background-color: var(--color-gray-50); border-radius: 0.75rem; border: 1px solid var(--color-gray-200);">
                                    <div style="display: flex; gap: 3rem; align-items: center;">
                                        <!-- 左侧：多选框 - 上下排列 -->
                                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                                            <div class="checkbox-item" style="display: flex; align-items: center; gap: 0.5rem;">
                                                <input type="checkbox" id="volumeAmplified" style="width: 1.2rem; height: 1.2rem;">
                                                <label for="volumeAmplified" style="font-size: 1.1rem; cursor: pointer;">量能放大</label>
                                            </div>
                                            <div class="checkbox-item" style="display: flex; align-items: center; gap: 0.5rem; position: relative;">
                                                <input type="checkbox" id="indexTurningPoint" style="width: 1.2rem; height: 1.2rem;">
                                                <label for="indexTurningPoint" class="hover-trigger" style="font-size: 1.1rem; cursor: pointer; color: var(--color-primary); text-decoration: underline;">指数拐点</label>
                                                <!-- 悬停卡片 -->
                                                <div class="hover-card" style="position: absolute; top: -60px; left: 50%; transform: translateX(-50%); background: white; border: 1px solid var(--color-gray-300); border-radius: 8px; padding: 12px 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s ease; white-space: nowrap;">
                                                    <div style="text-align: center; font-size: 1rem; font-weight: 600; color: #f97316;">大阴止跌，中阳启动</div>
                                                    <!-- 小三角箭头 -->
                                                    <div style="position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 6px solid white;"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- 右侧：图片显示区域 -->
                                        <div id="section3-image-container" style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 20px; min-height: 80px;">
                                            <img id="section3-main-image" src="" alt="板块节奏图片" style="display: none; max-width: 90%; height: 80px; object-fit: contain; border: none;">
                                            <div id="section3-baotuan-container" class="hidden">
                                                <span class="baotuan-text" onclick="showSection3BaotuanImage()">
                                                    抱团
                                                    <div class="tooltip">个股不跟随板块亏钱，且不受新发品种影响</div>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>



                                <label class="question-title">量能板指题材</label>
                                <div class="sector-input-container" style="display: flex; flex-direction: row; gap: 1rem; flex-wrap: nowrap;">
                                    <div class="sector-input-item" style="flex: 1;">
                                        <label class="sector-input-label">题材1</label>
                                        <input type="text" class="form-control" name="sectorOption1" placeholder="例如：新能源">
                                    </div>
                                    <div class="sector-input-item" style="flex: 1;">
                                        <label class="sector-input-label">题材2</label>
                                        <input type="text" class="form-control" name="sectorOption2" placeholder="例如：芯片">
                                    </div>
                                    <div class="sector-input-item" style="flex: 1;">
                                        <label class="sector-input-label">题材3</label>
                                        <input type="text" class="form-control" name="sectorOption3" placeholder="例如：医药">
                                    </div>
                                    <div class="sector-input-item" style="flex: 1;">
                                        <label class="sector-input-label">题材4</label>
                                        <input type="text" class="form-control" name="sectorOption4" placeholder="例如：人工智能">
                                    </div>
                                    <div class="sector-input-item" style="flex: 1;">
                                        <label class="sector-input-label">题材5</label>
                                        <input type="text" class="form-control" name="sectorOption5" placeholder="例如：军工">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 主升期显示内容 -->
                        <div id="risingContent" style="display: none;">
                            <div class="form-group">
                                <label class="question-title">主升题材</label>
                                <div class="sector-input-container">
                                    <div class="sector-input-item">
                                        <label class="sector-input-label">主升题材1</label>
                                        <input type="text" class="form-control" name="risingTheme1" placeholder="例如：芯片">
                                    </div>
                                    <div class="sector-input-item">
                                        <label class="sector-input-label">主升题材2</label>
                                        <input type="text" class="form-control" name="risingTheme2" placeholder="例如：新能源">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 其他情绪阶段的提示 -->
                        <div id="otherMoodContent" style="display: none; text-align: center; padding: 2rem;">
                            <p style="font-size: 1.1rem; color: var(--color-gray-600);">请先在情绪阶段页面选择"混沌期"或"主升期"</p>
                        </div>

                        <div class="form-group">
                            <!-- 泳道图工具栏 -->
                            <div style="margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                                <div>
                                    <button id="addSwimLaneBtn" class="btn btn-outline" style="font-size: 0.9rem; padding: 4px 8px;" type="button">
                                        <i class="fas fa-plus"></i> 添加板块
                                    </button>
                            </div>
                                <div>
                                    <input type="text" id="newLaneName" class="form-control" placeholder="板块名称 (回车添加)" style="width: 180px; display: inline-block; font-size: 0.9rem; padding: 4px 8px;">
                                </div>
                                <div style="margin-left: auto; display: flex; align-items: center;">
                                    <button id="expandTodayBtn" class="btn btn-outline" style="font-size: 0.9rem; padding: 4px 8px; margin-right: 10px;" type="button">
                                        <i class="fas fa-expand"></i> 展|折
                                    </button>
                                    <span style="margin-right: 10px; font-size: 0.9rem;">点击循环状态：</span>
                                    <span style="display: inline-block; margin: 0 5px;"><span style="display: inline-block; width: 12px; height: 12px; background-color: #d1d5db; border-radius: 50%; margin-right: 5px;"></span>未选择</span>
                                    <span style="display: inline-block; margin: 0 5px;"><span style="display: inline-block; width: 12px; height: 12px; background-color: #2c6e49; border-radius: 50%; margin-right: 5px;"></span>大分歧</span>
                                    <span style="display: inline-block; margin: 0 5px;"><span style="display: inline-block; width: 12px; height: 12px; background-color: #4c956c; border-radius: 50%; margin-right: 5px;"></span>中分歧</span>
                                    <span style="display: inline-block; margin: 0 5px;"><span style="display: inline-block; width: 12px; height: 12px; background-color: #9ec1a3; border-radius: 50%; margin-right: 5px;"></span>小分歧</span>
                                    <span style="display: inline-block; margin: 0 5px;"><span style="display: inline-block; width: 12px; height: 12px; background-color: #f9b5ac; border-radius: 50%; margin-right: 5px;"></span>一致</span>
                                    <span style="display: inline-block; margin: 0 5px;"><span style="display: inline-block; width: 12px; height: 12px; background-color: #e07a5f; border-radius: 50%; margin-right: 5px;"></span>高潮</span>
                                    <button id="historyViewBtn" class="btn btn-outline" style="font-size: 0.9rem; padding: 4px 8px; margin-left: 15px; background-color: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); color: #3b82f6;" type="button">
                                        <i class="fas fa-clipboard-list"></i> 汇总
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 泳道图容器 -->
                            <div id="swimLaneContainer" style="position: relative; width: 100%; overflow-x: auto; border: 1px solid var(--color-gray-200); border-radius: 8px; background-color: var(--color-gray-50); min-height: 350px; padding: 15px;">
                                <!-- 日期头部 -->
                                <div id="dateHeader" style="display: flex; margin-left: 120px; padding-bottom: 10px; border-bottom: 1px solid var(--color-gray-300);">
                                    <!-- 日期会动态生成 -->
                                    <div class="date-col" style="flex: 1; text-align: center; font-weight: 600; padding: 8px; min-width: 80px;" data-date="2023-05-20">5月20日</div>
                                    <div class="date-col" style="flex: 1; text-align: center; font-weight: 600; padding: 8px; min-width: 80px;" data-date="2023-05-21">5月21日</div>
                                    <div class="date-col" style="flex: 1; text-align: center; font-weight: 600; padding: 8px; min-width: 80px;" data-date="2023-05-22">5月22日</div>
                                    <div class="date-col" style="flex: 1; text-align: center; font-weight: 600; padding: 8px; min-width: 80px;" data-date="2023-05-23">5月23日</div>
                                    <div class="date-col" style="flex: 1; text-align: center; font-weight: 600; padding: 8px; min-width: 80px;" data-date="2023-05-24">5月24日</div>
                                </div>
                                

                                
                                <!-- 泳道内容 -->
                                <div id="swimLanesContent">
                                    <!-- 示例泳道，实际将由JS动态生成 -->
                                    <!-- 示例 1 -->
                                    <div class="swim-lane" data-lane-id="lane1">
                                                        <div class="lane-label" style="position: absolute; left: 0; width: 110px; padding: 10px 5px; text-align: right; font-weight: 500; display: flex; align-items: center; justify-content: flex-end;">
                            <span>芯片</span>
                            <button class="remove-lane-btn" style="margin-left: 5px; background-color: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; color: #ef4444; font-size: 10px; cursor: pointer; transition: all 0.2s ease;"><i class="fas fa-times"></i></button>
                        </div>
                                        <div class="lane-content" style="display: flex; margin-left: 120px;">
                                            <div class="lane-day" style="flex: 1; min-height: 50px; display: flex; align-items: center; justify-content: center; border-right: 1px dashed var(--color-gray-300); min-width: 80px;">
                                                <div class="state-dot" data-state="0" style="width: 20px; height: 20px; border-radius: 50%; background-color: #ef4444; cursor: pointer;"></div>
                                            </div>
                                            <div class="lane-day" style="flex: 1; min-height: 50px; display: flex; align-items: center; justify-content: center; border-right: 1px dashed var(--color-gray-300); min-width: 80px;">
                                                <div class="state-dot" data-state="0" style="width: 20px; height: 20px; border-radius: 50%; background-color: #ef4444; cursor: pointer;"></div>
                                            </div>
                                            <div class="lane-day" style="flex: 1; min-height: 50px; display: flex; align-items: center; justify-content: center; border-right: 1px dashed var(--color-gray-300); min-width: 80px;">
                                                <div class="state-dot" data-state="0" style="width: 20px; height: 20px; border-radius: 50%; background-color: #ef4444; cursor: pointer;"></div>
                                            </div>
                                            <div class="lane-day" style="flex: 1; min-height: 50px; display: flex; align-items: center; justify-content: center; border-right: 1px dashed var(--color-gray-300); min-width: 80px;">
                                                <div class="state-dot" data-state="0" style="width: 20px; height: 20px; border-radius: 50%; background-color: #ef4444; cursor: pointer;"></div>
                                            </div>
                                            <div class="lane-day" style="flex: 1; min-height: 50px; display: flex; align-items: center; justify-content: center; min-width: 80px;">
                                                <div class="state-dot" data-state="0" style="width: 20px; height: 20px; border-radius: 50%; background-color: #ef4444; cursor: pointer;"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 示例 2 -->
                                    <div class="swim-lane" data-lane-id="lane2">
                                                        <div class="lane-label" style="position: absolute; left: 0; width: 110px; padding: 10px 5px; text-align: right; font-weight: 500; display: flex; align-items: center; justify-content: flex-end;">
                            <span>新能源</span>
                            <button class="remove-lane-btn" style="margin-left: 5px; background-color: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; color: #ef4444; font-size: 10px; cursor: pointer; transition: all 0.2s ease;"><i class="fas fa-times"></i></button>
                        </div>
                                        <div class="lane-content" style="display: flex; margin-left: 120px;">
                                            <div class="lane-day" style="flex: 1; min-height: 50px; display: flex; align-items: center; justify-content: center; border-right: 1px dashed var(--color-gray-300); min-width: 80px;">
                                                <div class="state-dot" data-state="0" style="width: 20px; height: 20px; border-radius: 50%; background-color: #ef4444; cursor: pointer;"></div>
                                            </div>
                                            <div class="lane-day" style="flex: 1; min-height: 50px; display: flex; align-items: center; justify-content: center; border-right: 1px dashed var(--color-gray-300); min-width: 80px;">
                                                <div class="state-dot" data-state="0" style="width: 20px; height: 20px; border-radius: 50%; background-color: #ef4444; cursor: pointer;"></div>
                                            </div>
                                            <div class="lane-day" style="flex: 1; min-height: 50px; display: flex; align-items: center; justify-content: center; border-right: 1px dashed var(--color-gray-300); min-width: 80px;">
                                                <div class="state-dot" data-state="0" style="width: 20px; height: 20px; border-radius: 50%; background-color: #ef4444; cursor: pointer;"></div>
                                            </div>
                                            <div class="lane-day" style="flex: 1; min-height: 50px; display: flex; align-items: center; justify-content: center; border-right: 1px dashed var(--color-gray-300); min-width: 80px;">
                                                <div class="state-dot" data-state="0" style="width: 20px; height: 20px; border-radius: 50%; background-color: #ef4444; cursor: pointer;"></div>
                                            </div>
                                            <div class="lane-day" style="flex: 1; min-height: 50px; display: flex; align-items: center; justify-content: center; min-width: 80px;">
                                                <div class="state-dot" data-state="0" style="width: 20px; height: 20px; border-radius: 50%; background-color: #ef4444; cursor: pointer;"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 示例泳道连接线 -->
                                    <svg id="connectionLines" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;">
                                        <!-- 连接线将由JS动态生成 -->
                                    </svg>
                            </div>
                        </div>
                    </div>



                    <div class="navigation-buttons">
                        <button type="button" class="btn btn-outline prev-section" data-prev="section2">
                            <i class="fas fa-arrow-left mr-2"></i> 上一步
                        </button>
                        <button type="button" class="btn btn-primary next-section" data-next="section4">
                            下一步 <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                        </div>
                    </div>
                </section>

                <!-- 第四部分：策略方法 -->
                <section class="content-section" id="section4">
                    <h2 class="section-title">策略方法</h2>
                    
                    <div class="card">
                        <div class="form-group">
                            <label class="question-title">当前阶段适合的策略</label>
                            <div class="strategy-content">
                                <!-- 混沌期策略 -->
                                <div id="strategyContentChaos" class="strategy-phase-content">
                                    <div class="strategy-card">
                                        <h3 class="strategy-card-title popup-trigger" data-popup-id="chaos-popup">混沌期目标：寻找新龙</h3>
                                        <div class="strategy-card-content">
                                            <div class="strategy-section">
                                                <h4><i class="fas fa-trophy"></i> 参与纪律：</h4>
                                                <ul>
                                                    <li>🅰️只做前排，不做后排，回暖日只做核心辨识度的选强，不做当日后排个股的低吸，只做前2个主动性个股</li>
                                                    <li>🅰️有赚就跑，不随便格局。宁可卖错再买，不要格局不卖。左侧买+左侧卖</li>
                                                    <li>多空调控大，注意参与仓位</li>
                                                </ul>
                                            </div>
                                            <div class="strategy-section">
                                                <h4><i class="fas fa-check-circle"></i> 参与前提：</h4>
                                                <p>需满足<span class="popup-trigger" data-popup-id="sector-strength-popup" style="color: var(--color-primary); text-decoration: underline; cursor: pointer;">板块强度</span></p>
                                            </div>
                                            <div class="strategy-section">
                                                <h4><i class="fas fa-list-ol"></i> 参与策略：</h4>
                                                <div class="strategy-cards-container" style="display: flex; flex-wrap: wrap; gap: 1rem; padding: 1rem 0; justify-content: flex-start;">
                                                    <div class="strategy-option-card" style="flex: 1; min-width: 180px; max-width: 200px; background-color: var(--color-gray-50); border-radius: 0.75rem; border: 1px solid var(--color-gray-200); overflow: hidden; transition: var(--transition-default); box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative;">
                                                        <!-- 移除折叠按钮 -->
                                                        <div class="strategy-option-header" style="background-color: var(--color-primary); color: white; padding: 0.75rem; text-align: center; font-weight: 600;">
                                                            <span>策略一</span>
                                                        </div>
                                                        <div class="strategy-option-body" style="padding: 1rem; text-align: center;">
                                                            <p style="margin: 0;">启动板块最快换手板</p>
                                                            <div class="strategy-detail-content" style="text-align: left; margin-top: 15px; background-color: var(--color-gray-50); padding: 10px; border-radius: 8px; border-left: 3px solid var(--color-primary);">
                                                                <div class="question-step step-1 active">
                                                                    <p><strong><i class="fas fa-clipboard-list"></i> 板块启动名称</strong><input type="text" class="form-control question-input" data-next="2" placeholder="请输入板块名称"></p>
                                                        </div>
                                                                
                                                                <div class="question-step step-2" style="display:none;">
                                                                    <p><strong><i class="fas fa-calendar-day"></i> 板块运行天数</strong>
                                                                        <div style="display: flex; align-items: center; gap: 12px;">
                                                                            <input type="range" min="1" max="10" value="3" class="form-control question-input" data-next="3" style="flex: 1; height: 8px; accent-color: var(--color-primary);">
                                                                            <span style="font-size: 0.9rem; font-weight: 500; color: var(--color-primary); min-width: 20px; text-align: center; padding: 2px 8px; background-color: rgba(var(--color-primary-rgb), 0.08); border-radius: 4px;" class="days-value">3</span>
                                                                        </div>
                                                                    </p>
                                                                </div>
                                                                
                                                                <div class="question-step step-3" style="display:none;">
                                                                    <p><strong><i class="fas fa-chart-line"></i> 板块今日状态</strong>
                                                                        <select class="form-control question-input" data-next="4">
                                                                            <option value="">请选择状态...</option>
                                                                            <option value="强分歧">强分歧</option>
                                                                            <option value="弱分歧">弱分歧</option>
                                                                            <option value="弱一致">弱一致</option>
                                                                            <option value="强一致">强一致</option>
                                                                        </select>
                                                                    </p>
                                                                </div>
                                                                
                                                                <div class="question-step step-4" style="display:none;">
                                                                    <p><strong><i class="fas fa-lightbulb"></i> 板块明日预期</strong>
                                                                        <select class="form-control question-input" data-next="5">
                                                                            <option value="">请选择预期...</option>
                                                                            <option value="强分歧">强分歧</option>
                                                                            <option value="弱分歧">弱分歧</option>
                                                                            <option value="弱一致">弱一致</option>
                                                                            <option value="强一致">强一致</option>
                                                                        </select>
                                                                    </p>
                                                                </div>
                                                                
                                                                <div class="question-step step-5" style="display:none;">
                                                                    <div style="margin-top: 15px;">
                                                                        <p><strong><i class="fas fa-trophy"></i> 身位板</strong><input type="text" class="form-control question-input" data-next="6" placeholder="请输入身位板"></p>
                                                                    </div>
                                                                </div>
                                                                
                                                                <div class="question-step step-6" style="display:none;">
                                                                    <p><strong><i class="fas fa-bolt"></i> 涨停最快</strong><input type="text" class="form-control question-input" data-next="7" placeholder="请输入涨停最快的股票"></p>
                                                                </div>
                                                                
                                                                <div class="question-step step-7" style="display:none;">
                                                                    <p><strong><i class="fas fa-chart-bar"></i> 量能最大</strong><input type="text" class="form-control question-input" data-next="8" placeholder="请输入量能最大的股票"></p>
                                                                </div>
                                                                
                                                                <div class="question-step step-8" style="display:none;">
                                                                    <p><strong><i class="fas fa-chart-line"></i> K线形态好</strong><input type="text" class="form-control question-input" data-next="9" placeholder="请输入K线形态好的股票"></p>
                                                                </div>
                                                                
                                                                <div class="question-step step-9" style="display:none;">
                                                                    <p><strong><i class="fas fa-fire"></i> 人气榜前排</strong><input type="text" class="form-control question-input" data-next="10" placeholder="请输入人气榜前排的股票"></p>
                                                                </div>

                                                                <div class="question-step step-10" style="display:none;">
                                                                    <div style="margin-top: 15px;">
                                                                        <p><strong><i class="fas fa-check-circle"></i> 是否在量能板块</strong></p>
                                                                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                                                            <button type="button" class="btn btn-outline strength-choice" data-value="no" data-next="abandon">
                                                                                <i class="fas fa-times mr-1"></i> 否
                                                                            </button>
                                                                            <button type="button" class="btn btn-primary strength-choice" data-value="yes" data-next="11">
                                                                                <i class="fas fa-check mr-1"></i> 是
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                
                                                                <div class="question-step step-abandon" style="display:none;">
                                                                    <div class="strategy-abandon">
                                                                        <i class="fas fa-times-circle"></i>
                                                                        <p>放弃此策略</p>
                                                                    </div>
                                                                </div>

                                                                <div class="question-step step-11" style="display:none;">
                                                                    <div style="margin-top: 15px;">
                                                                        <p><strong><i class="fas fa-bullseye"></i> 备选标的</strong></p>
                                                                        <textarea class="form-control question-input" data-next="12" style="height: 100px;" placeholder="请输入备选标的，可多选"></textarea>
                                                                    </div>
                                                                </div>
                                                                
                                                                <div class="question-step step-12" style="display:none;">
                                                                    <div class="strategy-complete">
                                                                        <i class="fas fa-check-circle"></i>
                                                                        <p>策略设置完成</p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="strategy-option-card" style="flex: 1; min-width: 180px; max-width: 200px; background-color: var(--color-gray-50); border-radius: 0.75rem; border: 1px solid var(--color-gray-200); overflow: hidden; transition: var(--transition-default); box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative;">
                                                        <!-- 移除折叠按钮 -->
                                                        <div class="strategy-option-header" style="background-color: var(--color-primary); color: white; padding: 0.75rem; text-align: center; font-weight: 600;">
                                                            <span>策略二</span>
                                                        </div>
                                                        <div class="strategy-option-body" style="padding: 1rem; text-align: center;">
                                                            <p style="margin: 0 0 10px 0;">独立题材1进2</p>
                                                            <div class="strategy-detail-content" style="text-align: left; margin-top: 15px; background-color: var(--color-gray-50); padding: 10px; border-radius: 8px; border-left: 3px solid var(--color-primary);">
                                                                <div class="question-step step2-1 active">
                                                                    <p><strong><i class="fas fa-search"></i> 选择量能板块中的独立个股</strong><input type="text" class="form-control question-input" data-next="2" data-parent="step2" placeholder="请输入独立个股"></p>
                                                        </div>
                                                                
                                                                <div class="question-step step2-2" style="display:none;">
                                                                    <p><strong><i class="fas fa-flask"></i> 有无发酵可能</strong>
                                                                        <select class="form-control question-input" data-next="3" data-parent="step2">
                                                                            <option value="">请选择发酵可能性...</option>
                                                                            <option value="高">高</option>
                                                                            <option value="中">中</option>
                                                                            <option value="低">低</option>
                                                                        </select>
                                                                    </p>
                                                    </div>
                                                                
                                                                <div class="question-step step2-3" style="display:none;">
                                                                    <p><strong><i class="fas fa-calendar-check"></i> 明日参与</strong>
                                                                        <select class="form-control question-input" data-next="4" data-parent="step2">
                                                                            <option value="">请选择是否参与...</option>
                                                                            <option value="是">是</option>
                                                                            <option value="否">否</option>
                                                                        </select>
                                                                    </p>
                                                                </div>
                                                                
                                                                <div class="question-step step2-4" style="display:none;">
                                                                    <div class="strategy-complete">
                                                                        <i class="fas fa-check-circle"></i>
                                                                        <p>策略设置完成</p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="strategy-option-card" style="flex: 1; min-width: 180px; max-width: 200px; background-color: var(--color-gray-50); border-radius: 0.75rem; border: 1px solid var(--color-gray-200); overflow: hidden; transition: var(--transition-default); box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative;">
                                                        <button class="collapse-btn" style="position: absolute; top: 5px; left: 5px; width: 24px; height: 24px; border-radius: 50%; background-color: var(--color-gray-100); border: none; display: flex; align-items: center; justify-content: center; font-size: 12px; color: var(--color-gray-600); cursor: pointer; z-index: 5;">
                                                            <i class="fas fa-compress-alt"></i>
                                                        </button>
                                                        <div class="strategy-option-header" style="background-color: var(--color-primary); color: white; padding: 0.75rem; text-align: center; font-weight: 600;">
                                                            <span>策略三</span>
                                                        </div>
                                                        <div class="strategy-option-body" style="padding: 1rem; text-align: center;">
                                                            <p style="margin: 0;"><a href="https://xuangutong.com.cn/live" target="_blank" style="color: inherit; text-decoration: none;">新消息逻辑发酵</a></p>
                                                            <div class="strategy-detail-content" style="text-align: left; margin-top: 15px; background-color: var(--color-gray-50); padding: 10px; border-radius: 8px; border-left: 3px solid var(--color-primary);">
                                                                <div class="question-step step3-1 active">
                                                                    <p><strong><i class="fas fa-newspaper"></i> 有何重磅消息</strong><input type="text" class="form-control question-input" data-next="2" data-parent="step3" placeholder="请输入重磅消息"></p>
                                                        </div>
                                                                
                                                                <div class="question-step step3-2" style="display:none;">
                                                                    <p><strong><i class="fas fa-brain"></i> 作何解读</strong><textarea class="form-control question-input" data-next="3" data-parent="step3" style="height: 100px;" placeholder="请输入对消息的解读"></textarea></p>
                                                    </div>
                                                                
                                                                <div class="question-step step3-3" style="display:none;">
                                                                    <p><strong><i class="fas fa-list-ul"></i> 备选个股</strong><textarea class="form-control question-input" data-next="4" data-parent="step3" style="height: 100px;" placeholder="请输入备选个股，可多选"></textarea></p>
                                                                </div>
                                                                
                                                                <div class="question-step step3-4" style="display:none;">
                                                                    <div class="strategy-complete">
                                                                        <i class="fas fa-check-circle"></i>
                                                                        <p>策略设置完成</p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="strategy-option-card" style="flex: 1; min-width: 180px; max-width: 200px; background-color: var(--color-gray-50); border-radius: 0.75rem; border: 1px solid var(--color-gray-200); overflow: hidden; transition: var(--transition-default); box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative;">
                                                        <button class="collapse-btn" style="position: absolute; top: 5px; left: 5px; width: 24px; height: 24px; border-radius: 50%; background-color: var(--color-gray-100); border: none; display: flex; align-items: center; justify-content: center; font-size: 12px; color: var(--color-gray-600); cursor: pointer; z-index: 5;">
                                                            <i class="fas fa-compress-alt"></i>
                                                        </button>
                                                        <div class="strategy-option-header" style="background-color: var(--color-primary); color: white; padding: 0.75rem; text-align: center; font-weight: 600;">
                                                            <span>策略四</span>
                                                        </div>
                                                        <div class="strategy-option-body" style="padding: 1rem; text-align: center;">
                                                            <p style="margin: 0;">人气榜前排</p>
                                                            <div class="strategy-detail-content" style="text-align: left; margin-top: 15px; background-color: var(--color-gray-50); padding: 10px; border-radius: 8px; border-left: 3px solid var(--color-primary);">
                                                                <div class="question-step step4-1 active">
                                                                    <p><strong><i class="fas fa-fire"></i> 人气榜前排标的</strong><input type="text" class="form-control question-input" data-next="2" data-parent="step4" placeholder="请输入人气榜前排标的"></p>
                                                        </div>
                                                                
                                                                <div class="question-step step4-2" style="display:none;">
                                                                    <p><strong><i class="fas fa-check-circle"></i> 是否在量能板块里</strong></p>
                                                                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                                                        <button type="button" class="btn btn-outline strength-choice" data-value="no" data-next="abandon" data-parent="step4">
                                                                            <i class="fas fa-times mr-1"></i> 否
                                                                        </button>
                                                                        <button type="button" class="btn btn-primary strength-choice" data-value="yes" data-next="3" data-parent="step4">
                                                                            <i class="fas fa-check mr-1"></i> 是
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                                
                                                                <div class="question-step step4-3" style="display:none;">
                                                                    <div class="strategy-complete">
                                                                        <i class="fas fa-check-circle"></i>
                                                                        <p>策略设置完成</p>
                                                                    </div>
                                                                </div>
                                                                
                                                                <div class="question-step step4-abandon" style="display:none;">
                                                                    <div class="strategy-abandon">
                                                                        <i class="fas fa-times-circle"></i>
                                                                        <p>放弃此策略</p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="strategy-option-card" style="flex: 1; min-width: 180px; max-width: 200px; background-color: var(--color-gray-50); border-radius: 0.75rem; border: 1px solid var(--color-gray-200); overflow: hidden; transition: var(--transition-default); box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative;">
                                                        <button class="collapse-btn" style="position: absolute; top: 5px; left: 5px; width: 24px; height: 24px; border-radius: 50%; background-color: var(--color-gray-100); border: none; display: flex; align-items: center; justify-content: center; font-size: 12px; color: var(--color-gray-600); cursor: pointer; z-index: 5;">
                                                            <i class="fas fa-compress-alt"></i>
                                                        </button>
                                                        <div class="strategy-option-header" style="background-color: var(--color-primary); color: white; padding: 0.75rem; text-align: center; font-weight: 600;">
                                                            <span>策略五</span>
                                                        </div>
                                                        <div class="strategy-option-body" style="padding: 1rem; text-align: center;">
                                                            <p style="margin: 0;">板块龙头弱转强</p>
                                                            <div class="strategy-detail-content" style="text-align: left; margin-top: 15px; background-color: var(--color-gray-50); padding: 10px; border-radius: 8px; border-left: 3px solid var(--color-primary);">
                                                                <div class="question-step step5-1 active">
                                                                    <p><strong>1、轮动的板块龙头1：</strong><input type="text" class="form-control question-input" data-next="2" data-parent="step5" style="margin-bottom: 10px; font-size: 0.8rem; padding: 5px;"></p>
                                                        </div>
                                                                
                                                                <div class="question-step step5-2" style="display:none;">
                                                                    <p><strong>2、相应的板块节奏：</strong><input type="text" class="form-control question-input" data-next="3" data-parent="step5" style="margin-bottom: 10px; font-size: 0.8rem; padding: 5px;"></p>
                                                    </div>
                                                                
                                                                <div class="question-step step5-3" style="display:none;">
                                                                    <p><strong>3、轮动的板块龙头2：</strong><input type="text" class="form-control question-input" data-next="4" data-parent="step5" style="margin-bottom: 10px; font-size: 0.8rem; padding: 5px;"></p>
                                                </div>
                                                                
                                                                <div class="question-step step5-4" style="display:none;">
                                                                    <p><strong>4、相应的板块节奏：</strong><input type="text" class="form-control question-input" data-next="5" data-parent="step5" style="margin-bottom: 10px; font-size: 0.8rem; padding: 5px;"></p>
                                                                </div>
                                                                
                                                                <div class="question-step step5-5" style="display:none;">
                                                                    <div class="strategy-complete">
                                                                        <i class="fas fa-check-circle"></i>
                                                                        <p>策略设置完成</p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 主升期策略 -->
                                <div id="strategyContentRising" class="strategy-phase-content">
                                    <div class="strategy-card">
                                        <h3 class="strategy-card-title popup-trigger" data-popup-id="rising-popup">主升期目标：拥抱核心</h3>
                                        <div class="strategy-card-content">
                                            <div class="strategy-section">
                                                <h4><i class="fas fa-trophy"></i> 参与纪律：</h4>
                                                <ul>
                                                    <li>🅰️有主线做主线，主线不死透，坚决不主观做切换</li>
                                                    <li>🅰️右侧买+右侧卖</li>
                                                    <li>🅰️不要对主线视而不见，没有最好的上车点，也要在龙头身上多参与，而不是退而选择杂毛票</li>
                                                </ul>
                                            </div>
                                            <div class="strategy-section">
                                                <h4><i class="fas fa-list-ol"></i> 参与策略：</h4>
                                                <ol>
                                                    <li>参与龙头</li>
                                                    <li>在情绪衰退之前，选择绕不开的最佳套利标的</li>
                                                    <li>低位补涨</li>
                                                </ol>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 盘顶期策略 -->
                                <div id="strategyContentTop" class="strategy-phase-content">
                                    <div class="strategy-card">
                                        <h3 class="strategy-card-title popup-trigger" data-popup-id="top-popup">盘顶期目标：挖掘补涨</h3>
                                        <div class="strategy-card-content">
                                            <div class="strategy-section">
                                                <h4><i class="fas fa-trophy"></i> 参与纪律：</h4>
                                                <ul>
                                                    <li>🅰️坚守主线低吸，主线不死透，不主观做切换</li>
                                                    <li>🅰️做切换只做低位新题材，板指形态好且想象力大，强度表态的题材</li>
                                                    <li>🅰️右侧买+左侧卖</li>
                                                    <li>🅰️分歧日不做缩量板</li>
                                                    <li>🅰️龙头滞涨开始，坚决不做中位股</li>
                                                </ul>
                                            </div>
                                            <div class="strategy-section">
                                                <h4><i class="fas fa-list-ol"></i> 参与策略：</h4>
                                                <ol>
                                                    <li>辨识度高的热门小盘股</li>
                                                    <li>新题材低位股</li>
                                                </ol>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 退潮期策略 -->
                                <div id="strategyContentEbb" class="strategy-phase-content">
                                    <div class="strategy-card">
                                        <h3 class="strategy-card-title popup-trigger" data-popup-id="ebb-popup">退潮期目标：空仓防守</h3>
                                        <div class="strategy-card-content">
                                            <div class="strategy-section">
                                                <h4><i class="fas fa-list-ol"></i> 参与策略：</h4>
                                                <p>空仓</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 策略弹出卡片 -->
                        <div id="chaos-popup" class="strategy-popup">
                            <div class="strategy-popup-content">
                                <div class="strategy-popup-close">&times;</div>
                                <h3>混沌期本质原因及阶段特征</h3>
                                <p>资金进攻方向不一致，资金量少，故而题材不持续，做票只做有辨识度的票，其他票只能打板确认。有强度的题材在缺乏进攻方向时被资金选择，表现回流。</p>
                                <p><strong>重点：题材的持续性</strong></p>
                                <p>题材研判+板块形态好+题材内容量票表现好+引导的个股属性好</p>
                            </div>
                        </div>

                        <div id="rising-popup" class="strategy-popup">
                            <div class="strategy-popup-content">
                                <div class="strategy-popup-close">&times;</div>
                                <h3>主升期本质原因及阶段特征</h3>
                                <p>龙头个股爆量突破空间压制，并带领板块做多，赚钱效应回暖。题材的强势引导市场做多信心回暖，主线确认，资金围绕主线进攻，龙头明牌后资金挖掘辨识度个股进行补涨，市场在热烈的赚钱效应当中走向高潮，而后龙头分歧，进入高位震荡期。</p>
                            </div>
                        </div>

                        <div id="top-popup" class="strategy-popup">
                            <div class="strategy-popup-content">
                                <div class="strategy-popup-close">&times;</div>
                                <h3>盘顶期本质原因及阶段特征</h3>
                                <p>主线由于涨幅积累，受制于监管等因素，高位股继续上涨空间受限，但是主线内热度不减，于是资金挖掘低位补涨，因为此时主线早已明牌，这时引导打造出来的补涨需要被市场快速辨认出来并认同，才能取得高溢价，故而各路大资金挖掘的补涨都需要辨识度高，逻辑正，能让大众一看就知道他是对标龙头的。所以此时一定要选择辨识度高，逻辑上最正，走势上最为凌厉的热门小盘股。如果不是热门股，则可能是主力资金自己打造的，如有竞争选项，则需要pk一下看看来确认市场的认可度。此阶段的产生的题材内的补涨或者切换，一般陪着龙头走完盘顶后就结束，如果能抗住龙头下跌的分歧，才能够高看一眼看作穿越。</p>
                            </div>
                        </div>

                        <div id="ebb-popup" class="strategy-popup">
                            <div class="strategy-popup-content">
                                <div class="strategy-popup-close">&times;</div>
                                <h3>退潮期本质原因及阶段特征</h3>
                                <p>市场主线龙头跌停，板块负溢价严重，老主线被资金抛弃，新主线不能形成合力，在恐慌情绪下资金不敢做多，有赚就跑，新发育的主线很容易A杀。直到老主线止跌，亏钱效应减弱，市场发育环境温和，此时的新主线才能发育的出来。在止跌的节点上，低位共振新发的题材，中位逆势做多的个股转强带领板块，老题材的老龙头横盘再次突破，是新周期龙头的三个备选方向。</p>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">个人策略补充</label>
                            <textarea class="form-control form-textarea" name="personalStrategy" placeholder="根据您的经验和判断补充适合当前阶段的策略..."></textarea>
                        </div>
                    </div>

                    <div class="navigation-buttons">
                        <button type="button" class="btn btn-outline prev-section" data-prev="section3">
                            <i class="fas fa-arrow-left mr-2"></i> 上一步
                        </button>
                        <button type="button" class="btn btn-primary next-section" data-next="section5">
                            下一步 <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </section>

                <!-- 策略弹出卡片 -->
                <div id="strategy1-popup" class="strategy-popup">
                    <div class="strategy-popup-content">
                        <div class="strategy-popup-close">&times;</div>
                        <div class="popup-content-markdown">
                            <h5><strong>板块批量启动的最快换手1进2</strong></h5>
                            <div style="margin-top: 20px; background-color: var(--color-gray-50); padding: 15px; border-radius: 8px; border-left: 4px solid var(--color-primary);">
                                <p><strong>板块启动名称：</strong><input type="text" class="form-control" style="margin-bottom: 10px;"></p>
                                <p><strong>板块运行第几天：</strong><input type="text" class="form-control" style="margin-bottom: 10px;"></p>
                                <p><strong>板块今日状态如何：</strong><input type="text" class="form-control" style="margin-bottom: 10px;"></p>
                                <p><strong>板块明日预期如何：</strong><input type="text" class="form-control" style="margin-bottom: 10px;"></p>
                                
                                <div style="margin-top: 20px;">
                                    <p><strong>身位板：</strong><input type="text" class="form-control" style="margin-bottom: 10px;"></p>
                                    <p><strong>涨停最快：</strong><input type="text" class="form-control" style="margin-bottom: 10px;"></p>
                                    <p><strong>量能最大：</strong><input type="text" class="form-control" style="margin-bottom: 10px;"></p>
                                    <p><strong>k线形态好：</strong><input type="text" class="form-control" style="margin-bottom: 10px;"></p>
                                    <p><strong>人气榜前排：</strong><input type="text" class="form-control" style="margin-bottom: 10px;"></p>
                                </div>

                                <div style="margin-top: 20px;">
                                    <p><strong>是否符合板块强度标准：</strong></p>
                                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                        <button class="btn btn-outline" style="flex: 1;">否</button>
                                        <button class="btn btn-primary" style="flex: 1;">是</button>
                                    </div>
                                </div>

                                <div style="margin-top: 20px;">
                                    <p><strong>备选标的：</strong></p>
                                    <textarea class="form-control form-textarea" style="height: 100px;"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 板块强度弹出卡片 -->
                <div id="sector-strength-popup" class="strategy-popup">
                    <div class="strategy-popup-content">
                        <div class="strategy-popup-close">&times;</div>
                        <div class="popup-content-markdown">
                            <h5><strong>板块强度标准：</strong></h5>
                            <ol style="margin-top: 15px; line-height: 1.6;">
                                <li>在量能板指备选中</li>
                                <li>有中军，有300个股</li>
                                <li>题材逻辑强，有发酵预期</li>
                                <li>涨停家数大于10</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- 第五部分：自问清单 -->
                <section class="content-section" id="section5">
                    <h2 class="section-title">自问清单</h2>
                    
                    <div class="card">
                        <div class="form-group">
                            <label class="question-title">关键自问项目</label>
                            <div class="core-item-container">
                                <div class="core-item">
                                    <div class="core-item-header">
                                        <i class="fas fa-crown"></i>
                                        <span>地位</span>
                                    </div>
                                    <textarea class="form-control form-textarea" name="stockPosition" placeholder="是否是龙头，是否是核心，是否还有辨识度"></textarea>
                                </div>
                                
                                <div class="core-item">
                                    <div class="core-item-header">
                                        <i class="fas fa-dollar-sign"></i>
                                        <span>资金</span>
                                    </div>
                                    <textarea class="form-control form-textarea" name="fundingSupport" placeholder="明天买，后天有无资金接力"></textarea>
                                </div>
                                
                                <div class="core-item">
                                    <div class="core-item-header">
                                        <i class="fas fa-chart-line"></i>
                                        <span>预期</span>
                                    </div>
                                    <textarea class="form-control form-textarea" name="expectation" placeholder="为什么资金会来接力，能够打造什么样的预期"></textarea>
                                </div>
                                
                                <div class="core-item">
                                    <div class="core-item-header">
                                        <i class="fas fa-filter"></i>
                                        <span>选股范围</span>
                                    </div>
                                    <textarea class="form-control form-textarea" name="stockSelection" placeholder="是否在选股的范围内：连板票，x结构票，人气榜票，4天内的连板断板票"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="navigation-buttons">
                        <button type="button" class="btn btn-outline prev-section" data-prev="section4">
                            <i class="fas fa-arrow-left mr-2"></i> 上一步
                        </button>
                        <button type="button" class="btn btn-primary next-section" data-next="section6">
                            下一步 <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </section>

                <!-- 第六部分：明日计划 -->
                <section class="content-section" id="section6">
                    <h2 class="section-title">明日计划</h2>
                    
                    <div class="card">
                        <div class="form-group">
                            <label class="question-title">明日交易计划</label>
                            <div class="plan-container">
                                <div class="plan-item">
                                    <div class="plan-item-header">
                                        <i class="fas fa-eye"></i>
                                        <span>重点关注标的</span>
                                    </div>
                                    <textarea class="form-control form-textarea" name="focusStocks" placeholder="列出明日需要重点关注的股票..."></textarea>
                                </div>
                                
                                <div class="plan-item">
                                    <div class="plan-item-header">
                                        <i class="fas fa-hand-holding-usd"></i>
                                        <span>买入计划</span>
                                    </div>
                                    <textarea class="form-control form-textarea" name="buyPlan" placeholder="明确买入标的、价格区间、仓位控制..."></textarea>
                                </div>
                                
                                <div class="plan-item">
                                    <div class="plan-item-header">
                                        <i class="fas fa-sign-out-alt"></i>
                                        <span>卖出计划</span>
                                    </div>
                                    <textarea class="form-control form-textarea" name="sellPlan" placeholder="明确卖出标的、目标价位、止损位..."></textarea>
                                </div>
                                
                                <div class="plan-item">
                                    <div class="plan-item-header">
                                        <i class="fas fa-shield-alt"></i>
                                        <span>风险控制</span>
                                    </div>
                                    <textarea class="form-control form-textarea" name="riskControl" placeholder="设置整体仓位控制和应对极端行情的准备..."></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">心理状态调整</label>
                            <textarea class="form-control form-textarea" name="mentalAdjustment" placeholder="记录需要保持或调整的心态..."></textarea>
                        </div>
                    </div>

                    <div class="navigation-buttons">
                        <button type="button" class="btn btn-outline prev-section" data-prev="section5">
                            <i class="fas fa-arrow-left mr-2"></i> 上一步
                        </button>
                        <button type="button" class="btn btn-primary next-section" data-next="section7">
                            下一步 <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </section>

                <!-- 第七部分：交易总结 -->
                <section class="content-section" id="section7">
                    <h2 class="section-title">交易总结</h2>
                    
                    <div class="card">
                        <div class="form-group">
                            <label class="question-title">今日交易记录</label>
                            <div class="trading-record-container">
                                <div class="trading-record-header">
                                    <div class="record-col">股票</div>
                                    <div class="record-col">买入价</div>
                                    <div class="record-col">卖出价</div>
                                    <div class="record-col">盈亏</div>
                                    <div class="record-col">操作</div>
                                </div>
                                <div id="tradingRecords">
                                    <div class="trading-record-row">
                                        <div class="record-col"><input type="text" class="form-control" name="stock[]" placeholder="股票名称"></div>
                                        <div class="record-col"><input type="text" class="form-control" name="buyPrice[]" placeholder="买入价"></div>
                                        <div class="record-col"><input type="text" class="form-control" name="sellPrice[]" placeholder="卖出价"></div>
                                        <div class="record-col"><input type="text" class="form-control" name="profit[]" placeholder="盈亏%"></div>
                                        <div class="record-col"><button type="button" class="btn btn-outline remove-record"><i class="fas fa-trash-alt"></i></button></div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-outline add-record-btn">
                                    <i class="fas fa-plus"></i> 添加记录
                                </button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">总结与反思</label>
                            <textarea class="form-control form-textarea" name="tradingReflection" placeholder="总结今日交易的得失，反思改进点..."></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">情绪控制</label>
                            <div class="emotion-control">
                                <div class="emotion-slider-container">
                                    <span class="emotion-label">恐惧</span>
                                    <input type="range" min="1" max="10" value="5" class="emotion-slider" id="fearSlider">
                                    <span class="emotion-label">贪婪</span>
                                </div>
                                <div class="emotion-value" id="emotionValue">5</div>
                            </div>
                        </div>
                    </div>

                    <div class="navigation-buttons">
                        <button type="button" class="btn btn-outline prev-section" data-prev="section6">
                            <i class="fas fa-arrow-left mr-2"></i> 上一步
                        </button>
                        <button type="button" class="btn btn-primary" id="finalGenerateBtn">
                            <i class="fas fa-file-export mr-2"></i> 生成总结报告
                        </button>
                    </div>
                </section>

            </form>
            
            <!-- 移动端菜单按钮 -->
            <div class="mobile-menu-toggle" id="mobileMenuToggle">
                <i class="fas fa-bars"></i>
            </div>
        </main>
    </div>

    <!-- 自定义模态框 -->
    <div id="customModal" class="custom-modal">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h3 id="customModalTitle">提示</h3>
                <span class="custom-modal-close">&times;</span>
            </div>
            <div class="custom-modal-body">
                <p id="customModalMessage"></p>
            </div>
            <div class="custom-modal-footer">
                <button id="customModalOkBtn" class="btn btn-primary">确定</button>
            </div>
        </div>
    </div>

    <!-- Notes Popup Modal -->
    <div id="notesModal" class="custom-modal" style="display: none;">
        <div class="custom-modal-content" style="max-width: 800px;">
            <div class="custom-modal-header" style="padding: 0.75rem 1.25rem;">
                <h3 id="notesModalTitle" style="font-size: 1.1rem;">编辑笔记</h3>
                <span class="custom-modal-close notes-modal-close-btn" style="font-size: 1.25rem; cursor: pointer;">&times;</span>
            </div>
            <div class="custom-modal-body" style="padding: 1.25rem;">
                <div style="display: flex; gap: 20px; flex-wrap: nowrap;">
                    <div style="flex: 1; min-width: 0;">
                        <h4 style="font-weight: 600; font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--color-gray-700);">历史</h4>
                        <textarea id="historyNotesTextarea" class="form-control form-textarea" style="min-height: 150px; resize: vertical; font-size: 0.9rem;" placeholder="历史记录..." readonly></textarea>
                    </div>

                    <!-- 普通板块模式：前排后排分离 -->
                    <div id="normalModeContainer" style="display: flex; gap: 20px; flex: 2; min-width: 0;">
                        <div style="flex: 1; min-width: 0;">
                            <h4 style="font-weight: 600; font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--color-gray-700);">
                                今天
                                <span id="viewYesterdayPrediction" style="display: inline-block; margin-left: 10px; padding: 2px 8px; background-color: var(--color-primary); color: white; font-size: 0.8rem; border-radius: 4px; cursor: pointer;">
                                    昨日预判
                                </span>
                            </h4>
                            <div style="margin-bottom: 10px;">
                                <label style="font-size: 0.85rem; font-weight: 500; color: var(--color-gray-600); margin-bottom: 3px; display: block;">前排表现</label>
                                <textarea id="todayFrontNotesTextarea" class="form-control form-textarea" style="min-height: 70px; resize: vertical; font-size: 0.9rem;" placeholder="请输入前排表现..."></textarea>
                            </div>
                            <div>
                                <label style="font-size: 0.85rem; font-weight: 500; color: var(--color-gray-600); margin-bottom: 3px; display: block;">后排表现</label>
                                <textarea id="todayBackNotesTextarea" class="form-control form-textarea" style="min-height: 70px; resize: vertical; font-size: 0.9rem;" placeholder="请输入后排表现..."></textarea>
                            </div>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <h4 style="font-weight: 600; font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--color-gray-700);">明天</h4>
                            <div style="margin-bottom: 10px;">
                                <label style="font-size: 0.85rem; font-weight: 500; color: var(--color-gray-600); margin-bottom: 3px; display: block;">前排表现</label>
                                <textarea id="tomorrowFrontNotesTextarea" class="form-control form-textarea" style="min-height: 70px; resize: vertical; font-size: 0.9rem;" placeholder="请输入前排预判..."></textarea>
                            </div>
                            <div>
                                <label style="font-size: 0.85rem; font-weight: 500; color: var(--color-gray-600); margin-bottom: 3px; display: block;">后排表现</label>
                                <textarea id="tomorrowBackNotesTextarea" class="form-control form-textarea" style="min-height: 70px; resize: vertical; font-size: 0.9rem;" placeholder="请输入后排预判..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- 大盘模式：单一输入框 -->
                    <div id="marketModeContainer" style="display: none; gap: 20px; flex: 2; min-width: 0;">
                        <div style="flex: 1; min-width: 0;">
                            <h4 style="font-weight: 600; font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--color-gray-700);">
                                今天
                                <span id="viewYesterdayPredictionMarket" style="display: inline-block; margin-left: 10px; padding: 2px 8px; background-color: var(--color-primary); color: white; font-size: 0.8rem; border-radius: 4px; cursor: pointer;">
                                    昨日预判
                                </span>
                            </h4>
                            <textarea id="todayNotesTextarea" class="form-control form-textarea" style="min-height: 150px; resize: vertical; font-size: 0.9rem;" placeholder="请输入今天的内容..."></textarea>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <h4 style="font-weight: 600; font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--color-gray-700);">明天</h4>
                            <textarea id="tomorrowNotesTextarea" class="form-control form-textarea" style="min-height: 150px; resize: vertical; font-size: 0.9rem;" placeholder="请输入对明天的预判..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="custom-modal-footer" style="padding: 0.75rem 1.25rem; text-align: right;">
                <button id="saveNotesBtn" class="btn btn-primary">保存笔记</button>
                <button id="cancelNotesBtn" class="btn btn-outline notes-modal-close-btn" style="margin-left: 0.5rem;">取消</button>
            </div>
        </div>
    </div>

    <!-- JavaScript库 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <!-- Supabase客户端 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // 自定义模态框函数
        function showCustomModal(title, message, callback) {
            // 设置标题和消息
            $('#customModalTitle').text(title);
            $('#customModalMessage').text(message);
            
            // 显示模态框
            $('#customModal').css('display', 'flex');
            
            // 移除之前可能绑定的事件，避免重复绑定
            $('.custom-modal-close').off('click');
            $('#customModalOkBtn').off('click');
            $('#customModal').off('click');
            
            // 绑定关闭事件
            $('.custom-modal-close').on('click', function() {
                $('#customModal').css('display', 'none');
                // 如果存在自动关闭计时器，清除它
                if (window.autoCloseTimer) {
                    clearTimeout(window.autoCloseTimer);
                    window.autoCloseTimer = null;
                }
            });
            
            // 绑定确定按钮事件
            $('#customModalOkBtn').on('click', function() {
                $('#customModal').css('display', 'none');
                // 如果存在自动关闭计时器，清除它
                if (window.autoCloseTimer) {
                    clearTimeout(window.autoCloseTimer);
                    window.autoCloseTimer = null;
                }
                // 如果有回调函数，则执行
                if (typeof callback === 'function') {
                    callback();
                }
            });
            
            // 点击模态框外部也可关闭
            $('#customModal').on('click', function(e) {
                if (e.target === this) {
                    $('#customModal').css('display', 'none');
                    // 如果存在自动关闭计时器，清除它
                    if (window.autoCloseTimer) {
                        clearTimeout(window.autoCloseTimer);
                        window.autoCloseTimer = null;
                    }
                }
            });
        }
        
        $(document).ready(function() {
            // 确保"策略方法"页面的策略卡片默认是折叠状态
            setTimeout(function() {
                // 延迟执行以确保DOM完全加载
                if ($('#section4').length) {
                    // 所有卡片默认折叠
                    $('.strategy-option-card').each(function() {
                        const card = $(this);
                        const body = card.find('.strategy-option-body');
                        const header = card.find('.strategy-option-header');
                        
                        // 处理汉字垂直显示的特殊处理
                        const title = header.find('span').text();
                        const chars = title.split('');
                        if (chars.length > 0 && !header.hasClass('header-collapsed')) {
                            // 添加数据属性保存原始标题
                            header.attr('data-original-title', title);
                        }
                        
                        // 默认折叠状态 - 使用新的CSS类实现
                        body.css('display', 'none');
                        header.addClass('header-collapsed');
                        card.addClass('card-collapsed');
                        
                        // 移除所有折叠按钮
                        card.find('.collapse-btn').remove();
                    });
                    
                    // 移除所有策略卡片内容区域的背景和左侧边框
                    $('.strategy-detail-content').each(function() {
                        $(this).removeAttr('style').css({
                            'text-align': 'left',
                            'margin-top': '15px'
                        });
                    });
                }
            }, 500);
            // 初始化日期为今天
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            $('#reviewDate').val(formattedDate);
            
            // 已移除深色模式切换
            
            // 移动端菜单切换
            $('#mobileMenuToggle').click(function() {
                $('#sidebar').toggleClass('mobile-open');
            });
            
            // 导航切换
                       // 导航切换
            $('.sidebar-item').click(function() {
                const sectionId = $(this).data('section');
                const isMacroRiskFree = $('input[name="macroRiskFree"]').is(':checked');
                const isNonBreakingIndex = $('input[name="nonBreakingIndex"]').is(':checked');

                // 如果此导航项被禁用 (通过CSS类判断)
                if ($(this).hasClass('disabled')) {
                    showCustomModal('提示', '请先在"市场多空"页面确认宏观大盘无风险！');
                    return; 
                }

                // 如果要切换到的部分不是section1，并且条件未满足，则阻止切换
                if (sectionId !== 'section1' && !(isMacroRiskFree && isNonBreakingIndex)) {
                    showCustomModal('提示', '请先在"市场多空"页面确认宏观大盘无风险！');
                    return; 
                }
                
                $('.sidebar-item').removeClass('active');
                $(this).addClass('active');
                
                $('.content-section').removeClass('active');
                $('#' + sectionId).addClass('active');
                
                // 如果切换到策略方法页面，更新策略卡片
                if (sectionId === 'section4') {
                    setTimeout(function() {
                        updateStrategyCards();
                    }, 100);
                }
                
                // 更新进度条
                updateProgressBar();
            });
            
                       // 更新进度条
            function updateProgressBar() {
                const currentSection = $('.content-section.active').attr('id');
                const sectionNumber = parseInt(currentSection.replace('section', ''));
                const totalActualSections = 7; // section1 to section7 (7 sections)
                // section1 is 0%, section2 is 1/6, section3 is 2/6 ... section7 is 6/6 (100%)
                const progress = sectionNumber === 1 ? 0 : ((sectionNumber - 1) / (totalActualSections - 1)) * 100;
                
                $('#progressBar').css('width', progress + '%');
            }
            
            // 下一步按钮
            $('.next-section').click(function() {
                const nextSection = $(this).data('next');
                
                // 检查宏观风险选项是否已勾选
                const isMacroRiskFree = $('input[name="macroRiskFree"]').is(':checked');
                const isNonBreakingIndex = $('input[name="nonBreakingIndex"]').is(':checked');
                
                // 如果从第一部分到其他部分，需要检查条件
                if ($(this).closest('.content-section').attr('id') === 'section1' && !(isMacroRiskFree && isNonBreakingIndex)) {
                    showCustomModal('提示', '请先确认宏观大盘无风险！');
                    return;
                }
                
                // 切换到下一部分
                $('.sidebar-item').removeClass('active');
                $(`.sidebar-item[data-section="${nextSection}"]`).addClass('active');
                
                $('.content-section').removeClass('active');
                $('#' + nextSection).addClass('active');
                
                // 更新进度条
                updateProgressBar();
                
                // 如果是切换到板块节奏，初始化图表
                if (nextSection === 'section3') {
                    initSectorRotationChart();
                    
                    // 获取当前选中的情绪阶段
                    const selectedTheme = $('.mood-item.selected').data('theme');
                    if (selectedTheme) {
                        // 根据情绪阶段更新板块节奏页面内容
                        updateSectorContent(selectedTheme);
                    } else {
                        // 如果未选择情绪阶段，显示提示
                        $('#chaosContent, #risingContent').hide();
                        $('#otherMoodContent').show();
                    }
                }
                
                // 如果是切换到策略方法页面，更新策略卡片
                if (nextSection === 'section4') {
                    setTimeout(function() {
                        updateStrategyCards();
                    }, 100);
                }
            });
            
            // 上一步按钮
            $('.prev-section').click(function() {
                const prevSection = $(this).data('prev');
                
                $('.sidebar-item').removeClass('active');
                $(`.sidebar-item[data-section="${prevSection}"]`).addClass('active');
                
                $('.content-section').removeClass('active');
                $('#' + prevSection).addClass('active');
                
                // 更新进度条
                updateProgressBar();
            });
            
            // 更新进度条
                       // 导航切换
            $('.sidebar-item').click(function() {
                const sectionId = $(this).data('section');
                const isMacroRiskFree = $('input[name="macroRiskFree"]').is(':checked');
                const isNonBreakingIndex = $('input[name="nonBreakingIndex"]').is(':checked');

                // 如果此导航项被禁用 (通过CSS类判断)
                if ($(this).hasClass('disabled')) {
                    showCustomModal('提示', '请先在"市场多空"页面确认宏观大盘无风险！');
                    return; 
                }

                // 如果要切换到的部分不是section1，并且条件未满足，则阻止切换
                if (sectionId !== 'section1' && !(isMacroRiskFree && isNonBreakingIndex)) {
                    showCustomModal('提示', '请先在"市场多空"页面确认宏观大盘无风险！');
                    return; 
                }
                
                $('.sidebar-item').removeClass('active');
                $(this).addClass('active');
                
                $('.content-section').removeClass('active');
                $('#' + sectionId).addClass('active');
                
                // 如果切换到策略方法页面，更新策略卡片
                if (sectionId === 'section4') {
                    setTimeout(function() {
                        updateStrategyCards();
                    }, 100);
                }
                
                // 更新进度条
                updateProgressBar();
            });

            // ========== 情绪阶段动效和音效系统 ==========

            // 音效播放器类 - 真实音频文件版本
            class MoodSoundPlayer {
                constructor() {
                    this.audioElements = {
                        chaos: document.getElementById('chaosSound'),
                        rising: document.getElementById('risingSound'),
                        top: document.getElementById('topSound'),
                        ebb: document.getElementById('ebbSound')
                    };

                    this.currentAudio = null;
                    this.initAudioElements();
                }

                initAudioElements() {
                    // 为所有音频元素设置默认属性
                    let hasValidAudio = false;
                    const loadedAudios = [];
                    const failedAudios = [];

                    Object.entries(this.audioElements).forEach(([key, audio]) => {
                        if (audio) {
                            audio.volume = 0.4; // 设置默认音量（40%）
                            audio.loop = false;

                            console.log(`🔍 正在加载音效: ${audio.id}`, `路径: ${audio.querySelector('source')?.src || '未设置'}`);

                            // 添加错误处理
                            audio.addEventListener('error', (e) => {
                                const source = audio.querySelector('source');
                                failedAudios.push(audio.id);
                                console.error('❌ 音频加载失败:', audio.id);
                                console.error('   文件路径:', source?.src || '未设置');
                                console.error('   错误代码:', audio.error?.code);
                                console.error('   错误信息:', audio.error?.message);
                            });

                            // 添加加载成功提示
                            audio.addEventListener('canplay', () => {
                                hasValidAudio = true;
                                loadedAudios.push(audio.id);
                                console.log('✅ 音效已准备就绪:', audio.id);
                            });

                            // 添加加载开始提示
                            audio.addEventListener('loadstart', () => {
                                console.log('⏳ 开始加载:', audio.id);
                            });

                            // 添加加载完成提示
                            audio.addEventListener('loadeddata', () => {
                                console.log('📦 数据已加载:', audio.id);
                            });
                        }
                    });

                    // 页面加载后提示用户
                    setTimeout(() => {
                        console.log('');
                        console.log('═══════════════════════════════════════');
                        console.log('🔊 音效系统状态报告');
                        console.log('═══════════════════════════════════════');
                        console.log('');
                        console.log(`✅ 加载成功: ${loadedAudios.length} 个`);
                        if (loadedAudios.length > 0) {
                            loadedAudios.forEach(id => console.log(`   - ${id}`));
                        }
                        console.log('');
                        console.log(`❌ 加载失败: ${failedAudios.length} 个`);
                        if (failedAudios.length > 0) {
                            failedAudios.forEach(id => console.log(`   - ${id}`));
                        }
                        console.log('');

                        if (hasValidAudio) {
                            console.log('🎵 音效系统已就绪！');
                            console.log('');
                            console.log('💡 测试方法：');
                            console.log('1. 点击"情绪阶段"标签页');
                            console.log('2. 选择任意情绪（混沌期/主升期/盘顶期/退潮期）');
                            console.log('3. 或在控制台执行: testSound("chaos")');
                            console.log('');
                        } else {
                            console.log('⚠️ 所有音效加载失败！');
                            console.log('');
                            console.log('🔍 可能的原因：');
                            console.log('1. 音频文件不存在或路径错误');
                            console.log('2. 文件格式不支持（请使用MP3格式）');
                            console.log('3. 文件损坏');
                            console.log('');
                            console.log('📁 当前音频路径配置：');
                            Object.values(this.audioElements).forEach(audio => {
                                const source = audio.querySelector('source');
                                console.log(`   ${audio.id}: ${source?.src || '未设置'}`);
                            });
                            console.log('');
                        }
                        console.log('═══════════════════════════════════════');
                        console.log('');

                        // 显示或隐藏页面提示
                        if (!hasValidAudio && !localStorage.getItem('audioTipDismissed')) {
                            const audioTip = document.getElementById('audioTip');
                            if (audioTip) {
                                audioTip.style.display = 'block';
                                setTimeout(() => {
                                    audioTip.style.opacity = '0';
                                    audioTip.style.transition = 'opacity 0.5s';
                                    setTimeout(() => {
                                        audioTip.style.display = 'none';
                                    }, 500);
                                }, 8000);
                            }
                        }
                    }, 2000); // 延长到2秒，确保所有音频都加载完成
                }

                // 播放不同情绪的音效
                playMoodSound(theme) {
                    // 停止当前正在播放的音效
                    this.stopCurrentSound();

                    // 获取对应的音频元素
                    const audio = this.audioElements[theme];

                    if (!audio) {
                        console.warn(`未找到 ${theme} 主题的音效`);
                        return;
                    }

                    // 检查音频源是否有效（支持 <source> 标签）
                    const source = audio.querySelector('source');
                    const audioSrc = audio.currentSrc || source?.src || audio.src;

                    if (!audioSrc || audioSrc.endsWith('#') || audioSrc === '') {
                        console.log(`💡 ${theme} 音效未配置，仅显示动效。`);
                        return;
                    }

                    // 重置播放位置到开头
                    audio.currentTime = 0;

                    // 播放音效
                    const playPromise = audio.play();

                    if (playPromise !== undefined) {
                        playPromise
                            .then(() => {
                                this.currentAudio = audio;
                                console.log(`🔊 正在播放 ${theme} 音效`);

                                // 3秒后淡出并停止音效（与动效同步）
                                setTimeout(() => {
                                    this.fadeOutAndStop(audio);
                                }, 2500); // 2.5秒后开始淡出，保证3秒内完成
                            })
                            .catch(error => {
                                console.warn('⚠️ 音效播放失败:', error.message);
                                if (error.name === 'NotAllowedError') {
                                    console.log('💡 提示：浏览器阻止了自动播放。请先与页面交互（点击任意位置）后再试。');
                                } else if (error.name === 'NotSupportedError') {
                                    console.log('💡 提示：音频文件格式不支持或文件不存在。');
                                }
                            });
                    }
                }

                // 淡出并停止音效
                fadeOutAndStop(audio) {
                    if (!audio) return;

                    const originalVolume = audio.volume;
                    const fadeOutDuration = 500; // 淡出持续500毫秒
                    const steps = 20;
                    const stepDuration = fadeOutDuration / steps;
                    const volumeDecrement = originalVolume / steps;

                    let currentStep = 0;
                    const fadeInterval = setInterval(() => {
                        currentStep++;
                        audio.volume = Math.max(0, originalVolume - (volumeDecrement * currentStep));

                        if (currentStep >= steps) {
                            clearInterval(fadeInterval);
                            audio.pause();
                            audio.currentTime = 0;
                            audio.volume = originalVolume; // 恢复原始音量
                        }
                    }, stepDuration);
                }

                // 停止当前播放的音效
                stopCurrentSound() {
                    if (this.currentAudio) {
                        this.currentAudio.pause();
                        this.currentAudio.currentTime = 0;
                        this.currentAudio = null;
                    }
                }

                // 设置所有音效的音量
                setVolume(volume) {
                    const clampedVolume = Math.max(0, Math.min(1, volume));
                    Object.values(this.audioElements).forEach(audio => {
                        if (audio) {
                            audio.volume = clampedVolume;
                        }
                    });
                }

                // 更换音效文件（允许用户自定义音效）
                setSoundFile(theme, url) {
                    const audio = this.audioElements[theme];
                    if (audio) {
                        audio.src = url;
                        audio.load();
                        console.log(`${theme} 音效已更新为: ${url}`);
                    }
                }
            }

            // 创建音效播放器实例
            const moodSoundPlayer = new MoodSoundPlayer();

            // 全局测试函数 - 供用户在控制台测试音效
            window.testSound = function(theme) {
                const validThemes = ['chaos', 'rising', 'top', 'ebb'];
                if (!validThemes.includes(theme)) {
                    console.error('❌ 无效的主题！请使用: chaos, rising, top, ebb');
                    return;
                }

                console.log(`🎵 测试播放: ${theme} 音效`);
                const audio = moodSoundPlayer.audioElements[theme];

                if (!audio) {
                    console.error('❌ 未找到音频元素');
                    return;
                }

                console.log('📁 音频源:', audio.querySelector('source')?.src);
                console.log('🔊 音量:', audio.volume);
                console.log('⏱️ 时长:', audio.duration || '未加载');

                // 强制从头播放
                audio.currentTime = 0;
                const playPromise = audio.play();

                if (playPromise !== undefined) {
                    playPromise
                        .then(() => {
                            console.log('✅ 播放成功！');
                        })
                        .catch(error => {
                            console.error('❌ 播放失败:', error.message);
                            if (error.name === 'NotAllowedError') {
                                console.log('💡 提示：浏览器阻止了自动播放。请先点击页面任意位置，然后重试。');
                            } else if (error.name === 'NotSupportedError') {
                                console.log('💡 提示：音频格式不支持或文件不存在。');
                            }
                        });
                }
            };

            // 提示用户可以使用测试函数
            console.log('💡 已加载音效测试函数：testSound(theme)');
            console.log('   示例: testSound("chaos") - 测试混沌期音效');
            console.log('   示例: testSound("rising") - 测试主升期音效');
            console.log('   示例: testSound("top") - 测试盘顶期音效');
            console.log('   示例: testSound("ebb") - 测试退潮期音效');

            // 背景动效控制器
            class MoodEffectController {
                constructor() {
                    this.currentEffect = null;
                    this.hideTimer = null; // 添加定时器属性
                    this.effectContainers = {
                        chaos: document.getElementById('chaosEffect'),
                        rising: document.getElementById('risingEffect'),
                        top: document.getElementById('topEffect'),
                        ebb: document.getElementById('ebbEffect')
                    };
                    this.bgContainer = document.getElementById('moodBgEffect');
                    this.initEffects();
                }

                initEffects() {
                    // 初始化混沌期粒子
                    this.createChaosParticles();
                    // 初始化主升期光芒
                    this.createRisingRays();
                    // 初始化盘顶期波纹
                    this.createTopRipples();
                    // 初始化退潮期雨滴
                    this.createEbbDrops();
                }

                createChaosParticles() {
                    const container = this.effectContainers.chaos;
                    container.innerHTML = '';
                    for (let i = 0; i < 20; i++) {
                        const particle = document.createElement('div');
                        particle.className = 'chaos-particle';
                        particle.style.left = Math.random() * 100 + '%';
                        particle.style.top = Math.random() * 100 + '%';
                        particle.style.animationDelay = Math.random() * 3 + 's';
                        particle.style.animationDuration = (3 + Math.random() * 2) + 's';
                        container.appendChild(particle);
                    }
                }

                createRisingRays() {
                    const container = this.effectContainers.rising;
                    container.innerHTML = '';
                    for (let i = 0; i < 20; i++) {
                        const ray = document.createElement('div');
                        ray.className = 'rising-ray';
                        ray.style.left = (i * 5) + '%';
                        ray.style.animationDelay = Math.random() * 3 + 's';
                        ray.style.animationDuration = (2 + Math.random() * 2) + 's';
                        container.appendChild(ray);
                    }
                }

                createTopRipples() {
                    const container = this.effectContainers.top;
                    container.innerHTML = '';

                    // 创建6组闪电（主干+分支）
                    for (let i = 0; i < 6; i++) {
                        // 主干位置
                        const boltLeft = 15 + i * 14 + (Math.random() * 6 - 3);

                        // 创建主干
                        const bolt = document.createElement('div');
                        bolt.className = 'lightning-bolt';
                        bolt.style.left = boltLeft + '%';
                        bolt.style.animationDelay = (i * 0.4 + Math.random() * 0.5) + 's';
                        container.appendChild(bolt);

                        // 随机添加1-2个分支
                        const branchCount = Math.random() > 0.5 ? 2 : 1;
                        for (let j = 0; j < branchCount; j++) {
                            const branch = document.createElement('div');
                            branch.className = 'lightning-branch';

                            // 分支从主干的某个位置发出
                            const branchTop = 20 + Math.random() * 30; // 20%-50%的位置
                            branch.style.left = boltLeft + '%';
                            branch.style.top = branchTop + '%';

                            // 分支向左或向右倾斜
                            const direction = Math.random() > 0.5 ? 1 : -1;
                            const angle = 30 + Math.random() * 30; // 30-60度
                            branch.style.transform = `rotate(${direction * angle}deg)`;

                            // 与主干同步闪烁
                            branch.style.animationDelay = bolt.style.animationDelay;

                            container.appendChild(branch);
                        }
                    }
                }

                createEbbDrops() {
                    const container = this.effectContainers.ebb;
                    container.innerHTML = '';
                    for (let i = 0; i < 40; i++) {
                        const drop = document.createElement('div');
                        drop.className = 'ebb-drop';
                        drop.style.left = Math.random() * 100 + '%';
                        drop.style.animationDelay = Math.random() * 2 + 's';
                        drop.style.animationDuration = (1.5 + Math.random()) + 's';
                        container.appendChild(drop);
                    }
                }

                showEffect(theme) {
                    // 清除之前的定时器（如果存在）
                    if (this.hideTimer) {
                        clearTimeout(this.hideTimer);
                        this.hideTimer = null;
                    }

                    // 隐藏所有效果
                    Object.values(this.effectContainers).forEach(container => {
                        container.style.display = 'none';
                    });

                    // 显示选中的效果
                    if (this.effectContainers[theme]) {
                        this.effectContainers[theme].style.display = 'block';
                        this.bgContainer.classList.add('active');
                        this.currentEffect = theme;

                        // 3秒后自动隐藏
                        this.hideTimer = setTimeout(() => {
                            this.hideAllEffects();
                        }, 3000);
                    }
                }

                hideAllEffects() {
                    // 清除定时器
                    if (this.hideTimer) {
                        clearTimeout(this.hideTimer);
                        this.hideTimer = null;
                    }

                    Object.values(this.effectContainers).forEach(container => {
                        container.style.display = 'none';
                    });
                    this.bgContainer.classList.remove('active');
                    this.currentEffect = null;
                }
            }

            // 创建动效控制器实例
            const moodEffectController = new MoodEffectController();

            // 情绪阶段选择
            $('.mood-item').click(function() {
                $('.mood-item').removeClass('selected');
                $(this).addClass('selected');
                
                const mood = $(this).data('mood');
                const theme = $(this).data('theme');
                
                // 更新主题
                $('body').removeClass('mood-theme-chaos mood-theme-rising mood-theme-top mood-theme-ebb');
                $('body').addClass('mood-theme-' + theme);
                
                // 触发主题变化事件
                $(document).trigger('moodThemeChanged', [theme]);

                // ========== 触发背景动效和音效 ==========
                // 播放音效
                moodSoundPlayer.playMoodSound(theme);
                // 显示背景动效
                moodEffectController.showEffect(theme);

                // 显示相应的情绪详情
                $('.mood-detail-card').hide();
                $(`.mood-${theme}-detail`).fadeIn();
                
                // 显示相应的策略内容
                $('.strategy-phase-content').removeClass('active');
                $(`#strategyContent${theme.charAt(0).toUpperCase() + theme.slice(1)}`).addClass('active');
                
                // 如果是混沌期，更新策略标题
                if (theme === 'chaos') {
                    $('.strategy-option-card').each(function(index) {
                        const headers = ['最快换手板', '独立1进2', '消息挖掘首板', '人气榜', '龙头弱转强'];
                        if (index < headers.length) {
                            const $span = $(this).find('.strategy-option-header span');
                            $span.text(headers[index]);
                            
                            // 保持折叠状态的样式
                            if (!$(this).find('.strategy-option-body').is(':visible')) {
                                $(this).find('.strategy-option-header').attr('title', '点击展开' + headers[index]);
                            } else {
                                $(this).find('.strategy-option-header').attr('title', '点击折叠' + headers[index]);
                            }
                        }
                    });
                } else {
                    // 恢复默认标题
                    $('.strategy-option-card').each(function(index) {
                        const defaultTitle = `策略${index + 1}`;
                        const $span = $(this).find('.strategy-option-header span');
                        $span.text(defaultTitle);
                        
                        // 保持折叠状态的样式
                        if (!$(this).find('.strategy-option-body').is(':visible')) {
                            $(this).find('.strategy-option-header').attr('title', '点击展开' + defaultTitle);
                        } else {
                            $(this).find('.strategy-option-header').attr('title', '点击折叠' + defaultTitle);
                        }
                    });
                }
                
                // 更新推荐仓位
                updatePositionByMood(theme);
                
                // 根据情绪阶段更新板块节奏页面内容
                updateSectorContent(theme);
                
                // 自动跳转到板块节奏页面
                setTimeout(function() {
                    $('.sidebar-item').removeClass('active');
                    $(`.sidebar-item[data-section="section3"]`).addClass('active');
                    $('.content-section').removeClass('active');
                    $('#section3').addClass('active');
                    // 初始化图表
                    initSectorRotationChart();
                    // 更新进度条
                    updateProgressBar();
                }, 500); // 延迟500毫秒跳转，让用户有时间感知情绪阶段选择的变化
            });
            
            // 根据情绪阶段更新推荐仓位
            function updatePositionByMood(mood) {
                let position = 0;
                let positionText = '';
                
                switch(mood) {
                    case 'chaos': // 混沌期
                        position = 30;
                        positionText = '适中偏低仓位：30%';
                        break;
                    case 'rising': // 主升期
                        position = 70;
                        positionText = '适中偏高仓位：70%';
                        break;
                    case 'top': // 盘顶期
                        position = 40;
                        positionText = '适中偏低仓位：40%';
                        break;
                    case 'ebb': // 退潮期
                        position = 10;
                        positionText = '极低仓位：10%';
                        break;
                    default:
                        position = 0;
                        positionText = '请先选择市场情绪阶段';
                }
                
                $('#positionDisplay .position-value').text(positionText);
                $('#positionDisplay .position-fill').css('width', position + '%');
            }

            // 处理量能放大和指数拐点多选框的逻辑（section3专用）
            function updateConditionMessage() {
                // 只在section3中执行此逻辑
                if (!$('#section3').is(':visible')) {
                    return;
                }
                
                const volumeAmplified = $('#volumeAmplified').is(':checked');
                const indexTurningPoint = $('#indexTurningPoint').is(':checked');
                const section3Image = $('#section3-main-image');
                const section3BaotuanContainer = $('#section3-baotuan-container');
                
                // 重置抱团容器和选择状态
                section3BaotuanContainer.addClass('hidden');
                $('#section3-baotuan-container .baotuan-text').removeClass('selected');
                
                if (volumeAmplified && indexTurningPoint) {
                    // 两者都选中：显示大周期条件图片
                    section3Image.attr('src', 'https://wuqq-obsidian.oss-cn-shanghai.aliyuncs.com/obsidian%E5%9B%BE%E7%89%87/%E5%85%B7%E5%A4%87%E5%BC%80%E5%90%AF%E5%A4%A7%E5%91%A8%E6%9C%9F%E6%9D%A1%E4%BB%B6.png');
                    section3Image.show();
                } else if (volumeAmplified && !indexTurningPoint) {
                    // 只选中量能放大：显示小周期条件图片
                    section3Image.attr('src', 'https://wuqq-obsidian.oss-cn-shanghai.aliyuncs.com/obsidian%E5%9B%BE%E7%89%87/%E5%85%B7%E5%A4%87%E5%BC%80%E5%90%AF%E5%B0%8F%E5%91%A8%E6%9C%9F%E6%9D%A1%E4%BB%B6.png');
                    section3Image.show();
                } else if (!volumeAmplified && !indexTurningPoint) {
                    // 两者都未选中：显示轮动行情图片，并显示抱团选项
                    section3Image.attr('src', 'https://wuqq-obsidian.oss-cn-shanghai.aliyuncs.com/obsidian%E5%9B%BE%E7%89%87/%E8%BD%AE%E5%8A%A8%E8%A1%8C%E6%83%85.png');
                    section3Image.show();
                    section3BaotuanContainer.removeClass('hidden');
                } else {
                    // 只选中指数拐点：隐藏图片
                    section3Image.hide();
                }
                
                // 更新策略方法页面的策略卡片
                updateStrategyCards();
            }
            
            // 更新策略卡片显示
            function updateStrategyCards() {
                const volumeAmplified = $('#volumeAmplified').is(':checked');
                const indexTurningPoint = $('#indexTurningPoint').is(':checked');
                const baotuanSelected = $('.baotuan-text').hasClass('selected');
                
                // 获取所有策略卡片
                const strategyCards = $('.strategy-option-card').not('.startup-card');
                
                // 先移除任何已存在的启动题材1进2卡片
                $('.strategy-option-card.startup-card').remove();
                
                if (volumeAmplified && indexTurningPoint) {
                    // 情况1：具备大周期条件（量能放大 + 指数拐点均被选中）
                    // 参与策略显示：板块1进2（涨停10以上）、低吸唯一弹性辨识度、高度板弱转强、独立1进2
                    
                    strategyCards.each(function(index) {
                        const header = $(this).find('.strategy-option-header span');
                        const body = $(this).find('.strategy-option-body p').first();
                        
                        if (index === 0) { // 策略一：板块1进2（涨停10以上）
                            header.text('板块1进2（涨停10以上）');
                            body.text('板块1进2（涨停10以上）');
                            $(this).show().css({'max-width': '220px', 'flex': '1 1 24%'});
                        } else if (index === 1) { // 策略二：低吸唯一弹性辨识度
                            header.text('低吸唯一弹性辨识度');
                            body.text('低吸唯一弹性辨识度');
                            $(this).show().css({'max-width': '220px', 'flex': '1 1 24%'});
                        } else if (index === 2) { // 策略三：高度板弱转强
                            header.text('高度板弱转强');
                            body.text('高度板弱转强');
                            $(this).show().css({'max-width': '220px', 'flex': '1 1 24%'});
                        } else if (index === 3) { // 策略四：独立1进2
                            header.text('独立1进2');
                            body.text('独立1进2');
                            $(this).show().css({'max-width': '220px', 'flex': '1 1 24%'});
                        } else if (index === 4) { // 策略五：隐藏
                            $(this).hide();
                        }
                    });
                    
                } else if (volumeAmplified && !indexTurningPoint) {
                    // 情况2：具备小周期条件（只有量能放大被勾选）
                    // 参与策略显示：板块1进2（涨停10以上）、独立1进2、低吸潜龙
                    
                    strategyCards.each(function(index) {
                        const header = $(this).find('.strategy-option-header span');
                        const body = $(this).find('.strategy-option-body p').first();
                        
                        if (index === 0) { // 策略一：板块1进2（涨停10以上）
                            header.text('板块1进2（涨停10以上）');
                            body.text('板块1进2（涨停10以上）');
                            $(this).show().css({'max-width': '280px', 'flex': '1 1 32%'});
                        } else if (index === 1) { // 策略二：独立1进2
                            header.text('独立1进2');
                            body.text('独立1进2');
                            $(this).show().css({'max-width': '280px', 'flex': '1 1 32%'});
                        } else if (index === 2) { // 策略三：低吸潜龙
                            header.text('低吸潜龙');
                            body.text('低吸潜龙');
                            $(this).show().css({'max-width': '280px', 'flex': '1 1 32%'});
                        } else if (index === 3) { // 策略四：隐藏
                            $(this).hide();
                        } else if (index === 4) { // 策略五：隐藏
                            $(this).hide();
                        }
                    });
                    
                } else if (!volumeAmplified && !indexTurningPoint) {
                    // 情况3和4：都不被选择
                    if (baotuanSelected) {
                        // 情况3：抱团行情（都不被选择，但抱团被选中）
                        // 参与策略显示：板块1进2（涨停10以上）、低吸抱团
                        
                        strategyCards.each(function(index) {
                            const header = $(this).find('.strategy-option-header span');
                            const body = $(this).find('.strategy-option-body p').first();
                            
                            if (index === 0) { // 策略一：板块1进2（涨停10以上）
                                header.text('板块1进2（涨停10以上）');
                                body.text('板块1进2（涨停10以上）');
                                $(this).show().css({'max-width': '400px', 'flex': '1 1 48%'});
                            } else if (index === 1) { // 策略二：低吸抱团
                                header.text('低吸抱团');
                                body.text('低吸抱团');
                                $(this).show().css({'max-width': '400px', 'flex': '1 1 48%'});
                            } else if (index === 2) { // 策略三：隐藏
                                $(this).hide();
                            } else if (index === 3) { // 策略四：隐藏
                                $(this).hide();
                            } else if (index === 4) { // 策略五：隐藏
                                $(this).hide();
                            }
                        });
                    } else {
                        // 情况4：轮动行情（都不被选择，抱团也未被选中）
                        // 参与策略显示：板块1进2（涨停10以上）、低吸轮动、消息潜伏
                        
                        strategyCards.each(function(index) {
                            const header = $(this).find('.strategy-option-header span');
                            const body = $(this).find('.strategy-option-body p').first();
                            
                            if (index === 0) { // 策略一：板块1进2（涨停10以上）
                                header.text('板块1进2（涨停10以上）');
                                body.text('板块1进2（涨停10以上）');
                                $(this).show().css({'max-width': '280px', 'flex': '1 1 32%'});
                            } else if (index === 1) { // 策略二：低吸轮动
                                header.text('低吸轮动');
                                body.text('低吸轮动');
                                $(this).show().css({'max-width': '280px', 'flex': '1 1 32%'});
                            } else if (index === 2) { // 策略三：消息潜伏
                                header.text('消息潜伏');
                                body.text('消息潜伏');
                                $(this).show().css({'max-width': '280px', 'flex': '1 1 32%'});
                            } else if (index === 3) { // 策略四：隐藏
                                $(this).hide();
                            } else if (index === 4) { // 策略五：隐藏
                                $(this).hide();
                            }
                        });
                    }
                } else {
                    // 其他情况（只有指数拐点被选中）：恢复默认状态
                    strategyCards.each(function(index) {
                        const header = $(this).find('.strategy-option-header span');
                        const body = $(this).find('.strategy-option-body p').first();
                        
                        if (index === 0) {
                            header.text('启动板块最快换手板');
                            body.text('启动板块最快换手板');
                            $(this).show().css({'max-width': '200px', 'flex': '1 1 18%'});
                        } else if (index === 1) {
                            header.text('独立题材1进2');
                            body.text('独立题材1进2');
                            $(this).show().css({'max-width': '200px', 'flex': '1 1 18%'});
                        } else if (index === 2) {
                            header.text('新消息逻辑发酵');
                            body.html('<a href="https://xuangutong.com.cn/live" target="_blank" style="color: inherit; text-decoration: none;">新消息逻辑发酵</a>');
                            $(this).show().css({'max-width': '200px', 'flex': '1 1 18%'});
                        } else if (index === 3) {
                            header.text('人气榜前排');
                            body.text('人气榜前排');
                            $(this).show().css({'max-width': '200px', 'flex': '1 1 18%'});
                        } else if (index === 4) {
                            header.text('板块龙头弱转强');
                            body.text('板块龙头弱转强');
                            $(this).show().css({'max-width': '200px', 'flex': '1 1 18%'});
                        }
                    });
                }
            }
            
            // 显示section3抱团行情图片
            window.showSection3BaotuanImage = function() {
                const section3Image = $('#section3-main-image');
                const section3BaotuanContainer = $('#section3-baotuan-container');
                const baotuanText = section3BaotuanContainer.find('.baotuan-text');
                
                section3Image.attr('src', 'https://wuqq-obsidian.oss-cn-shanghai.aliyuncs.com/obsidian%E5%9B%BE%E7%89%87/%E6%8A%B1%E5%9B%A2%E8%A1%8C%E6%83%85.png');
                section3Image.show();
                section3BaotuanContainer.addClass('hidden');
                
                // 标记抱团为已选中
                baotuanText.addClass('selected');
                
                // 更新策略卡片
                updateStrategyCards();
            };

            // 绑定多选框变化事件（仅用于section3）
            $(document).on('change', '#volumeAmplified, #indexTurningPoint', updateConditionMessage);
            
            // 初始化section3的图片显示
            $(document).ready(function() {
                setTimeout(function() {
                    updateConditionMessage();
                    updateStrategyCards(); // 确保策略卡片初始状态正确
                }, 100);
            });

            // 悬停显示卡片功能
            $(document).on('mouseenter', '.hover-trigger', function() {
                $(this).siblings('.hover-card').css({
                    'opacity': '1',
                    'visibility': 'visible',
                    'transform': 'translateX(-50%) translateY(-5px)'
                });
            });

            $(document).on('mouseleave', '.hover-trigger', function() {
                $(this).siblings('.hover-card').css({
                    'opacity': '0',
                    'visibility': 'hidden',
                    'transform': 'translateX(-50%) translateY(0px)'
                });
            });

            // 图片模态框功能
            window.openImageModal = function(src) {
                // 创建模态框
                const modal = $(`
                    <div id="imageModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                        <div style="position: relative; max-width: 90%; max-height: 90%; display: flex; align-items: center; justify-content: center;">
                            <img src="${src}" style="max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                            <div style="position: absolute; top: -40px; right: -40px; color: white; font-size: 30px; cursor: pointer; background: rgba(0,0,0,0.5); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;" onclick="closeImageModal()">×</div>
                        </div>
                    </div>
                `);
                
                $('body').append(modal);
                
                // 点击背景关闭
                modal.click(function(e) {
                    if (e.target === this) {
                        closeImageModal();
                    }
                });
                
                // ESC键关闭
                $(document).on('keydown.imageModal', function(e) {
                    if (e.key === 'Escape') {
                        closeImageModal();
                    }
                });
            };

            window.closeImageModal = function() {
                $('#imageModal').remove();
                $(document).off('keydown.imageModal');
            };
            
            // 市场指标和风格选择
            $('.option-item, .style-item').click(function() {
                // 在同组内互斥选择
                $(this).parent().find('.option-item, .style-item').removeClass('selected');
                $(this).addClass('selected');
            });
            
            // 初始化板块轮动图表
            function initSectorRotationChart() {
                const ctx = document.getElementById('sectorStatusChart').getContext('2d');
                
                // 清除可能存在的旧图表
                if (window.sectorChart) {
                    window.sectorChart.destroy();
                }
                
                // 获取当前日期和前5天
                const today = new Date();
                const dateLabels = [];
                
                for (let i = 6; i > 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const formattedDate = `${date.getMonth() + 1}/${date.getDate()}`;
                    dateLabels.push(formattedDate);
                }
                dateLabels.push('今日');
                
                // 模拟历史数据 - 实际应用中应从数据库或API获取
                // 检查是否有历史数据，如果没有则使用默认值
                let hasHistoricalData = false;
                
                // 根据选择的情绪阶段获取不同的数据集
                const selectedTheme = $('.mood-item.selected').data('theme');
                let datasets = [];
                
                if (selectedTheme === 'chaos') {
                    // 混沌期数据集
                    hasHistoricalData = true;
                    datasets = [
                        {
                            label: '科技板块',
                            data: [55, 62, 58, 65, 72, 68, 75],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: '消费板块',
                            data: [35, 32, 40, 45, 50, 55, 60],
                            borderColor: '#f97316',
                            backgroundColor: 'rgba(249, 115, 22, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: '医药板块',
                            data: [48, 45, 42, 38, 40, 45, 42],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: '周期板块',
                            data: [20, 25, 30, 35, 32, 28, 30],
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ];
                } else if (selectedTheme === 'rising') {
                    // 主升期数据集
                    hasHistoricalData = true;
                    datasets = [
                        {
                            label: '科技板块',
                            data: [68, 72, 78, 82, 88, 92, 95],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: '消费板块',
                            data: [45, 48, 52, 58, 65, 72, 78],
                            borderColor: '#f97316',
                            backgroundColor: 'rgba(249, 115, 22, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ];
                } else {
                    // 默认数据集
                    datasets = [
                        {
                            label: '科技板块',
                            data: [null, null, null, null, null, null, null],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: '消费板块',
                            data: [null, null, null, null, null, null, null],
                            borderColor: '#f97316',
                            backgroundColor: 'rgba(249, 115, 22, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ];
                }
                
                // 创建新图表
                window.sectorChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dateLabels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: '板块强度变化趋势',
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            },
                            legend: {
                                position: 'bottom'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: '强度指数'
                                }
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        },
                        elements: {
                            point: {
                                radius: 3,
                                hoverRadius: 5
                            }
                        }
                    }
                });
                
                // 如果没有历史数据，显示提示文本
                if (!hasHistoricalData && !selectedTheme) {
                    const noDataText = document.createElement('div');
                    noDataText.style.position = 'absolute';
                    noDataText.style.top = '50%';
                    noDataText.style.left = '50%';
                    noDataText.style.transform = 'translate(-50%, -50%)';
                    noDataText.style.color = 'var(--color-gray-500)';
                    noDataText.style.fontSize = '1.1rem';
                    noDataText.textContent = '请先选择情绪阶段查看板块数据';
                    
                    const chartContainer = document.getElementById('sectorStatusChart');
                    chartContainer.style.position = 'relative';
                    chartContainer.appendChild(noDataText);
                }
                
                // 初始化泳道背景颜色
                setTimeout(function() {
                    if (typeof assignLaneBackgroundColors === 'function') {
                        assignLaneBackgroundColors();
                        console.log('板块节奏页面：泳道背景颜色已初始化');
                    }
                }, 200);
            }
            
            // 交易记录添加与删除
            $('.add-record-btn').click(function() {
                const newRow = `
                    <div class="trading-record-row">
                        <div class="record-col"><input type="text" class="form-control" name="stock[]" placeholder="股票名称"></div>
                        <div class="record-col"><input type="text" class="form-control" name="buyPrice[]" placeholder="买入价"></div>
                        <div class="record-col"><input type="text" class="form-control" name="sellPrice[]" placeholder="卖出价"></div>
                        <div class="record-col"><input type="text" class="form-control" name="profit[]" placeholder="盈亏%"></div>
                        <div class="record-col"><button type="button" class="btn btn-outline remove-record"><i class="fas fa-trash-alt"></i></button></div>
                    </div>
                `;
                $('#tradingRecords').append(newRow);
            });
            
            // 使用事件委托监听删除按钮
            $(document).on('click', '.remove-record', function() {
                // 至少保留一行记录
                if ($('.trading-record-row').length > 1) {
                    $(this).closest('.trading-record-row').remove();
                }
            });
            
            // 情绪滑块
            $('#fearSlider').on('input', function() {
                const value = $(this).val();
                $('#emotionValue').text(value);
                
                // 根据值调整颜色
                if (value <= 3) {
                    $('#emotionValue').css('color', '#10b981'); // 绿色 - 恐惧
                } else if (value <= 7) {
                    $('#emotionValue').css('color', '#eab308'); // 黄色 - 均衡
                } else {
                    $('#emotionValue').css('color', '#ef4444'); // 红色 - 贪婪
                }
            });
            
            // 生成报告按钮
            $('#generateReportBtn, #finalGenerateBtn').click(function() {
                // 收集表单数据
                const formData = $('#reviewForm').serializeArray();
                
                // 基础验证
                const isMacroRiskFree = $('input[name="macroRiskFree"]').is(':checked');
                const isNonBreakingIndex = $('input[name="nonBreakingIndex"]').is(':checked');
                
                if (!isMacroRiskFree || !isNonBreakingIndex) {
                    alert('请先确认宏观大盘无风险！');
                    return;
                }
                
                const selectedMood = $('.mood-item.selected').data('mood');
                if (!selectedMood) {
                    alert('请选择当前的市场情绪阶段！');
                    return;
                }
                
                // 这里可以添加更多验证
                
                // 模拟生成报告过程
                alert('报告生成中，请稍候...');
                
                // 实际项目中，这里会提交数据到服务器进行处理
                setTimeout(function() {
                    alert('复盘报告已生成并保存！');
                }, 1500);
            });
            
            // 保存草稿按钮
            $('#saveBtn').click(function() {
                alert('草稿已保存！');
                // 实际项目中，这里会将表单数据保存到本地存储或服务器
            });
            
            // Function to update sidebar items' enabled/disabled state
            function updateSidebarLockState() {
                const isMacroRiskFreeChecked = $('input[name="macroRiskFree"]').is(':checked');
                const isNonBreakingIndexChecked = $('input[name="nonBreakingIndex"]').is(':checked');

                if (isMacroRiskFreeChecked && isNonBreakingIndexChecked) {
                    // Unlock other sections
                    $('.sidebar-item').each(function() {
                        const section = $(this).data('section');
                        if (section !== 'section1') {
                            $(this).removeClass('disabled');
                            $(this).css('pointer-events', 'auto');
                        }
                    });
                } else {
                    // Lock other sections
                    $('.sidebar-item').each(function() {
                        const section = $(this).data('section');
                        if (section !== 'section1') {
                            $(this).addClass('disabled');
                            $(this).css('pointer-events', 'none');
                        }
                    });
                    // If sections are locked, and current active section is one of the locked ones,
                    // switch to section1 (市场多空) as it contains the checkboxes.
                    const currentActiveSection = $('.sidebar-item.active').data('section');
                    if (currentActiveSection !== 'section1') {
                        $('.sidebar-item[data-section="' + currentActiveSection + '"]').removeClass('active');
                        $('.content-section#' + currentActiveSection).removeClass('active');
                        
                        $('.sidebar-item[data-section="section1"]').addClass('active');
                        $('#section1').addClass('active');
                        updateProgressBar(); // Ensure progress bar is updated
                    }
                }
            }

            // Checkbox change handler
            $('input[name="macroRiskFree"], input[name="nonBreakingIndex"]').change(function() {
                updateSidebarLockState();
            });
            
            // Initial lock state update on page load
            updateSidebarLockState();
            
            // 初始化策略内容显示
            $('.strategy-phase-content:first').addClass('active');
            
            // 处理策略标题和箭头点击弹出卡片
            $('.popup-trigger').click(function() {
                const popupId = $(this).data('popup-id');
                $('#' + popupId).css('display', 'flex');
            });
            
            // 关闭弹出卡片
            $('.strategy-popup-close').click(function() {
                $(this).closest('.strategy-popup').css('display', 'none');
            });
            
            // 点击弹出卡片外部关闭
            $('.strategy-popup').click(function(e) {
                if ($(e.target).hasClass('strategy-popup')) {
                    $(this).css('display', 'none');
                }
            });

            // 添加全局CSS样式，提供流畅过渡效果
            $('head').append(`
                <style>
                                         .strategy-option-card {
                        transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
                        overflow: hidden;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                        border-radius: 12px;
                        background: #ffffff;
                        border: 1px solid var(--color-gray-200);
                        position: relative;
                        transform-origin: center;
                    }
                    
                    .strategy-option-card:hover {
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                        transform: translateY(-2px);
                    }
                    
                    .strategy-option-header {
                        cursor: pointer;
                        font-weight: 600;
                        transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
                        background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
                        color: white;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        position: relative;
                        z-index: 2;
                        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                    }
                    
                    .strategy-option-header span {
                        transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
                    }
                    
                    .strategy-option-card-wrapper {
                        display: flex;
                        justify-content: center;
                        gap: 12px;
                        padding: 10px 0;
                    }
                    
                    .strategy-option-body {
                        padding: 1rem;
                        background-color: #fcfcfc;
                        border-radius: 0 0 12px 12px;
                        transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
                    }
                    
                    .card-collapsed {
                        width: 60px !important;
                        min-width: 60px !important;
                        max-width: 60px !important;
                        height: 180px !important;
                        margin: 0 8px !important;
                        background: linear-gradient(to bottom, rgba(255,255,255,0.05), rgba(255,255,255,0.1));
                    }
                    
                    .header-collapsed {
                        height: 180px;
                        padding: 0.5rem;
                        border-radius: 12px;
                        background: linear-gradient(to bottom, var(--color-primary), var(--color-primary-dark));
                        position: relative;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                    }
                    
                    .header-collapsed:before {
                        content: '';
                        position: absolute;
                        top: 8px;
                        left: 50%;
                        transform: translateX(-50%);
                        width: 16px;
                        height: 3px;
                        background-color: rgba(255, 255, 255, 0.6);
                        border-radius: 1.5px;
                    }
                    
                    .header-collapsed span {
                        font-size: 14px;
                        letter-spacing: 1px;
                        writing-mode: vertical-lr;
                        text-orientation: upright;
                        white-space: nowrap;
                        position: relative;
                        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                    
                    .card-expanded {
                        width: auto !important;
                        min-width: 180px !important;
                        max-width: 200px !important;
                        height: auto !important;
                        margin: 0 4px !important;
                        flex: 1;
                        z-index: 10;
                        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
                        transform: translateY(-3px);
                    }
                    
                    .header-expanded {
                        writing-mode: horizontal-tb;
                        text-orientation: mixed;
                        padding: 0.75rem;
                        height: auto;
                        border-radius: 12px 12px 0 0;
                        background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
                    }
                    
                    .header-expanded span {
                        font-weight: 600;
                    }
                    
                    .strategy-option-body {
                        padding: 1rem;
                        opacity: 0;
                        transform: translateY(10px);
                        transition: opacity 0.3s ease, transform 0.3s ease;
                    }
                    
                    .card-expanded .strategy-option-body {
                        opacity: 1;
                        transform: translateY(0);
                    }
                    
            /* 板块节奏专用样式 */
            .controls {
                display: flex;
                flex-direction: column;
                gap: 5px;
                margin-bottom: 15px;
                align-items: flex-start;
            }
            
            .checkbox-group {
                display: flex;
                align-items: center;
                gap: 8px;
                margin-bottom: 8px;
            }
            
            .checkbox-group input[type="checkbox"] {
                width: 18px;
                height: 18px;
                cursor: pointer;
            }
            
            .checkbox-group label {
                font-size: 16px;
                cursor: pointer;
                color: #ffffff;
            }
            
            .content-area {
                display: flex;
                align-items: center;
                gap: 20px;
                min-height: 120px;
            }
            
            .image-container {
                flex: 1;
                text-align: center;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            
            .image-container img {
                max-width: 100%;
                height: 100px;
                object-fit: contain;
                border: none;
            }
            
            .side-content {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 10px;
                min-width: 80px;
            }
            
            .baotuan-text {
                font-size: 14px;
                color: #ccc;
                cursor: pointer;
                position: relative;
                padding: 5px 10px;
                border-radius: 4px;
                transition: background-color 0.3s;
            }
            
            .baotuan-text:hover {
                background-color: #333;
            }
            
            .tooltip {
                position: absolute;
                bottom: 100%;
                left: 50%;
                transform: translateX(-50%);
                background: #333;
                color: white;
                padding: 8px 12px;
                border-radius: 4px;
                font-size: 12px;
                white-space: nowrap;
                opacity: 0;
                visibility: hidden;
                transition: opacity 0.3s, visibility 0.3s;
                z-index: 1000;
                margin-bottom: 5px;
            }
            
            .tooltip::after {
                content: '';
                position: absolute;
                top: 100%;
                left: 50%;
                transform: translateX(-50%);
                border: 5px solid transparent;
                border-top-color: #333;
            }
            
            .baotuan-text:hover .tooltip {
                opacity: 1;
                visibility: visible;
            }
            
            .hidden {
                display: none;
            }
            
            /* 历史记录弹窗样式 */
            .history-modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 9999;
                display: none;
                justify-content: center;
                align-items: center;
            }
            

            
            .history-content-modal {
                background-color: white;
                border-radius: 12px;
                padding: 30px;
                max-width: 800px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
                animation: modalSlideIn 0.3s ease-out;
            }
            
            @keyframes modalSlideIn {
                from {
                    opacity: 0;
                    transform: translateY(-50px) scale(0.9);
                }
                to {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
            }
            
            .modal-header {
                display: flex;
                justify-content: between;
                align-items: center;
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 2px solid var(--color-gray-200);
            }
            
            .modal-title {
                font-size: 1.1rem;
                font-weight: 600;
                color: var(--color-gray-900);
                margin: 0;
            }
            
            .modal-close {
                background: none;
                border: none;
                font-size: 1.5rem;
                color: var(--color-gray-500);
                cursor: pointer;
                margin-left: auto;
                padding: 5px;
                border-radius: 4px;
                transition: all 0.2s ease;
            }
            
            .modal-close:hover {
                background-color: var(--color-gray-100);
                color: var(--color-gray-700);
            }
            

            
            .modal-buttons {
                display: flex;
                gap: 10px;
                justify-content: flex-end;
            }
            
            .btn-modal {
                padding: 10px 20px;
                border: none;
                border-radius: 6px;
                font-size: 0.9rem;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s ease;
            }
            
            .btn-modal-primary {
                background-color: var(--color-primary);
                color: white;
            }
            
            .btn-modal-primary:hover {
                background-color: var(--color-primary-hover);
                transform: translateY(-1px);
            }
            
            .btn-modal-secondary {
                background-color: var(--color-gray-200);
                color: var(--color-gray-700);
            }
            
            .btn-modal-secondary:hover {
                background-color: var(--color-gray-300);
            }
            
            .history-lane-item {
                margin-bottom: 15px;
                padding: 0;
                background-color: transparent;
                border-radius: 0;
                border-left: none;
            }
            
            .history-lane-title {
                font-size: 1rem;
                font-weight: 600;
                margin-bottom: 8px;
                display: flex;
                align-items: center;
                padding: 8px 12px;
                border-radius: 6px;
                margin-bottom: 8px;
            }
            
            .history-lane-title.bg-primary {
                background-color: rgba(var(--color-primary-rgb), 0.1);
                color: var(--color-primary);
            }
            
            .history-lane-title.bg-success {
                background-color: rgba(16, 185, 129, 0.1);
                color: #10b981;
            }
            
            .history-lane-title.bg-warning {
                background-color: rgba(245, 158, 11, 0.1);
                color: #f59e0b;
            }
            
            .history-lane-title.bg-info {
                background-color: rgba(59, 130, 246, 0.1);
                color: #3b82f6;
            }
            
            .history-lane-title.bg-purple {
                background-color: rgba(139, 92, 246, 0.1);
                color: #8b5cf6;
            }
            
            .history-lane-title i {
                margin-right: 8px;
                font-size: 0.9rem;
            }
            
            .history-lane-content {
                color: var(--color-gray-700);
                line-height: 1.6;
                white-space: pre-wrap;
                padding: 12px 16px;
                background-color: white;
                border-radius: 8px;
                border: 1px solid var(--color-gray-200);
                margin-left: 12px;
                font-size: 0.95rem;
            }
            
            .no-history-message {
                text-align: center;
                color: var(--color-gray-500);
                font-style: italic;
                padding: 40px 20px;
            }
            
            .date-display:hover {
                background-color: var(--color-gray-100) !important;
                border-color: var(--color-primary) !important;
            }
            
            .btn-nav-popup:hover {
                background-color: var(--color-primary-hover) !important;
                transform: translateY(-1px);
            }
            
            .header-right {
                margin-left: auto;
            }
        </style>
            `);
            
            // 策略卡片折叠功能 - 点击标题折叠或展开
            
            // 初始化时全部折叠
            $('.strategy-option-card').each(function() {
                const card = $(this);
                const body = card.find('.strategy-option-body');
                const header = card.find('.strategy-option-header');
                const title = header.find('span').text();
                
                // 移除所有折叠按钮
                card.find('.collapse-btn').remove();
                
                // 默认折叠状态
                body.css('display', 'none');
                header.addClass('header-collapsed');
                card.addClass('card-collapsed');
                
                // 用标题来显示当前折叠状态
                header.attr('title', '点击展开' + title);
            });
            
            // 点击标题折叠或展开
            $('.strategy-option-header').click(function(e) {
                // 阻止默认行为和事件冒泡，防止页面刷新
                e.preventDefault();
                e.stopPropagation();
                
                const header = $(this);
                const card = header.closest('.strategy-option-card');
                const body = card.find('.strategy-option-body');
                const title = header.find('span').text();
                
                if (body.is(':visible')) {
                    // 折叠卡片 - 使用CSS类实现平滑过渡
                    header.attr('title', '点击展开' + title);
                    
                    // 先改变类，确保过渡效果
                    card.removeClass('card-expanded');
                    header.removeClass('header-expanded');
                    
                    // 使用延迟来创建顺序动画
                    setTimeout(function() {
                        header.addClass('header-collapsed');
                        card.addClass('card-collapsed');
                    }, 10);
                    
                    // 等待过渡完成后隐藏内容
                    setTimeout(function() {
                        body.css('display', 'none');
                    }, 350);
                } else {
                    // 动画展开卡片
                    header.attr('title', '点击折叠' + title);
                    
                    // 先把内容设为可见但透明
                    body.css({
                        'display': 'block', 
                        'opacity': '0',
                        'transform': 'translateY(15px)'
                    });
                    
                    // 先转换header样式，开始过渡
                    header.removeClass('header-collapsed');
                    card.removeClass('card-collapsed');
                    
                    // 短延迟后执行展开动画
                    setTimeout(function() {
                        header.addClass('header-expanded');
                        card.addClass('card-expanded');
                        
                        // 延迟展示内容，创建连贯的动画序列
                        setTimeout(function() {
                            body.css({
                                'opacity': '1',
                                'transform': 'translateY(0)'
                            });
                        }, 150);
                    }, 50);
                }
            });
            
            // 监听情绪阶段变化
            $(document).on('moodThemeChanged', function(e, theme) {
                // 情绪阶段变化时，更新策略卡片（包括标题）
                setTimeout(function() {
                    updateStrategyCards();
                }, 100);
            });
            
            // 板块运行天数进度条事件处理
            $('input[type="range"]').on('input change', function() {
                const value = $(this).val();
                $(this).closest('div').find('.days-value').text(value);
            });
            
            // 问题逐步显示功能
            $('.question-input').on('change input', function() {
                const input = $(this);
                const value = input.val();
                
                // 确认输入有值
                if (value && value.trim() !== '' && value !== '请选择...') {
                    const nextStep = input.data('next');
                    const parent = input.data('parent') || '';
                    
                    // 显示下一个问题
                    if (nextStep) {
                        const nextStepSelector = parent ? 
                            `.${parent}-${nextStep}` : 
                            `.step-${nextStep}`;
                        $(nextStepSelector).show();
                    }
                    
                    // 给卡片上的折叠按钮添加已填写标识
                    const card = input.closest('.strategy-option-card');
                    card.find('.collapse-btn').addClass('has-content');
                }
            });
            
            // 处理是否在量能板块的选择
            $('.strength-choice').on('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const btn = $(this);
                const value = btn.data('value');
                const nextStep = btn.data('next');
                
                // 高亮被选中的按钮
                btn.siblings().removeClass('btn-primary').addClass('btn-outline');
                btn.removeClass('btn-outline').addClass('btn-primary');
                
                // 处理特殊逻辑，当第一个策略卡片中选择"是否在量能板块"为"是"时，不显示"放弃此策略"
                const isFirstCard = btn.closest('.strategy-option-card').is(':first-child');
                if (value === 'yes' && isFirstCard) {
                    $('.step-abandon').hide();
                } else if (value === 'no' && isFirstCard) {
                    $('.step-abandon').show();
                }
                
                // 显示下一步内容
                if (nextStep) {
                    const parent = btn.data('parent') || '';
                    const nextStepSelector = parent ? 
                        `.${parent}-${nextStep}` : 
                        `.step-${nextStep}`;
                    $(nextStepSelector).show();
                }
                
                // 给卡片上的折叠按钮添加已填写标识
                const card = btn.closest('.strategy-option-card');
                card.find('.collapse-btn').addClass('has-content');
            });

            // Checkbox change handler for macro risk, including auto-navigation
            $('input[name="macroRiskFree"], input[name="nonBreakingIndex"]').change(function() {
                updateSidebarLockState(); // This correctly enables/disables other sidebar items

                const isMacroRiskFreeChecked = $('input[name="macroRiskFree"]').is(':checked');
                const isNonBreakingIndexChecked = $('input[name="nonBreakingIndex"]').is(':checked');
                const currentSectionId = $('.content-section.active').attr('id');

                if (isMacroRiskFreeChecked && isNonBreakingIndexChecked && currentSectionId === 'section1') {
                    // Both checked and we are currently on section1, so navigate to section2
                    const targetSection = 'section2';
                    // Ensure section2 is not disabled by updateSidebarLockState before navigating
                    if (!$(`.sidebar-item[data-section="${targetSection}"]`).hasClass('disabled')) {
                        // Deactivate current (section1)
                        $('.sidebar-item[data-section="section1"]').removeClass('active');
                        $('#section1').removeClass('active');

                        // Activate target (section2)
                        $(`.sidebar-item[data-section="${targetSection}"]`).addClass('active');
                        $('#' + targetSection).addClass('active');
                        updateProgressBar();
                        
                        // Play sound for mood phase if applicable (mimicking direct navigation to section2)
                        // This part might need refinement if section2 has specific sounds on activation
                        // For now, we assume no sound on auto-navigate, or it's handled by mood selection itself.
                    }
                }
            });
        });

        // 更新板块节奏页面内容
        function updateSectorContent(theme) {
            // 隐藏所有板块节奏内容
            $('#chaosContent, #risingContent, #otherMoodContent').hide();
            
            // 根据情绪阶段显示相应内容
            switch(theme) {
                case 'chaos': // 混沌期
                    $('#chaosContent').show();
                    break;
                case 'rising': // 主升期
                    $('#risingContent').show();
                    break;
                default: // 其他情绪阶段
                    $('#otherMoodContent').show();
                    break;
            }
        }
    </script>
    
    <script>
            // 泳道图功能
    $(function() {
        let laneCounter = 1; // Initialize lane counter
        const stateColors = [
            '#2c6e49', // 大分歧 - 深青苔绿
            '#4c956c', // 中分歧 - 松绿
            '#9ec1a3', // 小分歧 - 浅草绿
            '#f9b5ac', // 一致 - 浅珊瑚红
            '#e07a5f'  // 高潮 - 砖红
        ]; 
        const defaultColor = '#d1d5db'; // 默认淡灰色
        let previousReviewDate = null; // Variable to store the last selected review date
        const stateLabels = ['大分歧', '中分歧', '小分歧', '一致', '高潮', '未选择'];

        // --- localStorage Helper Functions ---
        function saveState(laneId, dateString, state) {
            localStorage.setItem(`swimlaneState-${laneId}-${dateString}`, state);
        }

        function loadState(laneId, dateString) {
            return localStorage.getItem(`swimlaneState-${laneId}-${dateString}`);
        }

        function saveLaneData(lanesArray) {
            localStorage.setItem('swimlaneLanes', JSON.stringify(lanesArray));
        }

        function loadLaneData() {
            const data = localStorage.getItem('swimlaneLanes');
            return data ? JSON.parse(data) : [];
        }

        // 保存板块星级
        function saveLaneRating(laneId, rating) {
            localStorage.setItem(`swimlaneRating-${laneId}`, rating);
        }

        // 加载板块星级
        function loadLaneRating(laneId) {
            const rating = localStorage.getItem(`swimlaneRating-${laneId}`);
            return rating !== null ? parseInt(rating) : 0;
        }

        function getCurrentReviewDateStr() {
            return $('#reviewDate').val();
        }

        function getMaxLaneIdNumber() {
            const lanes = loadLaneData();
            let maxIdNum = 0;
            lanes.forEach(lane => {
                if (lane.id && lane.id.startsWith('lane')) {
                    const numPart = parseInt(lane.id.substring(4));
                    if (!isNaN(numPart) && numPart > maxIdNum) {
                        maxIdNum = numPart;
                    }
                }
            });
            return maxIdNum;
        }

        // 检查泳道是否有选中状态（非默认状态）
        function hasSelectedState(laneElement) {
            let hasSelected = false;
            laneElement.find('.state-dot').each(function() {
                const state = parseInt($(this).data('state'));
                // -1 是默认状态，0-4 是有效选中状态
                if (state >= 0 && state <= 4) {
                    hasSelected = true;
                    return false; // 跳出循环
                }
            });
            return hasSelected;
        }

        // 更新泳道背景颜色
        function updateLaneBackgroundColor(laneElement) {
            const hasSelected = hasSelectedState(laneElement);
            
            if (hasSelected) {
                laneElement.addClass('has-selected-state');
            } else {
                laneElement.removeClass('has-selected-state');
            }
        }

        // 为所有泳道分配颜色类（确保连续5行颜色不重复）
        function assignLaneBackgroundColors() {
            const lanes = $('#swimLanesContent .swim-lane');
            
            lanes.each(function(index) {
                const lane = $(this);
                // 移除之前的颜色类和状态类
                lane.removeClass('lane-bg-1 lane-bg-2 lane-bg-3 lane-bg-4 lane-bg-5 has-selected-state');
                
                // 计算颜色索引（1-5循环，确保连续5行不重复）
                const colorIndex = (index % 5) + 1;
                lane.addClass(`lane-bg-${colorIndex}`);
                
                // 更新背景颜色状态
                updateLaneBackgroundColor(lane);
            });
            
            console.log('泳道背景颜色分配完成，共', lanes.length, '行');
        }

        // 汇总查看功能
        let currentViewDate = new Date().toISOString().split('T')[0]; // 当前查看的日期
        
        // 打开汇总
        function openSummaryView() {
            // 设置当前日期为今天
            currentViewDate = new Date().toISOString().split('T')[0];
            // 生成内容并显示
            generateSummaryContent(currentViewDate);
            $('#historyContentModal').css('display', 'flex');
        }
        
        // 关闭汇总弹窗
        function closeHistoryContent() {
            $('#historyContentModal').css('display', 'none');
        }
        
        // 日期导航
        function navigateDate(direction) {
            console.log('导航日期:', direction, '当前日期:', currentViewDate);
            const currentDate = new Date(currentViewDate);
            currentDate.setDate(currentDate.getDate() + direction);
            currentViewDate = currentDate.toISOString().split('T')[0];
            console.log('新日期:', currentViewDate);
            generateSummaryContent(currentViewDate);
            // 隐藏弹窗
            hideDatePopup();
        }
        
        // 跳转到指定日期
        function jumpToDate() {
            const selectedDate = document.getElementById('datePickerInput').value;
            if (selectedDate) {
                currentViewDate = selectedDate;
                generateSummaryContent(currentViewDate);
                hideDatePopup();
            }
        }
        
        // 显示日期弹窗
        function showDatePopup() {
            const popup = document.querySelector('.date-navigation-popup');
            popup.style.display = 'block';
            // 设置日期选择器的当前值
            document.getElementById('datePickerInput').value = currentViewDate;
        }
        
        // 隐藏日期弹窗
        function hideDatePopup() {
            const popup = document.querySelector('.date-navigation-popup');
            popup.style.display = 'none';
        }
        
        // 生成汇总内容
        function generateSummaryContent(dateString) {
            const lanes = loadLaneData();
            let summaryHtml = '';
            let hasAnyContent = false;
            
            // 设置弹窗标题和日期显示
            const date = new Date(dateString);
            const formattedDate = `${date.getMonth() + 1}月${date.getDate()}日`;
            $('#historyModalTitle').text(`汇总`);
            $('#currentDateDisplay').text(formattedDate);
            
            // 定义颜色主题数组
            const colorThemes = ['bg-primary', 'bg-success', 'bg-warning', 'bg-info', 'bg-purple'];
            let colorIndex = 0;
            
            // 遍历所有泳道，获取该日期的"今天"内容
            lanes.forEach(lane => {
                const laneId = lane.id;
                const laneName = lane.name;
                
                // 获取该日期的"今天"内容
                const todayNoteKey = `swimlaneToday-${laneId}-${dateString}`;
                const todayContent = localStorage.getItem(todayNoteKey);
                
                if (todayContent && todayContent.trim() !== '') {
                    hasAnyContent = true;
                    const iconClass = lane.name === '大盘' ? 'fa-chart-line' : 'fa-layer-group';
                    const colorTheme = colorThemes[colorIndex % colorThemes.length];
                    summaryHtml += `
                        <div class="history-lane-item">
                            <div class="history-lane-title ${colorTheme}">
                                <i class="fas ${iconClass}"></i>
                                ${laneName}
                            </div>
                            <div class="history-lane-content">${todayContent}</div>
                        </div>
                    `;
                    colorIndex++;
                }
            });
            
            // 如果没有内容，显示提示消息
            if (!hasAnyContent) {
                summaryHtml = `
                    <div class="no-history-message">
                        <i class="fas fa-calendar-times" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                        <p>该日期没有记录任何内容</p>
                    </div>
                `;
            }
            
            $('#historyContentBody').html(summaryHtml);
        }
        
        // 汇总按钮点击事件
        $('#historyViewBtn').click(function() {
            openSummaryView();
        });
        
        let hideTimeout;
        
        // 日期显示悬停事件
        $(document).on('mouseenter', '.date-display', function() {
            clearTimeout(hideTimeout);
            showDatePopup();
        });
        
        // 日期弹窗悬停事件 - 保持弹窗显示
        $(document).on('mouseenter', '.date-navigation-popup', function() {
            clearTimeout(hideTimeout);
        });
        
        // 鼠标离开日期显示区域时隐藏弹窗
        $(document).on('mouseleave', '.date-display-container', function() {
            hideTimeout = setTimeout(function() {
                hideDatePopup();
            }, 300);
        });
        
        // 鼠标离开弹窗时隐藏
        $(document).on('mouseleave', '.date-navigation-popup', function() {
            hideTimeout = setTimeout(function() {
                hideDatePopup();
            }, 200);
        });
        
        // 点击弹窗外部关闭
        $('.history-modal').click(function(e) {
            if (e.target === this) {
                $(this).css('display', 'none');
            }
        });
        
        // ESC键关闭弹窗
        $(document).keydown(function(e) {
            if (e.keyCode === 27) { // ESC键
                if ($('#historyContentModal').is(':visible')) {
                    closeHistoryContent();
                }
            }
        });
        
        // 将函数挂载到全局，供HTML onclick使用
        window.openSummaryView = openSummaryView;
        window.closeHistoryContent = closeHistoryContent;
        window.navigateDate = navigateDate;
        window.jumpToDate = jumpToDate;
        window.showDatePopup = showDatePopup;
        window.hideDatePopup = hideDatePopup;


        // 展开/折叠今日内容按钮点击事件
        $('#expandTodayBtn').click(function() {
            // 判断当前是否已展开
            const isExpanded = $('#swimLaneContainer').hasClass('expanded');
            
            if (isExpanded) {
                // 如果已展开，则折叠
                toggleExpandedView(false);
                $(this).html('<i class="fas fa-expand"></i> 展|折');
            } else {
                // 如果未展开，则展开
                toggleExpandedView(true);
                $(this).html('<i class="fas fa-compress"></i> 展|折');
            }
        });

        // 当日盘面展开/折叠按钮点击事件
        $('#expandMarketBtn').click(function() {
            const expandedContent = $('#expandedMarketContent');
            const isExpanded = expandedContent.is(':visible');
            
            if (isExpanded) {
                // 如果已展开，则折叠
                expandedContent.slideUp(300);
                $(this).html('<i class="fas fa-expand"></i> 展开');
            } else {
                // 如果未展开，则展开并加载数据
                expandedContent.slideDown(300);
                $(this).html('<i class="fas fa-compress"></i> 收起');
                loadMarketLiveData();
            }
        });

                // 加载当日盘面实时数据
        window.loadMarketLiveData = function() {
            const container = $('#expandedMarketContent');
            
            // 显示加载状态
            container.html('<div class="market-live-loading"><i class="fas fa-spinner fa-spin"></i> 正在加载盘面回顾数据...</div>');
            
            // 调用东方财富的市场资讯API
            const apiUrl = 'https://np-anotice-stock.eastmoney.com/api/content/ann';
            const params = new URLSearchParams({
                'cb': 'jQuery',
                'client_source': 'web',
                'page_index': '1',
                'page_size': '5',
                'sr': '-1',
                'market_type': [],
                'f_node': '0',
                's_node': '0'
            });
            
            // 尝试多种方式获取数据
            Promise.race([
                // 方法1: 直接请求
                fetch(`${apiUrl}?${params.toString()}`, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Accept': 'application/json, text/plain, */*'
                    }
                }).then(r => r.json()),
                
                // 方法2: 使用CORS代理
                fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(apiUrl + '?' + params.toString())}`)
                    .then(r => r.json()),
                
                // 方法3: 超时后显示本地数据
                new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('timeout')), 5000)
                )
            ])
            .then(data => {
                // 处理返回的数据
                processMarketData(data);
            })
            .catch(error => {
                console.error('API请求失败:', error);
                // 显示友好的错误提示
                const container = $('#expandedMarketContent');
                container.html(`
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <i class="fas fa-exclamation-circle" style="font-size: 2rem; color: #f59e0b;"></i>
                        <p style="margin: 15px 0;">暂时无法获取实时市场数据</p>
                        <p style="font-size: 0.9rem; color: #999;">
                            建议访问东方财富、同花顺等网站查看实时行情
                        </p>
                    </div>
                `);
            });
        }
        
        // 处理市场数据
        function processMarketData(apiData) {
            try {
                const marketData = {
                    title: '市场盘面回顾',
                    last_updated: new Date().toLocaleString('zh-CN'),
                    data_source: '东方财富',
                    summary: '市场数据实时更新中...',
                    sector_highlights: [],
                    hot_stocks: [],
                    market_sentiment: '震荡',
                    content: ''
                };
                
                // 从API数据中提取信息
                if (apiData && apiData.data && apiData.data.list) {
                    const newsList = apiData.data.list.slice(0, 3);
                    marketData.content = newsList.map(item => 
                        `【${item.title}】\n${item.summary || '暂无详情'}\n时间: ${item.showtime || ''}`
                    ).join('\n\n');
                }
                
                renderMarketLiveData(marketData);
            } catch (error) {
                console.error('处理市场数据失败:', error);
                const container = $('#expandedMarketContent');
                container.html(`
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <i class="fas fa-exclamation-circle" style="font-size: 2rem; color: #f59e0b;"></i>
                        <p style="margin: 15px 0;">数据处理失败</p>
                        <p style="font-size: 0.9rem; color: #999;">请稍后重试</p>
                    </div>
                `);
            }
        }
        
        // 渲染基础市场数据到 basicMarketContent
        function renderBasicMarketData(data) {
            const container = $('#basicMarketContent');
            
            if (!data || !data.content) {
                container.html(`
                    <div style="text-align: center; padding: 20px; color: #999;">
                        <i class="fas fa-info-circle"></i> 
                        <p>暂无今日盘面数据</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">
                            数据来源：东方财富 | 更新时间：${new Date().toLocaleString('zh-CN')}
                        </p>
                    </div>
                `);
                return;
            }
            
            let html = '';
            
            // 添加摘要
            if (data.summary) {
                html += `<p style="line-height: 1.6; margin-bottom: 15px; color: #333;">${data.summary}</p>`;
            } else if (data.content) {
                // 如果有content但没有summary，从content中提取前100字作为摘要
                const summary = data.content.substring(0, 100) + '...';
                html += `<p style="line-height: 1.6; margin-bottom: 15px; color: #333;">${summary}</p>`;
            }
            
            // 添加完整内容（格式化）
            if (data.content) {
                html += `<div style="line-height: 1.8; color: #333; white-space: pre-wrap;">${data.content}</div>`;
            }
            
            // 添加数据来源和更新时间
            html += `
                <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #e5e7eb; font-size: 0.85rem; color: #999;">
                    <i class="fas fa-clock"></i> 更新时间：${data.last_updated || new Date().toLocaleString('zh-CN')} | 
                    <i class="fas fa-database"></i> 数据来源：${data.data_source || '东方财富'}
                </div>
            `;
            
            container.html(html);
        }
        
        // 加载基础市场数据（页面加载时调用）
        function loadBasicMarketData() {
            const container = $('#basicMarketContent');
            
            // 调用东方财富的市场资讯API
            const apiUrl = 'https://np-anotice-stock.eastmoney.com/api/content/ann';
            const params = new URLSearchParams({
                'cb': 'jQuery',
                'client_source': 'web',
                'page_index': '1',
                'page_size': '3',
                'sr': '-1',
                'market_type': [],
                'f_node': '0',
                's_node': '0'
            });
            
            // 设置超时时间
            const timeout = 3000; // 3秒超时
            
            Promise.race([
                fetch(`${apiUrl}?${params.toString()}`, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {'Accept': 'application/json'}
                }).then(r => r.json()),
                new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), timeout))
            ])
            .then(apiData => {
                console.log('📊 API数据获取成功:', apiData);
                const marketData = {
                    title: '市场盘面回顾',
                    last_updated: new Date().toLocaleString('zh-CN'),
                    data_source: '东方财富',
                    summary: '',
                    content: ''
                };
                
                // 从API数据中提取信息
                if (apiData && apiData.data && apiData.data.list) {
                    const newsList = apiData.data.list.slice(0, 3);
                    marketData.summary = newsList[0]?.title || '今日市场资讯';
                    marketData.content = newsList.map(item => 
                        `【${item.title || '市场动态'}】\n${item.summary || item.content || '暂无详情'}\n`
                    ).join('\n');
                }
                
                renderBasicMarketData(marketData);
            })
            .catch(error => {
                console.log('⚠️ API请求失败，显示默认提示:', error.message);
                renderBasicMarketData({
                    title: '市场盘面回顾',
                    last_updated: new Date().toLocaleString('zh-CN'),
                    data_source: '本地',
                    summary: '今日市场数据加载中...',
                    content: '由于网络原因，暂时无法获取实时市场数据。\n\n建议：\n1. 点击右侧"展开"按钮查看更多详情\n2. 或稍后刷新页面重试\n3. 也可以访问东方财富、同花顺等网站查看实时行情'
                });
            });
        }
        
        // 尝试直接请求
        function tryDirectRequest(originalApiUrl, params, container, corsProxies, proxyIndex) {
            const fullUrl = `${originalApiUrl}?${params.toString()}`;
            
            // 先尝试直接请求
            if (proxyIndex === 0) {
                console.log('尝试直接请求API...');
                fetch(fullUrl, {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'omit',
                    headers: {
                        'Accept': 'application/json, text/plain, */*',
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP错误: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('直接请求成功，数据条目数量:', data.List ? data.List.length : 0);
                    renderMarketLiveData(data);
                })
                .catch(error => {
                    console.log('直接请求失败，尝试代理方案:', error.message);
                    tryProxyRequest(originalApiUrl, params, container, corsProxies, 0);
                });
            } else {
                tryProxyRequest(originalApiUrl, params, container, corsProxies, proxyIndex);
            }
        }
        
        // 尝试代理请求
        function tryProxyRequest(originalApiUrl, params, container, corsProxies, proxyIndex) {
            if (proxyIndex >= corsProxies.length) {
                // 所有代理都失败了，尝试XMLHttpRequest方案
                tryXMLHttpRequest(originalApiUrl, params, container);
                return;
            }
            
            const proxy = corsProxies[proxyIndex];
            const fullUrl = `${originalApiUrl}?${params.toString()}`;
            const proxyUrl = proxy + encodeURIComponent(fullUrl);
            
            console.log(`尝试代理 ${proxyIndex + 1}/${corsProxies.length}: ${proxy}`);
            
            fetch(proxyUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json, text/plain, */*'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`代理响应错误: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(`代理 ${proxyIndex + 1} 请求成功，数据条目数量:`, data.List ? data.List.length : 0);
                renderMarketLiveData(data);
            })
            .catch(error => {
                console.log(`代理 ${proxyIndex + 1} 失败:`, error.message);
                // 尝试下一个代理
                setTimeout(() => {
                    tryProxyRequest(originalApiUrl, params, container, corsProxies, proxyIndex + 1);
                }, 500);
            });
        }
        
        // XMLHttpRequest备用方案
        function tryXMLHttpRequest(originalApiUrl, params, container) {
            console.log('尝试XMLHttpRequest备用方案...');
            
            const xhr = new XMLHttpRequest();
            const fullUrl = `${originalApiUrl}?${params.toString()}`;
            
            xhr.open('GET', fullUrl, true);
            xhr.setRequestHeader('Accept', 'application/json, text/plain, */*');
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            const data = JSON.parse(xhr.responseText);
                            console.log('XMLHttpRequest成功，数据条目数量:', data.List ? data.List.length : 0);
                            renderMarketLiveData(data);
                        } catch (e) {
                            console.error('JSON解析失败:', e);
                            showCorsErrorMessage(container);
                        }
                    } else {
                        console.error('XMLHttpRequest失败，状态码:', xhr.status);
                        showCorsErrorMessage(container);
                    }
                }
            };
            
            xhr.onerror = function() {
                console.error('XMLHttpRequest网络错误');
                showCorsErrorMessage(container);
            };
            
            try {
                xhr.send();
            } catch (error) {
                console.error('XMLHttpRequest发送失败:', error);
                showCorsErrorMessage(container);
            }
        }
        

        
        // 显示CORS错误信息
        function showCorsErrorMessage(container) {
            container.html(`
                <div style="text-align: center; padding: 20px; color: #e74c3c;">
                    <i class="fas fa-exclamation-triangle"></i> 
                    <p>无法获取实时数据: 所有请求方案均失败</p>
                    <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                        已尝试：直接请求 → 5个CORS代理 → XMLHttpRequest
                    </p>
                    <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: left;">
                        <h6 style="color: #5da39d; margin-bottom: 10px;">解决方案（任选一种）：</h6>
                        <div style="color: #666; font-size: 0.9rem; line-height: 1.6;">
                            <div style="background-color: #e8f5e8; padding: 10px; border-radius: 6px; margin-bottom: 15px; border-left: 3px solid #10b981;">
                                <p style="margin: 0; color: #0d6933;"><strong>🥇 方案一：本地代理服务器（最佳）</strong></p>
                                <ol style="margin: 8px 0 0 20px; color: #0d6933;">
                                    <li>双击运行 <code style="background: #d4edda; padding: 1px 4px;">启动代理服务器.bat</code></li>
                                    <li>等待"代理服务器启动成功"提示</li>
                                    <li>刷新此页面，重新点击"展开"</li>
                                </ol>
                            </div>
                            
                            <p><strong>🥈 方案二：浏览器扩展</strong></p>
                            <ul style="margin: 5px 0 15px 20px;">
                                <li>Chrome: <a href="https://chrome.google.com/webstore/detail/cors-unblock/lfhmikememgdcahcdlaciloancbhjino" target="_blank" style="color: #5da39d;">CORS Unblock</a></li>
                                <li>Edge: <a href="https://microsoftedge.microsoft.com/addons/detail/cors-unblock/hkjklmhkbkdhlgnnfbbcihcajofmjgbh" target="_blank" style="color: #5da39d;">CORS Unblock</a></li>
                            </ul>
                            
                            <p><strong>🥉 方案三：Chrome启动参数</strong></p>
                            <div style="background: #f0f0f0; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 0.85rem; margin: 5px 0;">
                                chrome.exe --disable-web-security --user-data-dir="%TEMP%\\chrome_temp"
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="loadMarketLiveData()" class="btn btn-outline">
                            <i class="fas fa-redo"></i> 重试
                        </button>
                        <button onclick="showDemoData()" class="btn btn-primary">
                            <i class="fas fa-eye"></i> 查看演示数据
                        </button>
                    </div>
                </div>
            `);
        }
        
        // 显示演示数据
        function showDemoData() {
            const demoData = {
                List: [
                    {
                        ID: "12345",
                        Time: Math.floor(Date.now() / 1000) - 3600,
                        Comment: "市场今日震荡上行，医药板块表现强势，建议关注相关龙头股机会。量能放大明显，短线情绪升温。",
                        UserName: "市场分析师",
                        PlateName: "医药生物",
                        PlateZDF: 3.45,
                        Stock: [
                            ["000001", "平安银行", 2.34],
                            ["000002", "万科A", -1.23],
                            ["600036", "招商银行", 1.67]
                        ]
                    },
                    {
                        ID: "12346", 
                        Time: Math.floor(Date.now() / 1000) - 1800,
                        Comment: "午后资金流入科技股，创业板指数反弹明显。建议关注AI、新能源等主题机会。",
                        UserName: "投资顾问",
                        PlateName: "人工智能",
                        PlateZDF: 5.67,
                        Stock: [
                            ["300750", "宁德时代", 4.56],
                            ["002415", "海康威视", 2.89]
                        ]
                    }
                ]
            };
            
            console.log('显示演示数据');
            renderMarketLiveData(demoData);
        }

        // Unicode解码函数
        function decodeUnicodeString(str) {
            try {
                // 尝试解码unicode转义序列
                return str.replace(/\\u[\dA-F]{4}/gi, function (match) {
                    return String.fromCharCode(parseInt(match.replace(/\\u/g, ''), 16));
                });
            } catch (e) {
                return str;
            }
        }

        // 渲染市场实时数据
        function renderMarketLiveData(data) {
            const container = $('#expandedMarketContent');
            
            if (!data) {
                container.html('<div style="text-align: center; padding: 20px; color: #666;">暂无数据</div>');
                return;
            }

            let html = '<div class="market-live-content">';
            
            // 添加标题和更新时间
            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #e5e7eb;">';
            html += '<h5 style="color: #5da39d; margin: 0; font-weight: 600;"><i class="fas fa-broadcast-tower"></i> 盘面回顾详情</h5>';
            html += '<div style="text-align: right;">';
            html += '<div style="color: #666; font-size: 0.9rem;">最后更新: ' + (data.last_updated || new Date().toLocaleString()) + '</div>';
            html += '<div style="color: #999; font-size: 0.8rem;">数据来源: ' + (data.data_source || 'longhuvip') + '</div>';
            html += '</div>';
            html += '</div>';

            // 标题
            if (data.title) {
                html += '<div style="margin-bottom: 20px; padding: 15px; background-color: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">';
                html += '<h4 style="color: #1e40af; margin: 0; font-weight: 600; font-size: 1.1rem;">' + data.title + '</h4>';
                html += '</div>';
            }

            // 摘要
            if (data.summary) {
                html += '<div style="margin-bottom: 20px; padding: 15px; background-color: #f9fafb; border-radius: 8px;">';
                html += '<h6 style="color: #5da39d; margin-bottom: 10px; font-weight: 600;"><i class="fas fa-info-circle"></i> 市场摘要</h6>';
                html += '<p style="line-height: 1.6; color: #333; margin: 0;">' + data.summary + '</p>';
                html += '</div>';
            }

            // 板块亮点
            if (data.sector_highlights && data.sector_highlights.length > 0) {
                html += '<div style="margin-bottom: 20px; padding: 15px; background-color: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">';
                html += '<h6 style="color: #92400e; margin-bottom: 10px; font-weight: 600;"><i class="fas fa-star"></i> 强势板块</h6>';
                html += '<div style="display: flex; flex-wrap: wrap; gap: 8px;">';
                data.sector_highlights.forEach(sector => {
                    html += '<span style="background-color: #fbbf24; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: 500;">' + sector + '</span>';
                });
                html += '</div>';
                html += '</div>';
            }

            // 热门个股
            if (data.hot_stocks && data.hot_stocks.length > 0) {
                html += '<div style="margin-bottom: 20px; padding: 15px; background-color: #f0fdf4; border-radius: 8px; border-left: 4px solid #10b981;">';
                html += '<h6 style="color: #065f46; margin-bottom: 10px; font-weight: 600;"><i class="fas fa-chart-line"></i> 热门个股</h6>';
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">';
                data.hot_stocks.forEach(stock => {
                    html += '<span style="background-color: white; border: 1px solid #d1fae5; border-radius: 6px; padding: 6px 10px; font-size: 0.9rem; color: #065f46;">' + stock + '</span>';
                });
                html += '</div>';
                html += '</div>';
            }

            // 市场情绪
            if (data.market_sentiment) {
                let sentimentColor = '#6b7280';
                let sentimentIcon = 'fas fa-minus-circle';
                if (data.market_sentiment === '强势') {
                    sentimentColor = '#ef4444';
                    sentimentIcon = 'fas fa-arrow-up';
                } else if (data.market_sentiment === '弱势') {
                    sentimentColor = '#10b981';
                    sentimentIcon = 'fas fa-arrow-down';
                }
                
                html += '<div style="margin-bottom: 20px; padding: 15px; background-color: #fef2f2; border-radius: 8px; border-left: 4px solid ' + sentimentColor + ';">';
                html += '<h6 style="color: ' + sentimentColor + '; margin-bottom: 10px; font-weight: 600;"><i class="' + sentimentIcon + '"></i> 市场情绪</h6>';
                html += '<p style="color: #333; margin: 0; font-weight: 500;">' + data.market_sentiment + '</p>';
                html += '</div>';
            }

            // 完整内容
            if (data.content) {
                html += '<div style="margin-bottom: 20px; padding: 15px; background-color: #f8fafc; border-radius: 8px;">';
                html += '<h6 style="color: #5da39d; margin-bottom: 10px; font-weight: 600;"><i class="fas fa-file-alt"></i> 详细内容</h6>';
                html += '<div style="line-height: 1.6; color: #333; white-space: pre-wrap; max-height: 300px; overflow-y: auto;">' + data.content + '</div>';
                html += '</div>';
            }

            html += '</div>';
            
            container.html(html);
            
            // 添加调试信息到控制台
            console.log('渲染完成，展示了盘面回顾数据');
        }
        
        // 添加新泳道
        $('#addSwimLaneBtn').click(function(e) {
            e.preventDefault(); 
            const laneName = $('#newLaneName').val().trim();
            if (laneName) {
                addSwimLane(laneName);
                $('#newLaneName').val('');
            } else {
                addSwimLane(`板块${laneCounter}`);
            }
        });
        
        $('#newLaneName').keypress(function(e) {
            if (e.which === 13) {
                e.preventDefault(); 
                const laneName = $(this).val().trim();
                if (laneName) {
                    addSwimLane(laneName);
                    $(this).val('');
                } else {
                    addSwimLane(`板块${laneCounter}`);
                }
            }
        });
        
        $(document).on('mouseenter', '.remove-lane-btn', function() {
            $(this).css({
                'background-color': 'rgba(239, 68, 68, 0.3)',
                'transform': 'scale(1.1)'
            });
        }).on('mouseleave', '.remove-lane-btn', function() {
            $(this).css({
                'background-color': 'rgba(239, 68, 68, 0.1)',
                'transform': 'scale(1)'
            });
        });

        // 鼠标悬停在板块标签区域时显示删除按钮
        $(document).on('mouseenter', '.lane-label', function() {
            $(this).find('.remove-lane-btn').css('display', 'flex');
        }).on('mouseleave', '.lane-label', function() {
            $(this).find('.remove-lane-btn').css('display', 'none');
        });

        $(document).on('click', '.state-dot', function() {
            const dot = $(this);
            const laneElement = dot.closest('.swim-lane');
            const laneId = laneElement.data('lane-id');
            const dayIndex = dot.closest('.lane-day').index();
            const dateString = $('#dateHeader .date-col').eq(dayIndex).attr('data-date'); // Changed .data() to .attr()

            let currentState = parseInt(dot.data('state'));
            currentState = (currentState + 1) % 6; 
            if (currentState === 5) currentState = -1; 
            
            dot.data('state', currentState);
            const colorToSet = currentState === -1 ? defaultColor : stateColors[currentState];
            dot.css('background-color', colorToSet);
            
            if (laneId && dateString) {
                saveState(laneId, dateString, currentState);
            }
            
            // 更新行背景颜色
            updateLaneBackgroundColor(laneElement);
            drawConnectionLines();
        });
        
        $(document).on('click', '.remove-lane-btn', function(e) {
            e.preventDefault();
            e.stopPropagation();

            const laneToRemove = $(this).closest('.swim-lane');
            const laneIdToRemove = laneToRemove.data('lane-id');

            showCustomModal('确认删除', '确定要删除该板块吗？删除后数据将无法恢复。', function() {
                laneToRemove.remove();
                let lanes = loadLaneData();
                lanes = lanes.filter(lane => lane.id !== laneIdToRemove);
                saveLaneData(lanes);
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith(`swimlaneState-${laneIdToRemove}-`)) {
                        localStorage.removeItem(key);
                    }
                }

                // 重新分配所有泳道的背景颜色
                assignLaneBackgroundColors();
                drawConnectionLines();
            });
        });

        // 板块名称点击事件 - 切换星级
        $(document).on('click', '.lane-name', function(e) {
            e.preventDefault();
            e.stopPropagation();

            const laneElement = $(this).closest('.swim-lane');
            const laneId = laneElement.data('lane-id');

            // 获取当前星级
            let currentRating = loadLaneRating(laneId);

            // 循环逻辑：0 -> 3 -> 2 -> 1 -> 0
            let newRating;
            if (currentRating === 0) {
                newRating = 3;
            } else if (currentRating === 3) {
                newRating = 2;
            } else if (currentRating === 2) {
                newRating = 1;
            } else {
                newRating = 0;
            }

            // 保存新星级
            saveLaneRating(laneId, newRating);

            // 更新显示
            const stars = '★'.repeat(newRating);
            laneElement.find('.lane-stars').text(stars);
        });

        function addSwimLane(name, laneIdToUse = null) {
            const laneId = laneIdToUse || `lane${laneCounter++}`;
            if (!laneIdToUse) { 
                let lanes = loadLaneData();
                if (!lanes.find(lane => lane.id === laneId)) {
                    const creationDate = getCurrentReviewDateStr();
                    lanes.push({ id: laneId, name: name, creationDate: creationDate });
                    saveLaneData(lanes);
                }
            }
            
            // 根据板块名称决定是否显示删除按钮（"大盘"不显示删除按钮）
            const removeButtonHtml = (name !== '大盘')
                ? '<button class="remove-lane-btn" style="margin-right: 5px; background-color: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 50%; width: 14px; height: 14px; display: none; align-items: center; justify-content: center; color: #ef4444; font-size: 8px; cursor: pointer; transition: all 0.2s ease;"><i class="fas fa-times"></i></button>'
                : '';

            // 加载板块的星级评分
            const rating = loadLaneRating(laneId);
            const stars = '★'.repeat(rating);

            let laneHtml = `
                <div class="swim-lane" data-lane-id="${laneId}" draggable="true" style="cursor: move;">
                    <div class="lane-label" style="position: absolute; left: 0; width: 110px; padding: 10px 5px; text-align: right; font-weight: 500; display: flex; flex-direction: column; align-items: flex-end; justify-content: center;">
                        <div style="display: flex; align-items: center;">
                            ${removeButtonHtml}
                            <span class="lane-name" style="cursor: pointer; user-select: none; font-size: 12px;">${name}</span>
                        </div>
                        <span class="lane-stars" style="color: #fbbf24; font-size: 10px; user-select: none; line-height: 1;">${stars}</span>
                    </div>
                    <div class="lane-content" style="display: flex; margin-left: 120px; border-bottom: 1px solid #e5e7eb; padding-bottom: 5px; margin-bottom: 2px;">
            `;
            
            $('#dateHeader .date-col').each(function(i) {
                const dateString = $(this).attr('data-date'); // Changed .data() to .attr()
                const savedState = dateString ? loadState(laneId, dateString) : null;
                const initialState = savedState !== null ? parseInt(savedState) : -1;
                const initialColor = initialState === -1 ? defaultColor : stateColors[initialState];

                const isLast = i === ($('#dateHeader .date-col').length - 1);
                laneHtml += `
                    <div class="lane-day" style="flex: 1; min-height: 35px; display: flex; align-items: center; justify-content: center; ${!isLast ? 'border-right: 1px dashed var(--color-gray-300);' : ''} min-width: 80px;">
                        <div class="state-dot" data-state="${initialState}" style="width: 20px; height: 20px; border-radius: 50%; background-color: ${initialColor}; cursor: pointer; position: relative; z-index: 2;"></div>
                    </div>
                `;
            });
            
            laneHtml += `</div></div>`;
            
            const swimLanesContent = $('#swimLanesContent');
            const marketLane = swimLanesContent.find('.swim-lane .lane-name:contains("大盘")').closest('.swim-lane');

            if (name === '大盘') {
                swimLanesContent.prepend(laneHtml);
            } else if (marketLane.length > 0) {
                marketLane.after(laneHtml);
            } else {
                swimLanesContent.prepend(laneHtml); // Fallback if 大盘 somehow isn't there yet
            }
            
            // 重新分配所有泳道的背景颜色
            assignLaneBackgroundColors();
            
            // 更新新添加泳道的背景颜色状态
            const newLane = $(`[data-lane-id="${laneId}"]`);
            updateLaneBackgroundColor(newLane);
        }
        
        function repositionDots() {
            // Simplified: No complex dynamic repositioning based on state value for now.
        }
        
        function drawConnectionLines() {
            const svg = $('#connectionLines');
            svg.empty();
            repositionDots(); 
            
            $('.swim-lane').each(function() {
                const dots = $(this).find('.state-dot:visible'); 
                if (dots.length < 2) return;
                
                const positions = [];
                dots.each(function() {
                    const dot = $(this);
                    const offset = dot.offset();
                    const containerOffset = $('#swimLaneContainer').offset();
                    const scrollTop = $('#swimLaneContainer').scrollTop();
                    const scrollLeft = $('#swimLaneContainer').scrollLeft();

                    positions.push({
                        x: offset.left - containerOffset.left + scrollLeft + dot.width() / 2,
                        y: offset.top - containerOffset.top + scrollTop + dot.height() / 2
                    });
                });
                
                let pathData = `M ${positions[0].x} ${positions[0].y}`;
                for (let i = 1; i < positions.length; i++) {
                    pathData += ` L ${positions[i].x} ${positions[i].y}`;
                }
                
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                line.setAttribute('d', pathData);
                line.setAttribute('stroke', '#d1d5db');
                line.setAttribute('stroke-width', '2');
                line.setAttribute('fill', 'none');
                line.setAttribute('stroke-opacity', '0.6');
                svg.prepend(line);
            });
        }
        
        function updateDateHeader(baseDateStr) {
            const baseDate = new Date(baseDateStr + "T00:00:00Z"); // Use UTC for consistency
            const workingDays = [];

            // 生成向前推的工作日日期（跳过周六周日）
            let currentDate = new Date(baseDate.getTime());
            let daysToGenerate = $('#dateHeader .date-col').length; // 获取需要生成的日期数
            let daysAdded = 0;
            let offset = -4; // 从4天前开始

            while (daysAdded < daysToGenerate) {
                const tempDate = new Date(baseDate.getTime());
                tempDate.setUTCDate(baseDate.getUTCDate() + offset);

                // 获取星期几（0=周日，1=周一，...，6=周六）
                const dayOfWeek = tempDate.getUTCDay();

                // 只添加工作日（周一到周五）
                if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                    workingDays.push({
                        display: `${tempDate.getUTCMonth() + 1}月${tempDate.getUTCDate()}日`,
                        data: tempDate.toISOString().split('T')[0]
                    });
                    daysAdded++;
                }
                offset++;
            }

            // 更新DOM
            $('#dateHeader .date-col').each(function(index) {
                if (index < workingDays.length) {
                    $(this).text(workingDays[index].display);
                    $(this).attr('data-date', workingDays[index].data);
                }
            });
        }

        function reloadAllSwimLanes() {
            $('#swimLanesContent').empty();
            const allLanes = loadLaneData();
            const currentReviewDate = getCurrentReviewDateStr();

            const daPanLane = allLanes.find(lane => lane.name === '大盘');
            if (daPanLane) {
                addSwimLane(daPanLane.name, daPanLane.id);
            }

            allLanes.forEach(lane => {
                if (lane.name === '大盘') return; 

                if ((lane.creationDate && lane.creationDate <= currentReviewDate) || !lane.creationDate) {
                    addSwimLane(lane.name, lane.id);
                }
            });
            
            // 重新分配所有泳道的背景颜色
            assignLaneBackgroundColors();
            drawConnectionLines();
        }

        $('#reviewDate').change(function() {
            const currentReviewDateStr = $(this).val();
            if (!currentReviewDateStr) return;

            const newReviewDate = new Date(currentReviewDateStr + "T00:00:00Z"); // Use UTC

            // When the review date changes, we simply update the date header
            // and reload all swim lanes. The reloadAllSwimLanes function,
            // in conjunction with addSwimLane and loadState, will ensure that
            // each dot in the swimlane reflects the stored state for its specific
            // lane and date. There is no explicit state copying from the previous
            // day to the new day's "today" column here. The new "today" column
            // will show default (grey) if no state has been explicitly saved for it
            // on that new date.

            updateDateHeader(currentReviewDateStr);
            reloadAllSwimLanes(); 
            ensureNoteIndicatorsAreCorrect(); // Explicitly update indicators after reload
            previousReviewDate = newReviewDate; 
            
            // 折叠泳道内容并重置按钮状态
            toggleExpandedView(false);
            $('#expandTodayBtn').html('<i class="fas fa-expand"></i> 展|折');
        });
        
        function initializeSwimLanes() {
            laneCounter = getMaxLaneIdNumber() + 1;

            const initialDateStr = getCurrentReviewDateStr() || new Date().toISOString().split('T')[0];
            if (!getCurrentReviewDateStr()) {
                 $('#reviewDate').val(initialDateStr); 
            }
            previousReviewDate = new Date(initialDateStr + "T00:00:00Z"); // Use UTC
            updateDateHeader(initialDateStr);
            
            // 确保初始化时内容是折叠的
            $('#swimLaneContainer').removeClass('expanded');
            $('#expandTodayBtn').html('<i class="fas fa-expand"></i> 展|折');
            
            let lanes = loadLaneData();
            if (!lanes.find(lane => lane.name === '大盘')) {
                const daPanId = `lane${laneCounter++}`;
                lanes.unshift({ id: daPanId, name: '大盘', creationDate: '1970-01-01' });
                saveLaneData(lanes);
            }
            
            reloadAllSwimLanes();
            
            // 初始化时分配背景颜色
            assignLaneBackgroundColors();

            $('#connectionLines').css({
                'position': 'absolute',
                'top': '0',
                'left': '0',
                'width': '100%',
                'height': '100%',
                'pointer-events': 'none',
                'z-index': '1'
            });
        }

        initializeSwimLanes();

        // 拖拽排序功能
        let draggedElement = null;

        $(document).on('dragstart', '.swim-lane', function(e) {
            draggedElement = this;
            $(this).css('opacity', '0.5');
            e.originalEvent.dataTransfer.effectAllowed = 'move';
            e.originalEvent.dataTransfer.setData('text/html', this.innerHTML);
        });

        $(document).on('dragend', '.swim-lane', function(e) {
            $(this).css('opacity', '1');
            $('.swim-lane').removeClass('drag-over');
        });

        $(document).on('dragover', '.swim-lane', function(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.originalEvent.dataTransfer.dropEffect = 'move';
            return false;
        });

        $(document).on('dragenter', '.swim-lane', function(e) {
            if (draggedElement !== this) {
                $(this).addClass('drag-over');
            }
        });

        $(document).on('dragleave', '.swim-lane', function(e) {
            $(this).removeClass('drag-over');
        });

        $(document).on('drop', '.swim-lane', function(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (draggedElement !== this) {
                // 获取拖拽元素和目标元素的位置
                const draggedIndex = $(draggedElement).index();
                const targetIndex = $(this).index();

                // 移动元素
                if (draggedIndex < targetIndex) {
                    $(this).after(draggedElement);
                } else {
                    $(this).before(draggedElement);
                }

                // 更新localStorage中的泳道顺序
                let lanes = loadLaneData();
                const draggedLaneId = $(draggedElement).data('lane-id');
                const targetLaneId = $(this).data('lane-id');

                // 找到对应的lane对象
                const draggedLaneIndex = lanes.findIndex(l => l.id === draggedLaneId);
                const targetLaneIndex = lanes.findIndex(l => l.id === targetLaneId);

                if (draggedLaneIndex !== -1 && targetLaneIndex !== -1) {
                    // 从数组中移除拖拽的lane
                    const [draggedLane] = lanes.splice(draggedLaneIndex, 1);

                    // 重新计算目标位置（因为移除了一个元素）
                    const newTargetIndex = lanes.findIndex(l => l.id === targetLaneId);

                    // 插入到新位置
                    if (draggedIndex < targetIndex) {
                        lanes.splice(newTargetIndex + 1, 0, draggedLane);
                    } else {
                        lanes.splice(newTargetIndex, 0, draggedLane);
                    }

                    // 保存新的顺序
                    saveLaneData(lanes);
                }

                // 重新分配背景颜色
                assignLaneBackgroundColors();
                drawConnectionLines();
            }

            $(this).removeClass('drag-over');
            return false;
        });

        $(window).resize(function() {
            drawConnectionLines();
        });

        // 这个原始的事件处理程序已被移除，因为我们重新实现了它

        $('#saveNotesBtn').click(function() {
            const currentLaneId = $('#notesModal').data('lane-id');
            const currentDateString = $('#notesModal').data('date-string');
            const isMarketLane = $('#notesModal').data('is-market');
            const historyText = $('#historyNotesTextarea').val();

            if (!currentLaneId || !currentDateString) return;

            let hasContent = false;

            if (isMarketLane) {
                // 大盘模式：保存单一字段
                const todayText = $('#todayNotesTextarea').val();
                const tomorrowText = $('#tomorrowNotesTextarea').val();

                // 保存今天数据
                const todayNoteKey = `swimlaneToday-${currentLaneId}-${currentDateString}`;
                localStorage.setItem(todayNoteKey, todayText);

                // 保存明天预判数据
                const tomorrowNoteKey = `swimlaneTomorrow-${currentLaneId}-${currentDateString}`;
                localStorage.setItem(tomorrowNoteKey, tomorrowText);

                // 兼容旧版本数据 - 保存合并笔记
                const combinedNote = `历史: (自动生成)\n\n今天: ${todayText}\n\n明天: ${tomorrowText}`;
                const noteKey = `swimlaneNote-${currentLaneId}-${currentDateString}`;
                localStorage.setItem(noteKey, combinedNote);

                hasContent = historyText.trim() !== '' || todayText.trim() !== '' || tomorrowText.trim() !== '';

            } else {
                // 普通板块模式：保存前排后排分离字段
                const todayFrontText = $('#todayFrontNotesTextarea').val();
                const todayBackText = $('#todayBackNotesTextarea').val();
                const tomorrowFrontText = $('#tomorrowFrontNotesTextarea').val();
                const tomorrowBackText = $('#tomorrowBackNotesTextarea').val();

                // 保存今天前排数据
                const todayFrontNoteKey = `swimlaneTodayFront-${currentLaneId}-${currentDateString}`;
                localStorage.setItem(todayFrontNoteKey, todayFrontText);

                // 保存今天后排数据
                const todayBackNoteKey = `swimlaneTodayBack-${currentLaneId}-${currentDateString}`;
                localStorage.setItem(todayBackNoteKey, todayBackText);

                // 保存明天前排预判数据
                const tomorrowFrontNoteKey = `swimlaneTomorrowFront-${currentLaneId}-${currentDateString}`;
                localStorage.setItem(tomorrowFrontNoteKey, tomorrowFrontText);

                // 保存明天后排预判数据
                const tomorrowBackNoteKey = `swimlaneTomorrowBack-${currentLaneId}-${currentDateString}`;
                localStorage.setItem(tomorrowBackNoteKey, tomorrowBackText);

                // 合并今天的内容用于向后兼容
                const combinedTodayText = [
                    todayFrontText ? `前排：${todayFrontText}` : '',
                    todayBackText ? `后排：${todayBackText}` : ''
                ].filter(t => t).join('\n');
                const todayNoteKey = `swimlaneToday-${currentLaneId}-${currentDateString}`;
                localStorage.setItem(todayNoteKey, combinedTodayText);

                // 合并明天的内容用于向后兼容
                const combinedTomorrowText = [
                    tomorrowFrontText ? `前排：${tomorrowFrontText}` : '',
                    tomorrowBackText ? `后排：${tomorrowBackText}` : ''
                ].filter(t => t).join('\n');
                const tomorrowNoteKey = `swimlaneTomorrow-${currentLaneId}-${currentDateString}`;
                localStorage.setItem(tomorrowNoteKey, combinedTomorrowText);

                // 兼容旧版本数据 - 保存合并笔记
                const combinedNote = `历史: (自动生成)\n\n今天: ${combinedTodayText}\n\n明天: ${combinedTomorrowText}`;
                const noteKey = `swimlaneNote-${currentLaneId}-${currentDateString}`;
                localStorage.setItem(noteKey, combinedNote);

                hasContent = historyText.trim() !== '' || todayFrontText.trim() !== '' || todayBackText.trim() !== '' ||
                    tomorrowFrontText.trim() !== '' || tomorrowBackText.trim() !== '';
            }

            // 更新笔记指示器
            const dayIndexToUpdate = getDateColIndexByDateString(currentDateString);
            if (dayIndexToUpdate !== -1) {
                const dotToUpdate = $(`.swim-lane[data-lane-id="${currentLaneId}"] .lane-day`).eq(dayIndexToUpdate).find('.state-dot');
                dotToUpdate.find('.note-indicator').remove(); // Remove old one if exists

                // 只要有任何一个字段有内容，就显示指示器
                if (hasContent) {
                    dotToUpdate.append('<span class="note-indicator" style="position: absolute; top: -3px; right: -3px; width: 8px; height: 8px; background-color: var(--color-secondary, #f97316); border-radius: 50%; border: 1px solid white; z-index: 3;"></span>');
                }

                // 更新该行的背景颜色状态
                const laneElement = dotToUpdate.closest('.swim-lane');
                if (laneElement.length > 0) {
                    updateLaneBackgroundColor(laneElement);
                }
            }
            $('#notesModal').css('display', 'none');
        });

        // 使用事件委托确保动态添加的按钮也能正常工作
        $(document).on('click', '.notes-modal-close-btn', function() {
            $('#notesModal').css('display', 'none');
        });

        $('#notesModal').on('click', function(e) {
            if ($(e.target).is('#notesModal')) { // if click is on the backdrop
                $('#notesModal').css('display', 'none');
            }
        });

        // 为昨日预判按钮添加悬停效果（普通模式和大盘模式）
        $('#viewYesterdayPrediction, #viewYesterdayPredictionMarket').hover(
            function() {
                $(this).css({
                    'background-color': 'var(--color-primary-hover)',
                    'box-shadow': '0 2px 4px rgba(0,0,0,0.2)'
                });
            },
            function() {
                $(this).css({
                    'background-color': 'var(--color-primary)',
                    'box-shadow': 'none'
                });
            }
        );

        // 昨日预判按钮点击事件（普通模式和大盘模式）
        $('#viewYesterdayPrediction, #viewYesterdayPredictionMarket').click(function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // 移除之前可能存在的预判弹窗
            $('#predictionModal').remove();
            
            const yesterdayPrediction = $('#notesModal').data('yesterday-prediction') || '';
            if (yesterdayPrediction.trim() !== '') {
                // 创建专用的预判查看弹窗，而不是使用普通的showCustomModal
                // 因为预判内容可能很长，需要更好的展示方式
                const laneName = $('#notesModalTitle').text().split(':')[1] || '';
                const currentLaneId = $('#notesModal').data('lane-id');
                const previousDateString = $('#notesModal').data('previous-date');
                
                // 创建并显示预判内容弹窗
                $('body').append(`
                    <div id="predictionModal" class="custom-modal" style="display: flex; z-index: 1500;">
                        <div class="custom-modal-content" style="max-width: 520px; background: white; border-radius: 12px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15); overflow: hidden;">
                            <div class="custom-modal-header" style="background: #f97316; padding: 1.5rem; border-bottom: none;">
                                <h3 style="color: white; margin: 0; font-size: 1.1rem; font-weight: 600; text-align: center;">昨日预判${laneName}</h3>
                            </div>
                            <div class="custom-modal-body" style="padding: 1.5rem; max-height: 320px; overflow-y: auto; background: #fafbfc;">
                                <div style="background: white; border-radius: 8px; padding: 1.25rem; border: 1px solid #e5e7eb; margin-bottom: 1rem;">
                                    <p style="white-space: pre-wrap; line-height: 1.6; color: #374151; margin: 0; font-size: 0.95rem;">${yesterdayPrediction}</p>
                                </div>
                                <div style="display: flex; gap: 0.5rem; justify-content: center;">
                                    <button id="modalCorrectBtn" style="
                                        background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
                                        border: none;
                                        border-radius: 6px;
                                        color: white;
                                        padding: 0.5rem 0.875rem;
                                        cursor: pointer;
                                        font-size: 0.8rem;
                                        font-weight: 500;
                                        display: flex;
                                        align-items: center;
                                        gap: 0.375rem;
                                        box-shadow: 0 3px 8px rgba(16, 185, 129, 0.25);
                                        transition: all 0.2s ease;
                                        min-width: 80px;
                                        justify-content: center;
                                    " title="标记预判正确">
                                        <span style="font-size: 0.875rem; line-height: 1;">✓</span>
                                        <span>正确</span>
                                    </button>
                                    <button id="modalWrongBtn" style="
                                        background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
                                        border: none;
                                        border-radius: 6px;
                                        color: white;
                                        padding: 0.5rem 0.875rem;
                                        cursor: pointer;
                                        font-size: 0.8rem;
                                        font-weight: 500;
                                        display: flex;
                                        align-items: center;
                                        gap: 0.375rem;
                                        box-shadow: 0 3px 8px rgba(239, 68, 68, 0.25);
                                        transition: all 0.2s ease;
                                        min-width: 80px;
                                        justify-content: center;
                                    " title="标记预判错误">
                                        <span style="font-size: 0.875rem; line-height: 1;">✗</span>
                                        <span>错误</span>
                                    </button>
                                </div>
                            </div>
                            <div class="custom-modal-footer" style="padding: 1rem 1.5rem; background: #f9fafb; border-top: 1px solid #e5e7eb; text-align: right;">
                                <button class="btn prediction-modal-close" style="
                                    background: #6b7280;
                                    color: white;
                                    border: none;
                                    border-radius: 6px;
                                    padding: 0.5rem 1rem;
                                    cursor: pointer;
                                    font-size: 0.9rem;
                                    transition: background 0.2s ease;
                                ">关闭</button>
                            </div>
                        </div>
                    </div>
                `);
                
                // 绑定关闭事件
                $('.prediction-modal-close').click(function() {
                    $('#predictionModal').remove();
                });
                
                // 点击外部关闭
                $('#predictionModal').on('click', function(e) {
                    if ($(e.target).is('#predictionModal')) {
                        $('#predictionModal').remove();
                    }
                });
                
                // 绑定模态框内的打勾和打叉按钮事件
                $('#modalCorrectBtn').click(function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (currentLaneId && previousDateString) {
                        const correctKey = `predictionCorrect-${currentLaneId}-${previousDateString}`;
                        localStorage.setItem(correctKey, 'correct');
                        $('#predictionModal').remove();
                        showCustomModal('提示', '已标记昨日预判为正确');
                    }
                }).hover(
                    function() { 
                        $(this).css({
                            'transform': 'translateY(-1px)',
                            'box-shadow': '0 4px 12px rgba(16, 185, 129, 0.35)'
                        }); 
                    },
                    function() { 
                        $(this).css({
                            'transform': 'translateY(0)',
                            'box-shadow': '0 3px 8px rgba(16, 185, 129, 0.25)'
                        }); 
                    }
                );
                
                $('#modalWrongBtn').click(function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (currentLaneId && previousDateString) {
                        const wrongKey = `predictionCorrect-${currentLaneId}-${previousDateString}`;
                        localStorage.setItem(wrongKey, 'wrong');
                        $('#predictionModal').remove();
                        showCustomModal('提示', '已标记昨日预判为错误');
                    }
                }).hover(
                    function() { 
                        $(this).css({
                            'transform': 'translateY(-1px)',
                            'box-shadow': '0 4px 12px rgba(239, 68, 68, 0.35)'
                        }); 
                    },
                    function() { 
                        $(this).css({
                            'transform': 'translateY(0)',
                            'box-shadow': '0 3px 8px rgba(239, 68, 68, 0.25)'
                        }); 
                    }
                );
            } else {
                // 确保提示框显示在最前面，设置更高的z-index
                $('#customModal').css('z-index', '2000');
                
                // 显示提示框
                showCustomModal('提示', '没有找到昨日预判内容');
                
                // 移除之前可能存在的自动关闭计时器
                if (window.autoCloseTimer) {
                    clearTimeout(window.autoCloseTimer);
                }
                
                // 设置5秒后自动关闭
                window.autoCloseTimer = setTimeout(() => {
                    $('#customModal').css('display', 'none');
                    $('#customModal').css('z-index', '1200');
                }, 5000);
            }
        });



                    // 为所有笔记文本框添加Shift+Enter处理
            $('#historyNotesTextarea, #todayNotesTextarea, #tomorrowNotesTextarea').on('keydown', function(e) {
                if (e.key === 'Enter' || e.keyCode === 13) {
                    if (e.shiftKey) {
                        // Allow Shift+Enter for newline
                        return; 
                    } else {
                        // Enter alone should save
                        e.preventDefault();
                        $('#saveNotesBtn').click();
                    }
                }
            });
            
            // 重新绑定state-dot的右键事件，确保它能正常工作
            $(document).off('contextmenu', '.state-dot').on('contextmenu', '.state-dot', function(e) {
                e.preventDefault(); // 阻止默认右键菜单
                e.stopPropagation(); // 阻止事件冒泡
                
                const dot = $(this);
                const laneElement = dot.closest('.swim-lane');
                const currentLaneId = laneElement.data('lane-id');
                const dayIndex = dot.closest('.lane-day').index();
                const currentDateString = $('#dateHeader .date-col').eq(dayIndex).attr('data-date');

                if (!currentLaneId || !currentDateString) return; // 安全检查
                
                // 确保背景颜色状态正确
                updateLaneBackgroundColor(laneElement);

                // 存储数据以供保存按钮使用
                $('#notesModal').data('lane-id', currentLaneId);
                $('#notesModal').data('date-string', currentDateString);
                $('#notesModal').data('day-index', dayIndex);

                // 计算相关日期
                const currentDate = new Date(currentDateString);
                const yesterdayDate = new Date(currentDate);
                yesterdayDate.setDate(currentDate.getDate() - 1);
                const yesterdayDateString = yesterdayDate.toISOString().split('T')[0];
                
                // 获取前一天的索引
                const yesterdayIndex = dayIndex - 1;
                
                // 获取前一个交易日的日期（如果有）
                let previousTradingDateString = '';
                if (yesterdayIndex >= 0) {
                    previousTradingDateString = $('#dateHeader .date-col').eq(yesterdayIndex).attr('data-date');
                }

                // 加载历史上所有"今天"的消息记录
                let historyContent = '';
                const allHistoryRecords = [];

                // 遍历localStorage中所有键，查找前排数据
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    // 检查是否是当前泳道的"今天前排"记录
                    if (key && key.startsWith(`swimlaneTodayFront-${currentLaneId}-`)) {
                        // 提取日期部分
                        const dateString = key.replace(`swimlaneTodayFront-${currentLaneId}-`, '');
                        if (dateString && dateString !== currentDateString) { // 排除当前日期
                            const frontContent = localStorage.getItem(key) || '';
                            const backKey = `swimlaneTodayBack-${currentLaneId}-${dateString}`;
                            const backContent = localStorage.getItem(backKey) || '';

                            // 只有当至少有一个字段有内容时才添加记录
                            if (frontContent.trim() !== '' || backContent.trim() !== '') {
                                const parts = [];
                                if (frontContent.trim() !== '') parts.push(`前排：${frontContent}`);
                                if (backContent.trim() !== '') parts.push(`后排：${backContent}`);
                                const combinedContent = parts.join('\n');

                                // 将日期和内容添加到记录数组
                                allHistoryRecords.push({
                                    date: new Date(dateString),
                                    dateString: dateString,
                                    content: combinedContent
                                });
                            }
                        }
                    } else if (key && key.startsWith(`swimlaneToday-${currentLaneId}-`)) {
                        // 向后兼容：检查是否是旧版本的"今天"记录
                        const dateString = key.replace(`swimlaneToday-${currentLaneId}-`, '');
                        if (dateString && dateString !== currentDateString) {
                            // 检查是否已经有新版本的数据
                            const hasFrontKey = localStorage.getItem(`swimlaneTodayFront-${currentLaneId}-${dateString}`);
                            const hasBackKey = localStorage.getItem(`swimlaneTodayBack-${currentLaneId}-${dateString}`);

                            // 只有当没有新版本数据时才使用旧版本数据
                            if (!hasFrontKey && !hasBackKey) {
                                const content = localStorage.getItem(key);
                                if (content && content.trim() !== '') {
                                    // 检查是否已经在记录中
                                    const existingRecord = allHistoryRecords.find(r => r.dateString === dateString);
                                    if (!existingRecord) {
                                        allHistoryRecords.push({
                                            date: new Date(dateString),
                                            dateString: dateString,
                                            content: content
                                        });
                                    }
                                }
                            }
                        }
                    }
                }
                
                // 按日期降序排序记录
                allHistoryRecords.sort((a, b) => b.date - a.date);
                
                // 格式化历史记录
                allHistoryRecords.forEach(record => {
                    // 将日期格式化为"X月X日"
                    const dateObj = record.date;
                    const month = dateObj.getMonth() + 1;
                    const day = dateObj.getDate();
                    const formattedDate = `${month}月${day}日`;
                    
                    // 添加到历史内容中
                    historyContent += `${formattedDate}：\n${record.content}\n\n`;
                });
                
                // 更新历史文本框
                $('#historyNotesTextarea').val(historyContent);

                // 不再加载昨天的数据，因为已移除昨天文本框

                // 获取板块名称，判断是否是"大盘"
                const laneName = laneElement.find('.lane-name').text().trim();
                const isMarketLane = (laneName === '大盘');

                // 根据板块类型显示对应的输入框模式
                if (isMarketLane) {
                    // 大盘模式：显示单一输入框
                    $('#normalModeContainer').css('display', 'none');
                    $('#marketModeContainer').css('display', 'flex');

                    // 加载今天的数据（大盘用单一字段）
                    const todayNoteKey = `swimlaneToday-${currentLaneId}-${currentDateString}`;
                    const todayNote = localStorage.getItem(todayNoteKey) || '';
                    $('#todayNotesTextarea').val(todayNote);

                    // 加载明天的预判数据（大盘用单一字段）
                    const tomorrowNoteKey = `swimlaneTomorrow-${currentLaneId}-${currentDateString}`;
                    const tomorrowNote = localStorage.getItem(tomorrowNoteKey) || '';
                    $('#tomorrowNotesTextarea').val(tomorrowNote);

                    // 存储昨日预判数据（大盘用单一字段）
                    const yesterdayPredictionKey = `swimlaneTomorrow-${currentLaneId}-${previousTradingDateString}`;
                    const yesterdayPrediction = localStorage.getItem(yesterdayPredictionKey) || '';
                    $('#notesModal').data('yesterday-prediction', yesterdayPrediction);

                } else {
                    // 普通板块模式：显示前排后排分离输入框
                    $('#normalModeContainer').css('display', 'flex');
                    $('#marketModeContainer').css('display', 'none');

                    // 加载今天的前排数据
                    const todayFrontNoteKey = `swimlaneTodayFront-${currentLaneId}-${currentDateString}`;
                    let todayFrontNote = localStorage.getItem(todayFrontNoteKey) || '';

                    // 加载今天的后排数据
                    const todayBackNoteKey = `swimlaneTodayBack-${currentLaneId}-${currentDateString}`;
                    let todayBackNote = localStorage.getItem(todayBackNoteKey) || '';

                    // 如果新字段为空，尝试从旧字段加载（向后兼容）
                    if (!todayFrontNote && !todayBackNote) {
                        const todayNoteKey = `swimlaneToday-${currentLaneId}-${currentDateString}`;
                        const oldTodayNote = localStorage.getItem(todayNoteKey) || '';
                        if (oldTodayNote) {
                            // 将旧数据放到前排字段中
                            todayFrontNote = oldTodayNote;
                        }
                    }

                    $('#todayFrontNotesTextarea').val(todayFrontNote);
                    $('#todayBackNotesTextarea').val(todayBackNote);

                    // 加载明天的前排预判数据
                    const tomorrowFrontNoteKey = `swimlaneTomorrowFront-${currentLaneId}-${currentDateString}`;
                    let tomorrowFrontNote = localStorage.getItem(tomorrowFrontNoteKey) || '';

                    // 加载明天的后排预判数据
                    const tomorrowBackNoteKey = `swimlaneTomorrowBack-${currentLaneId}-${currentDateString}`;
                    let tomorrowBackNote = localStorage.getItem(tomorrowBackNoteKey) || '';

                    // 如果新字段为空，尝试从旧字段加载（向后兼容）
                    if (!tomorrowFrontNote && !tomorrowBackNote) {
                        const tomorrowNoteKey = `swimlaneTomorrow-${currentLaneId}-${currentDateString}`;
                        const oldTomorrowNote = localStorage.getItem(tomorrowNoteKey) || '';
                        if (oldTomorrowNote) {
                            // 将旧数据放到前排字段中
                            tomorrowFrontNote = oldTomorrowNote;
                        }
                    }

                    $('#tomorrowFrontNotesTextarea').val(tomorrowFrontNote);
                    $('#tomorrowBackNotesTextarea').val(tomorrowBackNote);

                    // 存储昨日预判数据以便查看按钮使用（合并前排和后排）
                    const yesterdayFrontPredictionKey = `swimlaneTomorrowFront-${currentLaneId}-${previousTradingDateString}`;
                    const yesterdayBackPredictionKey = `swimlaneTomorrowBack-${currentLaneId}-${previousTradingDateString}`;
                    const yesterdayFrontPrediction = localStorage.getItem(yesterdayFrontPredictionKey) || '';
                    const yesterdayBackPrediction = localStorage.getItem(yesterdayBackPredictionKey) || '';

                    // 合并昨日预判
                    let yesterdayPrediction = '';
                    if (yesterdayFrontPrediction || yesterdayBackPrediction) {
                        const parts = [];
                        if (yesterdayFrontPrediction) parts.push(`前排：${yesterdayFrontPrediction}`);
                        if (yesterdayBackPrediction) parts.push(`后排：${yesterdayBackPrediction}`);
                        yesterdayPrediction = parts.join('\n\n');
                    } else {
                        // 向后兼容：如果新字段为空，尝试从旧字段加载
                        const yesterdayPredictionKey = `swimlaneTomorrow-${currentLaneId}-${previousTradingDateString}`;
                        yesterdayPrediction = localStorage.getItem(yesterdayPredictionKey) || '';
                    }

                    $('#notesModal').data('yesterday-prediction', yesterdayPrediction);
                }

                // 存储板块名称和是否是大盘的标志
                $('#notesModal').data('lane-name', laneName);
                $('#notesModal').data('is-market', isMarketLane);
                $('#notesModal').data('previous-date', previousTradingDateString);

                // 更新模态框标题
                const dateDisplay = $('#dateHeader .date-col').eq(dayIndex).text();
                $('#notesModalTitle').text(`板块笔记: ${laneName} - ${dateDisplay}`);

                // 显示模态框
                $('#notesModal').css('display', 'flex');
            });

        $(document).on('click', '.remove-lane-btn', function(e) {
            e.preventDefault(); 
            e.stopPropagation(); 
            
            const laneToRemove = $(this).closest('.swim-lane');
            const laneIdToRemove = laneToRemove.data('lane-id');
            
            showCustomModal('确认删除', '确定要删除该板块吗？删除后数据将无法恢复。', function() {
                laneToRemove.remove();
                let lanes = loadLaneData();
                lanes = lanes.filter(lane => lane.id !== laneIdToRemove);
                saveLaneData(lanes);
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith(`swimlaneState-${laneIdToRemove}-`)) {
                        localStorage.removeItem(key);
                    }
                }
                
                // 重新分配所有泳道的背景颜色
                assignLaneBackgroundColors();
                drawConnectionLines();
            });
        });

        function getDateColIndexByDateString(dateStr) {
            let idx = -1;
            $('#dateHeader .date-col').each(function(index) {
                if ($(this).attr('data-date') === dateStr) {
                    idx = index;
                    return false; // break
                }
            });
            return idx;
        }
        
        // 切换展开/折叠视图
        function toggleExpandedView(expand) {
            if (expand) {
                // 展开视图
                $('#swimLaneContainer').addClass('expanded');
                
                // 遍历所有泳道日期单元格
                $('.swim-lane').each(function() {
                    const lane = $(this);
                    const laneId = lane.data('lane-id');
                    
                    lane.find('.lane-day').each(function(dayIndex) {
                        const dayCell = $(this);
                        const dateString = $('#dateHeader .date-col').eq(dayIndex).attr('data-date');
                        if (!dateString) return;
                        
                        // 获取该日的"今天"内容
                        const todayNoteKey = `swimlaneToday-${laneId}-${dateString}`;
                        const todayNote = localStorage.getItem(todayNoteKey) || '';
                        
                        // 调整单元格样式
                        dayCell.css({
                            'height': 'auto',
                            'min-height': '70px',
                            'flex-direction': 'column',
                            'align-items': 'flex-start',
                            'justify-content': 'flex-start',
                            'padding': '10px'
                        });
                        
                        // 调整状态点样式
                        const stateDot = dayCell.find('.state-dot');
                        stateDot.css({
                            'width': '14px',
                            'height': '14px',
                            'margin-right': '5px',
                            'margin-bottom': '8px'
                        });
                        
                        // 添加内容文本
                        if (dayCell.find('.today-content').length === 0) {
                            dayCell.append(`
                                <div class="today-content" style="width: 100%; font-size: 0.85rem; white-space: pre-wrap; margin-top: 5px; overflow-y: auto; max-height: 150px;">${todayNote}</div>
                            `);
                        }
                    });
                });
                
                // 重新绘制连接线
                setTimeout(drawConnectionLines, 300);
            } else {
                // 折叠视图
                $('.swim-lane .lane-day').each(function() {
                    const dayCell = $(this);
                    // 恢复原有样式（使用新的紧凑高度）
                    dayCell.css({
                        'height': 'auto',
                        'min-height': '35px',
                        'flex-direction': 'row',
                        'align-items': 'center',
                        'justify-content': 'center',
                        'padding': '0'
                    });

                    // 移除内容文本
                    dayCell.find('.today-content').remove();

                    // 恢复状态点样式
                    const stateDot = dayCell.find('.state-dot');
                    stateDot.css({
                        'width': '20px',
                        'height': '20px',
                        'margin': '0'
                    });
                });

                // 移除展开类
                $('#swimLaneContainer').removeClass('expanded');

                // 重新绘制连接线
                setTimeout(drawConnectionLines, 300);
            }
        }
        
        // 展开/折叠泳道内容
        function showTodayContent() {
            // 判断当前是否已展开
            const isExpanded = $('#swimLaneContainer').hasClass('expanded');
            
            if (isExpanded) {
                // 如果已展开，则折叠
                $('.swim-lane .lane-day').each(function() {
                    const dayCell = $(this);
                    // 恢复原有样式
                    dayCell.css({
                        'height': '50px',
                        'flex-direction': 'row'
                    });
                    
                    // 移除内容文本
                    dayCell.find('.today-content').remove();
                    
                    // 恢复状态点样式
                    const stateDot = dayCell.find('.state-dot');
                    stateDot.css({
                        'width': '20px',
                        'height': '20px',
                        'margin': '0'
                    });
                });
                
                // 移除展开类
                $('#swimLaneContainer').removeClass('expanded');
            } else {
                // 如果未展开，则展开
                $('#swimLaneContainer').addClass('expanded');
                
                // 遍历所有泳道日期单元格
                $('.swim-lane').each(function() {
                    const lane = $(this);
                    const laneId = lane.data('lane-id');
                    
                    lane.find('.lane-day').each(function(dayIndex) {
                        const dayCell = $(this);
                        const dateString = $('#dateHeader .date-col').eq(dayIndex).attr('data-date');
                        if (!dateString) return;
                        
                        // 获取该日的"今天"内容
                        const todayNoteKey = `swimlaneToday-${laneId}-${dateString}`;
                        const todayNote = localStorage.getItem(todayNoteKey) || '';
                        
                        // 调整单元格样式
                        dayCell.css({
                            'height': 'auto',
                            'min-height': '70px',
                            'flex-direction': 'column',
                            'align-items': 'flex-start',
                            'justify-content': 'flex-start',
                            'padding': '10px'
                        });
                        
                        // 调整状态点样式
                        const stateDot = dayCell.find('.state-dot');
                        stateDot.css({
                            'width': '14px',
                            'height': '14px',
                            'margin-right': '5px',
                            'margin-bottom': '8px'
                        });
                        
                        // 添加内容文本
                        if (dayCell.find('.today-content').length === 0) {
                            dayCell.append(`
                                <div class="today-content" style="width: 100%; font-size: 0.85rem; white-space: pre-wrap; margin-top: 5px; overflow-y: auto; max-height: 150px;">${todayNote}</div>
                            `);
                        }
                    });
                });
            }
        }

        function updateDateHeader(baseDateStr) {
            const baseDate = new Date(baseDateStr + "T00:00:00Z"); // Use UTC for consistency
            const workingDays = [];

            // 生成向前推的工作日日期（跳过周六周日）
            let currentDate = new Date(baseDate.getTime());
            let daysToGenerate = $('#dateHeader .date-col').length; // 获取需要生成的日期数
            let daysAdded = 0;
            let offset = -4; // 从4天前开始

            while (daysAdded < daysToGenerate) {
                const tempDate = new Date(baseDate.getTime());
                tempDate.setUTCDate(baseDate.getUTCDate() + offset);

                // 获取星期几（0=周日，1=周一，...，6=周六）
                const dayOfWeek = tempDate.getUTCDay();

                // 只添加工作日（周一到周五）
                if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                    workingDays.push({
                        display: `${tempDate.getUTCMonth() + 1}月${tempDate.getUTCDate()}日`,
                        data: tempDate.toISOString().split('T')[0]
                    });
                    daysAdded++;
                }
                offset++;
            }

            // 更新DOM
            $('#dateHeader .date-col').each(function(index) {
                if (index < workingDays.length) {
                    $(this).text(workingDays[index].display);
                    $(this).attr('data-date', workingDays[index].data);
                }
            });
        }

        function ensureNoteIndicatorsAreCorrect() {
            $('.swim-lane').each(function() {
                const lane = $(this);
                const laneId = lane.data('lane-id');
                lane.find('.lane-day').each(function(dayIndex) {
                    const dayCell = $(this);
                    const dot = dayCell.find('.state-dot');
                    const dateString = $('#dateHeader .date-col').eq(dayIndex).attr('data-date');

                    if (laneId && dateString && dot.length) {
                        dot.find('.note-indicator').remove(); // Clear existing indicator first
                        
                        // 检查所有可能的笔记数据
                        const historyNote = localStorage.getItem(`swimlaneHistory-${laneId}-${dateString}`);
                        const todayNote = localStorage.getItem(`swimlaneToday-${laneId}-${dateString}`);
                        const tomorrowNote = localStorage.getItem(`swimlaneTomorrow-${laneId}-${dateString}`);
                        // 兼容旧版本数据
                        const legacyNote = localStorage.getItem(`swimlaneNote-${laneId}-${dateString}`);
                        
                        // 只要有任何一个笔记存在，就显示指示器
                        if ((historyNote && historyNote.trim() !== '') || 
                            (todayNote && todayNote.trim() !== '') || 
                            (tomorrowNote && tomorrowNote.trim() !== '') ||
                            (legacyNote && legacyNote.trim() !== '')) {
                            dot.append('<span class="note-indicator" style="position: absolute; top: -3px; right: -3px; width: 8px; height: 8px; background-color: var(--color-secondary, #f97316); border-radius: 50%; border: 1px solid white; z-index: 3;"></span>');
                        }
                    }
                });
            });
        }

        // 页面加载完成后初始化泳道颜色
        $(document).ready(function() {
            // 延迟执行，确保所有泳道都已加载完成
            setTimeout(function() {
                assignLaneBackgroundColors();
                console.log('泳道背景颜色初始化完成');
            }, 500);
        });
    });
    </script>
    
    <!-- 音效容器 -->
    <div class="audio-container">
        <audio id="springSound" preload="auto">
            <source src="https://tako-static-assets-production.s3.amazonaws.com/static/sounds/spring-birds.mp3" type="audio/mpeg">
        </audio>
        <audio id="summerSound" preload="auto">
            <source src="https://tako-static-assets-production.s3.amazonaws.com/static/sounds/summer-cicadas.mp3" type="audio/mpeg">
        </audio>
        <audio id="autumnSound" preload="auto">
            <source src="https://tako-static-assets-production.s3.amazonaws.com/static/sounds/autumn-wind.mp3" type="audio/mpeg">
        </audio>
        <audio id="winterSound" preload="auto">
            <source src="https://tako-static-assets-production.s3.amazonaws.com/static/sounds/winter-snow.mp3" type="audio/mpeg">
        </audio>
    </div>

    <!-- 添加全局键盘事件处理 -->
    <script>
        $(document).on('keydown', function(e) {
            // 检查是否是策略方法页面处于活动状态
            if ($('#section4').hasClass('active')) {
                // 如果按下的是回车键(keyCode 13)
                if (e.which === 13) {
                    // 获取当前活动元素
                    const activeElement = document.activeElement;
                    
                    // 如果当前元素不是输入框或文本区域，阻止默认行为
                    if (activeElement.tagName !== 'INPUT' && activeElement.tagName !== 'TEXTAREA' && activeElement.tagName !== 'SELECT') {
                        e.preventDefault();
                    }
                }
            }
        });
    </script>
    

            <!-- 汇总展示弹窗 -->
        <div id="historyContentModal" class="history-modal">
            <div class="history-content-modal">
                <div class="modal-header">
                    <h3 class="modal-title" id="historyModalTitle">汇总</h3>
                    <div class="header-right" style="display: flex; align-items: center; gap: 15px;">
                        <div class="date-display-container" style="position: relative;">
                            <span id="currentDateDisplay" class="date-display" style="font-weight: 600; font-size: 0.95rem; color: var(--color-primary); padding: 8px 12px; background-color: var(--color-gray-50); border-radius: 6px; border: 1px solid var(--color-gray-200); cursor: pointer; transition: all 0.2s ease; display: inline-block;">
                                <!-- 日期将在这里显示 -->
                            </span>
                            <div class="date-navigation-popup" style="position: absolute; top: 100%; left: 50%; transform: translateX(-50%); background: white; border: 1px solid var(--color-gray-200); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 12px; margin-top: 8px; display: none; z-index: 1000; min-width: 200px; pointer-events: auto;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                                    <button class="btn-nav-popup" onclick="navigateDate(-1)" style="background: var(--color-primary); color: white; border: none; border-radius: 4px; padding: 6px 10px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s ease;">
                                        <i class="fas fa-chevron-left" style="margin-right: 4px;"></i>前一天
                                    </button>
                                    <button class="btn-nav-popup" onclick="navigateDate(1)" style="background: var(--color-primary); color: white; border: none; border-radius: 4px; padding: 6px 10px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s ease;">
                                        后一天<i class="fas fa-chevron-right" style="margin-left: 4px;"></i>
                                    </button>
                                </div>
                                <div style="text-align: center;">
                                    <input type="date" id="datePickerInput" style="width: 100%; padding: 6px 8px; border: 1px solid var(--color-gray-300); border-radius: 4px; font-size: 0.85rem;">
                                    <button onclick="jumpToDate()" style="background: var(--color-secondary); color: white; border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer; font-size: 0.85rem; margin-top: 8px; width: 100%; transition: all 0.2s ease;">
                                        跳转到指定日期
                                    </button>
                                </div>
                            </div>
                        </div>
                        <button class="modal-close" onclick="closeHistoryContent()">&times;</button>
                    </div>
                </div>
                <div class="modal-body" id="historyContentBody">
                    <!-- 汇总内容将在这里动态生成 -->
                </div>
                <div class="modal-buttons">
                    <button class="btn-modal btn-modal-secondary" onclick="closeHistoryContent()">关闭</button>
                </div>
            </div>
        </div>

    <!-- Supabase 集成脚本 -->
    <script>
        // 初始化 Supabase 客户端
        const SUPABASE_URL = 'https://wmwcnnjvdbicxiculumk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indtd2Nubmp2ZGJpY3hpY3VsdW1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMzI4NDMsImV4cCI6MjA3MjYwODg0M30.uoQiSQbZwRdjZ3OOBysyaFeDn0qn31eR3ZM_PtmrHPg';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // 获取当前用户
        async function getCurrentUser() {
            try {
                const { data: { user }, error } = await supabaseClient.auth.getUser();
                if (error) throw error;
                return user;
            } catch (error) {
                console.error('获取用户信息失败:', error);
                return null;
            }
        }

        // 收集表单数据
        function collectFormData() {
            const formData = {
                // Section 1: 市场多空
                macro_risk_free: $('input[name="macroRiskFree"]').is(':checked'),
                non_breaking_index: $('input[name="nonBreakingIndex"]').is(':checked'),
                market_direction: $('.market-choice-btn.selected').text().trim() || null,
                
                // Section 2: 情绪阶段
                emotion_stage: $('.mood-choice-btn.selected').text().trim() || null,
                volume_amplified: $('#volumeAmplified').is(':checked'),
                index_turning_point: $('#indexTurningPoint').is(':checked'),
                
                // Section 3: 板块节奏
                sector_option1: $('input[name="sectorOption1"]').val() || null,
                sector_option2: $('input[name="sectorOption2"]').val() || null,
                sector_option3: $('input[name="sectorOption3"]').val() || null,
                sector_option4: $('input[name="sectorOption4"]').val() || null,
                sector_option5: $('input[name="sectorOption5"]').val() || null,
                rising_theme1: $('input[name="risingTheme1"]').val() || null,
                rising_theme2: $('input[name="risingTheme2"]').val() || null,
                
                // 泳道数据
                swim_lane_data: collectSwimLaneData(),
                
                // Section 4: 策略方法
                personal_strategy: $('textarea[name="personalStrategy"]').val() || null,
                
                // Section 5: 执行计划
                stock_position: $('textarea[name="stockPosition"]').val() || null,
                funding_support: $('textarea[name="fundingSupport"]').val() || null,
                expectation: $('textarea[name="expectation"]').val() || null,
                stock_selection: $('textarea[name="stockSelection"]').val() || null,
                focus_stocks: $('textarea[name="focusStocks"]').val() || null,
                buy_plan: $('textarea[name="buyPlan"]').val() || null,
                sell_plan: $('textarea[name="sellPlan"]').val() || null,
                risk_control: $('textarea[name="riskControl"]').val() || null,
                mental_adjustment: $('textarea[name="mentalAdjustment"]').val() || null,
                
                // Section 6: 交易记录
                trading_reflection: $('textarea[name="tradingReflection"]').val() || null
            };
            
            return formData;
        }

        // 收集泳道数据
        function collectSwimLaneData() {
            try {
                if (typeof window.lanes !== 'undefined' && window.lanes.length > 0) {
                    return {
                        lanes: window.lanes,
                        dates: window.dates || []
                    };
                }
            } catch (error) {
                console.error('收集泳道数据失败:', error);
            }
            return null;
        }

        // 收集交易记录
        function collectTradingRecords() {
            const records = [];
            $('input[name="stock[]"]').each(function(index) {
                const stockName = $(this).val();
                const buyPrice = $('input[name="buyPrice[]"]').eq(index).val();
                const sellPrice = $('input[name="sellPrice[]"]').eq(index).val();
                const profit = $('input[name="profit[]"]').eq(index).val();
                
                if (stockName || buyPrice || sellPrice || profit) {
                    records.push({
                        stock_name: stockName || null,
                        buy_price: buyPrice ? parseFloat(buyPrice) : null,
                        sell_price: sellPrice ? parseFloat(sellPrice) : null,
                        profit_percent: profit ? parseFloat(profit) : null
                    });
                }
            });
            return records;
        }

        // 保存复盘数据
        async function saveReviewData() {
            try {
                // 获取当前用户
                const user = await getCurrentUser();
                if (!user) {
                    showCustomModal('提示', '请先登录后再保存复盘数据');
                    return false;
                }

                // 收集表单数据
                const formData = collectFormData();
                formData.user_id = user.id;

                // 使用日期选择器中的日期，如果没有选择则使用今天
                const selectedDate = $('#reviewDate').val();
                formData.review_date = selectedDate || new Date().toISOString().split('T')[0];

                console.log(`💾 正在保存复盘数据到日期: ${formData.review_date}`);

                // 检查是否已存在该日期的复盘记录
                const { data: existingRecord, error: checkError } = await supabaseClient
                    .from('review_records')
                    .select('id')
                    .eq('user_id', user.id)
                    .eq('review_date', formData.review_date)
                    .maybeSingle();

                if (checkError && checkError.code !== 'PGRST116') {
                    throw checkError;
                }

                let reviewId;

                if (existingRecord) {
                    // 更新现有记录
                    const { data, error } = await supabaseClient
                        .from('review_records')
                        .update(formData)
                        .eq('id', existingRecord.id)
                        .select()
                        .single();

                    if (error) throw error;
                    reviewId = data.id;
                    
                    // 删除旧的交易记录
                    await supabaseClient
                        .from('trading_records')
                        .delete()
                        .eq('review_id', reviewId);
                } else {
                    // 插入新记录
                    const { data, error } = await supabaseClient
                        .from('review_records')
                        .insert([formData])
                        .select()
                        .single();

                    if (error) throw error;
                    reviewId = data.id;
                }

                // 保存交易记录
                const tradingRecords = collectTradingRecords();
                if (tradingRecords.length > 0) {
                    const recordsWithReviewId = tradingRecords.map(record => ({
                        ...record,
                        review_id: reviewId
                    }));

                    const { error: tradingError } = await supabaseClient
                        .from('trading_records')
                        .insert(recordsWithReviewId);

                    if (tradingError) throw tradingError;
                }

                showCustomModal('成功', '复盘数据已保存成功！');
                return true;
            } catch (error) {
                console.error('保存复盘数据失败:', error);
                showCustomModal('错误', '保存失败: ' + error.message);
                return false;
            }
        }

        // 加载复盘数据
        async function loadReviewData(reviewDate = null) {
            try {
                // 获取当前用户
                const user = await getCurrentUser();
                if (!user) {
                    console.log('用户未登录，跳过数据加载');
                    return null;
                }

                // 如果没有指定日期，使用今天的日期
                const targetDate = reviewDate || new Date().toISOString().split('T')[0];

                console.log(`📥 正在加载 ${targetDate} 的复盘数据...`);

                // 从数据库加载复盘记录
                const { data: reviewRecord, error: reviewError } = await supabaseClient
                    .from('review_records')
                    .select('*')
                    .eq('user_id', user.id)
                    .eq('review_date', targetDate)
                    .maybeSingle();

                if (reviewError && reviewError.code !== 'PGRST116') {
                    throw reviewError;
                }

                if (!reviewRecord) {
                    console.log('未找到该日期的复盘记录');
                    return null;
                }

                // 加载交易记录
                const { data: tradingRecords, error: tradingError } = await supabaseClient
                    .from('trading_records')
                    .select('*')
                    .eq('review_id', reviewRecord.id);

                if (tradingError) {
                    console.error('加载交易记录失败:', tradingError);
                }

                console.log('✅ 数据加载成功:', reviewRecord);

                return {
                    review: reviewRecord,
                    trading: tradingRecords || []
                };
            } catch (error) {
                console.error('加载复盘数据失败:', error);
                showCustomModal('错误', '加载数据失败: ' + error.message);
                return null;
            }
        }

        // 将数据填充到表单中
        function fillFormData(data, showSuccessMessage = true) {
            if (!data || !data.review) {
                console.log('没有数据需要填充');
                return;
            }

            const review = data.review;
            console.log('📝 正在填充表单数据...');

            try {
                // Section 1: 市场多空
                if (review.macro_risk_free !== null) {
                    $('input[name="macroRiskFree"]').prop('checked', review.macro_risk_free);
                }
                if (review.non_breaking_index !== null) {
                    $('input[name="nonBreakingIndex"]').prop('checked', review.non_breaking_index);
                }
                if (review.market_direction) {
                    $('.market-choice-btn').removeClass('selected');
                    $('.market-choice-btn').filter(function() {
                        return $(this).text().trim() === review.market_direction;
                    }).addClass('selected');
                }

                // Section 2: 情绪阶段
                if (review.emotion_stage) {
                    $('.mood-choice-btn').removeClass('selected');
                    $('.mood-choice-btn').filter(function() {
                        return $(this).text().trim() === review.emotion_stage;
                    }).addClass('selected');
                }
                if (review.volume_amplified !== null) {
                    $('#volumeAmplified').prop('checked', review.volume_amplified);
                }
                if (review.index_turning_point !== null) {
                    $('#indexTurningPoint').prop('checked', review.index_turning_point);
                }

                // Section 3: 板块节奏
                if (review.sector_option1) $('input[name="sectorOption1"]').val(review.sector_option1);
                if (review.sector_option2) $('input[name="sectorOption2"]').val(review.sector_option2);
                if (review.sector_option3) $('input[name="sectorOption3"]').val(review.sector_option3);
                if (review.sector_option4) $('input[name="sectorOption4"]').val(review.sector_option4);
                if (review.sector_option5) $('input[name="sectorOption5"]').val(review.sector_option5);
                if (review.rising_theme1) $('input[name="risingTheme1"]').val(review.rising_theme1);
                if (review.rising_theme2) $('input[name="risingTheme2"]').val(review.rising_theme2);

                // 恢复泳道数据
                if (review.swim_lane_data) {
                    restoreSwimLaneData(review.swim_lane_data);
                }

                // Section 4: 策略方法
                if (review.personal_strategy) {
                    $('textarea[name="personalStrategy"]').val(review.personal_strategy);
                }

                // Section 5: 执行计划
                if (review.stock_position) $('textarea[name="stockPosition"]').val(review.stock_position);
                if (review.funding_support) $('textarea[name="fundingSupport"]').val(review.funding_support);
                if (review.expectation) $('textarea[name="expectation"]').val(review.expectation);
                if (review.stock_selection) $('textarea[name="stockSelection"]').val(review.stock_selection);
                if (review.focus_stocks) $('textarea[name="focusStocks"]').val(review.focus_stocks);
                if (review.buy_plan) $('textarea[name="buyPlan"]').val(review.buy_plan);
                if (review.sell_plan) $('textarea[name="sellPlan"]').val(review.sell_plan);
                if (review.risk_control) $('textarea[name="riskControl"]').val(review.risk_control);
                if (review.mental_adjustment) $('textarea[name="mentalAdjustment"]').val(review.mental_adjustment);

                // Section 6: 交易记录
                if (review.trading_reflection) {
                    $('textarea[name="tradingReflection"]').val(review.trading_reflection);
                }

                // 填充交易记录表格
                if (data.trading && data.trading.length > 0) {
                    fillTradingRecords(data.trading);
                }

                console.log('✅ 表单数据填充完成');
                if (showSuccessMessage) {
                    showCustomModal('成功', '已加载您的复盘数据');
                }
            } catch (error) {
                console.error('填充表单数据失败:', error);
                showCustomModal('错误', '填充数据失败: ' + error.message);
            }
        }

        // 恢复泳道数据
        function restoreSwimLaneData(swimLaneData) {
            try {
                if (swimLaneData && swimLaneData.lanes) {
                    window.lanes = swimLaneData.lanes;
                    window.dates = swimLaneData.dates || [];

                    // 重新渲染泳道图（如果有渲染函数的话）
                    if (typeof renderSwimLanes === 'function') {
                        renderSwimLanes();
                    }

                    console.log('✅ 泳道数据已恢复');
                }
            } catch (error) {
                console.error('恢复泳道数据失败:', error);
            }
        }

        // 填充交易记录
        function fillTradingRecords(tradingRecords) {
            try {
                // 清空现有的交易记录行（保留第一行作为模板）
                const firstRow = $('input[name="stock[]"]').first().closest('tr');
                if (firstRow.length > 0) {
                    firstRow.siblings().remove();

                    tradingRecords.forEach((record, index) => {
                        if (index === 0) {
                            // 填充第一行
                            $('input[name="stock[]"]').first().val(record.stock_name || '');
                            $('input[name="buyPrice[]"]').first().val(record.buy_price || '');
                            $('input[name="sellPrice[]"]').first().val(record.sell_price || '');
                            $('input[name="profit[]"]').first().val(record.profit_percent || '');
                        } else {
                            // 克隆并添加新行
                            const newRow = firstRow.clone();
                            newRow.find('input[name="stock[]"]').val(record.stock_name || '');
                            newRow.find('input[name="buyPrice[]"]').val(record.buy_price || '');
                            newRow.find('input[name="sellPrice[]"]').val(record.sell_price || '');
                            newRow.find('input[name="profit[]"]').val(record.profit_percent || '');
                            firstRow.parent().append(newRow);
                        }
                    });

                    console.log(`✅ 已填充 ${tradingRecords.length} 条交易记录`);
                }
            } catch (error) {
                console.error('填充交易记录失败:', error);
            }
        }

        // 在页面中添加保存按钮（如果还没有的话）
        $(document).ready(async function() {
            // 页面加载时自动获取盘面回顾数据
            console.log('📊 页面加载，开始获取盘面回顾数据...');
            loadBasicMarketData();

            // 自动加载用户的复盘数据
            console.log('📥 正在加载用户的复盘数据...');
            const savedData = await loadReviewData();
            if (savedData) {
                // 首次加载时不显示成功提示
                fillFormData(savedData, false);
                console.log('✅ 已静默加载今日复盘数据');
            } else {
                console.log('ℹ️ 今日暂无复盘记录，您可以开始新的复盘');
            }

            // 在表单底部添加保存按钮
            if ($('#saveReviewBtn').length === 0) {
                const saveBtn = $('<button>')
                    .attr({
                        'id': 'saveReviewBtn',
                        'type': 'button',
                        'class': 'btn btn-primary'
                    })
                    .css({
                        'position': 'fixed',
                        'bottom': '20px',
                        'right': '20px',
                        'z-index': '1000',
                        'padding': '12px 24px',
                        'font-size': '16px',
                        'box-shadow': '0 4px 12px rgba(0, 0, 0, 0.15)'
                    })
                    .html('<i class="fas fa-save mr-2"></i>保存复盘数据')
                    .click(saveReviewData);
                
                $('body').append(saveBtn);
            }

            // 监听日期选择器的变化，加载对应日期的复盘数据
            $('#reviewDate').on('change', async function() {
                const selectedDate = $(this).val();
                if (selectedDate) {
                    console.log(`📅 用户选择了日期: ${selectedDate}`);
                    const data = await loadReviewData(selectedDate);
                    if (data) {
                        fillFormData(data);
                    } else {
                        showCustomModal('提示', `未找到 ${selectedDate} 的复盘记录，您可以开始填写新的复盘。`);
                    }
                }
            });

            // 定期自动保存（每5分钟）
            setInterval(async function() {
                const user = await getCurrentUser();
                if (user) {
                    console.log('自动保存复盘数据...');
                    await saveReviewData();
                }
            }, 5 * 60 * 1000);
        });
    </script>
</body>
</html>